<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WBS Presupuestal COMPLETA Interactiva v3.0 - APP La Dorada-Chiriguan√°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .filtros {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .filtro-btn {
            padding: 8px 16px;
            border: 2px solid #dee2e6;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .filtro-btn:hover {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        
        .filtro-btn.activo {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }
        
        .item-card {
            margin: 20px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            overflow: hidden;
            background: white;
            transition: all 0.3s;
        }
        
        .item-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        .item-header {
            padding: 15px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .item-codigo {
            font-weight: bold;
            font-size: 18px;
        }
        
        .item-modificable {
            background: #28a745;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
        }
        
        .item-no-modificable {
            background: #6c757d;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
        }
        
        .item-body {
            padding: 20px;
        }
        
        .item-descripcion {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        .item-valores {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        
        .valor-box {
            text-align: center;
        }
        
        .valor-label {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 5px;
        }
        
        .valor-dato {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .seccion {
            margin-top: 20px;
            padding: 15px;
            background: #f1f3f5;
            border-left: 4px solid #007bff;
            border-radius: 4px;
        }
        
        .seccion-titulo {
            font-weight: bold;
            color: #007bff;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .seccion-contenido {
            color: #495057;
            line-height: 1.6;
        }
        
        .seccion-contenido ul {
            list-style-position: inside;
            margin-top: 8px;
        }
        
        .riesgo-badge {
            display: inline-block;
            background: #dc3545;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-right: 5px;
        }
        
        .riesgo-item {
            background: white;
            padding: 12px;
            margin: 8px 0;
            border-radius: 6px;
            border-left: 4px solid #dc3545;
        }
        
        .riesgo-id {
            font-weight: bold;
            color: #dc3545;
        }
        
        .botones-accion {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-ajustar {
            background: #28a745;
            color: white;
        }
        
        .btn-ajustar:hover {
            background: #218838;
        }
        
        .btn-precio {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-precio:hover {
            background: #e0a800;
        }
        
        .btn-desglose {
            background: #17a2b8;
            color: white;
        }
        
        .btn-desglose:hover {
            background: #138496;
        }
        
        .btn-dt {
            background: #6610f2;
            color: white;
        }
        
        .btn-dt:hover {
            background: #520dc2;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 0;
            border: none;
            width: 90%;
            max-width: 900px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px 12px 0 0;
        }
        
        .close {
            color: white;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: #f8f9fa;
        }
        
        .modal-body {
            padding: 30px;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }
        
        .form-control {
            width: 100%;
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #007bff;
        }
        
        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }
        
        .nivel-1 { margin-left: 0; }
        .nivel-2 { margin-left: 20px; }
        .nivel-3 { margin-left: 40px; }
        
        .stats-bar {
            background: #f8f9fa;
            padding: 15px 20px;
            display: flex;
            justify-content: space-around;
            border-bottom: 2px solid #dee2e6;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        
        .stat-label {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }
        
        .sugerencia-box {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 6px;
            padding: 12px;
            margin-top: 10px;
        }
        
        .sugerencia-titulo {
            font-weight: bold;
            color: #856404;
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä WBS PRESUPUESTAL COMPLETA INTERACTIVA v3.0</h1>
            <p>APP La Dorada-Chiriguan√° | Todos los √≠tems con Criterios T√©cnicos y Gesti√≥n de Cambios</p>
        </div>

        <div class="stats-bar">
            <div class="stat-item">
                <div class="stat-value" id="total-items">0</div>
                <div class="stat-label">√çTEMS TOTALES</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="total-modificables">0</div>
                <div class="stat-label">MODIFICABLES</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="total-riesgos">0</div>
                <div class="stat-label">RIESGOS ASOCIADOS</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="total-presupuesto">$0</div>
                <div class="stat-label">PRESUPUESTO TOTAL</div>
            </div>
        </div>

        <div class="filtros">
            <button class="filtro-btn activo" onclick="filtrarItems('todos')">üìã Todos</button>
            <button class="filtro-btn" onclick="filtrarItems('modificables')">‚úÖ Modificables</button>
            <button class="filtro-btn" onclick="filtrarItems('no-modificables')">üîí No Modificables</button>
            <button class="filtro-btn" onclick="filtrarItems('con-riesgos')">‚ö†Ô∏è Con Riesgos</button>
            <button class="filtro-btn" onclick="filtrarItems('fibra')">üåê Fibra √ìptica</button>
            <button class="filtro-btn" onclick="filtrarItems('tetra')">üì° TETRA</button>
            <button class="filtro-btn" onclick="filtrarItems('gsm')">üì± GSM-R</button>
        </div>

        <div id="wbs-container">
            <!-- Los √≠tems se cargan aqu√≠ din√°micamente -->
        </div>
    </div>

    <!-- Modal Universal de Ajuste -->
    <div id="modalAjuste" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="cerrarModal()">&times;</span>
                <h2 id="modal-titulo">Ajustar √çtem</h2>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Contenido din√°mico -->
            </div>
        </div>
    </div>

    <script>
        // BASE DE DATOS WBS (Integrada directamente)
        const wbsData = {
            items: [
                {
                    codigo: "1.1.1",
                    nivel: 3,
                    descripcion: "Cable FO LPOC03120484ZC - 48 fibras G.652D",
                    unidad: "km",
                    cantidad: 594,
                    vu_cop: 9811013,
                    total_cop: 5827741722,
                    tipo: "SUMINISTRO",
                    modificable: false,
                    categoria: "fibra",
                    criterio_tecnico: {
                        justificacion: "Longitud corredor La Dorada-Chiriguan√° seg√∫n AT1",
                        fuente: "AT1 - Alcance del Proyecto, Secci√≥n 2.1",
                        normas: ["UIT-T G.652.D"],
                        calculo: "594 km corredor + 0% reserva (valor contractual)",
                        restriccion: "No modificable - Obligaci√≥n contractual AT1"
                    },
                    riesgos_asociados: [
                        {
                            id: "R-FIBRA-001",
                            descripcion: "Longitud insuficiente si hay cambios de ruta",
                            probabilidad: "Baja",
                            impacto: "Alto"
                        }
                    ],
                    archivos_relacionados: [
                        "III/28_Sistema_FibraOptica_Integrado.md (Secci√≥n 2.1)",
                        "V.3_Sistemas_Comunicacion_Detalle.md (Tabla 5.1)"
                    ]
                },
                {
                    codigo: "1.1.2",
                    nivel: 3,
                    descripcion: "Empalmes y conectores",
                    unidad: "GL",
                    cantidad: 1,
                    vu_cop: 150000000,
                    total_cop: 150000000,
                    tipo: "SUMINISTRO",
                    modificable: true,
                    categoria: "fibra",
                    criterio_tecnico: {
                        justificacion: "Global estimado para conectores, splitters y empalmes de campo",
                        fuente: "Estimaci√≥n t√©cnica basada en 594 km",
                        normas: ["UIT-T L.50"],
                        calculo: "Estimaci√≥n: $150M para ~6,000 fusiones de campo + conectores + splitters",
                        desglose: [
                            "Conectores SC/APC: ~500 unidades √ó $50,000 = $25M",
                            "Splitters 1:8: ~100 unidades √ó $200,000 = $20M",
                            "Empalmes campo: ~6,000 √ó $15,000 = $90M",
                            "Accesorios varios: $15M"
                        ],
                        restriccion: "Modificable si se ajusta desglose"
                    },
                    riesgos_asociados: [
                        {
                            id: "R-FIBRA-010",
                            descripcion: "Estimaci√≥n global puede ser insuficiente si aumentan fusiones de campo",
                            probabilidad: "Media",
                            impacto: "Medio"
                        },
                        {
                            id: "R-FIBRA-011",
                            descripcion: "Falta detalle t√©cnico puede generar confusi√≥n en compras",
                            probabilidad: "Alta",
                            impacto: "Medio"
                        }
                    ],
                    archivos_relacionados: [
                        "V.3_Sistemas_Comunicacion_Detalle.md (Secci√≥n 5.4)",
                        "IV/37_Memorias_Diseno_Basico.md (Anexo C)"
                    ],
                    sugerencias_mejora: [
                        "Desglosar en √≠tems espec√≠ficos (conectores, splitters, empalmes)",
                        "Validar cantidad con dise√±o detallado de fusiones",
                        "Agregar reserva 10% para imprevistos"
                    ]
                },
                {
                    codigo: "1.1.3",
                    nivel: 3,
                    descripcion: "Cajas de empalme y distribuci√≥n 80x80",
                    unidad: "UND",
                    cantidad: 2068,
                    vu_cop: 1350000,
                    total_cop: 2791800000,
                    tipo: "SUMINISTRO",
                    modificable: true,
                    categoria: "fibra",
                    criterio_tecnico: {
                        justificacion: "Espaciamiento 300m seg√∫n UIT-T + 88 nodos cr√≠ticos",
                        fuente: "UIT-T G.652.D + Dise√±o OSP",
                        normas: ["UIT-T G.652.D (m√°x 500m)"],
                        calculo: "594,000m √∑ 300m = 1,980 base + 88 nodos cr√≠ticos = 2,068 total",
                        desglose: [
                            "Cajas backbone: 1,980 unidades (cada 300m)",
                            "Cajas en estaciones: 37 unidades (Torres TETRA/GSM-R)",
                            "Cajas en subestaciones: 15 unidades",
                            "Cajas en cruces cr√≠ticos: 36 unidades"
                        ],
                        restriccion: "Modificable si espaciamiento cambia (l√≠mite UIT-T: 500m)"
                    },
                    riesgos_asociados: [
                        {
                            id: "R-FIBRA-003",
                            descripcion: "Espaciamiento muy corto aumenta CAPEX",
                            probabilidad: "Alta",
                            impacto: "Alto"
                        },
                        {
                            id: "R-FIBRA-006",
                            descripcion: "Si se reduce espaciamiento, aumenta tiempo localizaci√≥n fallas",
                            probabilidad: "Baja",
                            impacto: "Medio"
                        }
                    ],
                    items_dependientes: ["1.1.5", "1.1.10", "1.1.13"],
                    archivos_relacionados: [
                        "V.3_Sistemas_Comunicacion_Detalle.md (Tabla 5.3)",
                        "III/28_Sistema_FibraOptica_Integrado.md (Secci√≥n 2.2)"
                    ]
                }
            ]
        };

        // CARGAR WBS
        function cargarWBS() {
            const container = document.getElementById('wbs-container');
            container.innerHTML = '';
            
            let totalModificables = 0;
            let totalRiesgos = 0;
            let totalPresupuesto = 0;
            
            wbsData.items.forEach(item => {
                const card = crearCardItem(item);
                container.appendChild(card);
                
                if (item.modificable) totalModificables++;
                totalRiesgos += item.riesgos_asociados?.length || 0;
                totalPresupuesto += item.total_cop || 0;
            });
            
            // Actualizar stats
            document.getElementById('total-items').textContent = wbsData.items.length;
            document.getElementById('total-modificables').textContent = totalModificables;
            document.getElementById('total-riesgos').textContent = totalRiesgos;
            document.getElementById('total-presupuesto').textContent = formatearPeso(totalPresupuesto);
        }

        function crearCardItem(item) {
            const card = document.createElement('div');
            card.className = `item-card nivel-${item.nivel}`;
            card.dataset.modificable = item.modificable;
            card.dataset.categoria = item.categoria;
            card.dataset.tieneRiesgos = (item.riesgos_asociados?.length || 0) > 0;
            
            const criterio = item.criterio_tecnico || {};
            const riesgos = item.riesgos_asociados || [];
            const sugerencias = item.sugerencias_mejora || [];
            
            card.innerHTML = `
                <div class="item-header">
                    <div>
                        <span class="item-codigo">${item.codigo}</span>
                    </div>
                    <div>
                        ${item.modificable 
                            ? '<span class="item-modificable">‚úÖ MODIFICABLE</span>' 
                            : '<span class="item-no-modificable">üîí NO MODIFICABLE</span>'}
                    </div>
                </div>
                
                <div class="item-body">
                    <div class="item-descripcion">${item.descripcion}</div>
                    
                    <div class="item-valores">
                        <div class="valor-box">
                            <div class="valor-label">Unidad</div>
                            <div class="valor-dato">${item.unidad}</div>
                        </div>
                        <div class="valor-box">
                            <div class="valor-label">Cantidad</div>
                            <div class="valor-dato">${formatearNumero(item.cantidad)}</div>
                        </div>
                        <div class="valor-box">
                            <div class="valor-label">V/U (COP)</div>
                            <div class="valor-dato">${formatearPeso(item.vu_cop)}</div>
                        </div>
                        <div class="valor-box">
                            <div class="valor-label">Total (COP)</div>
                            <div class="valor-dato">${formatearPeso(item.total_cop)}</div>
                        </div>
                        <div class="valor-box">
                            <div class="valor-label">Tipo</div>
                            <div class="valor-dato">${item.tipo}</div>
                        </div>
                    </div>
                    
                    ${criterio.justificacion ? `
                        <div class="seccion">
                            <div class="seccion-titulo">üéØ CRITERIO T√âCNICO</div>
                            <div class="seccion-contenido">
                                <strong>Justificaci√≥n:</strong> ${criterio.justificacion}<br>
                                <strong>Fuente:</strong> ${criterio.fuente}<br>
                                ${criterio.normas ? `<strong>Normas:</strong> ${criterio.normas.join(', ')}<br>` : ''}
                                <strong>C√°lculo:</strong> ${criterio.calculo}<br>
                                ${criterio.desglose ? `
                                    <strong>Desglose:</strong>
                                    <ul>
                                        ${criterio.desglose.map(d => `<li>${d}</li>`).join('')}
                                    </ul>
                                ` : ''}
                                ${criterio.restriccion ? `<strong>‚ö†Ô∏è Restricci√≥n:</strong> ${criterio.restriccion}` : ''}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${riesgos.length > 0 ? `
                        <div class="seccion">
                            <div class="seccion-titulo">
                                ‚ö†Ô∏è RIESGOS ASOCIADOS
                                <span class="riesgo-badge">${riesgos.length}</span>
                            </div>
                            <div class="seccion-contenido">
                                ${riesgos.map(r => `
                                    <div class="riesgo-item">
                                        <span class="riesgo-id">${r.id}</span>: ${r.descripcion}<br>
                                        <small>Probabilidad: ${r.probabilidad} | Impacto: ${r.impacto}</small>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${sugerencias.length > 0 ? `
                        <div class="sugerencia-box">
                            <div class="sugerencia-titulo">üí° SUGERENCIAS DE MEJORA</div>
                            <ul>
                                ${sugerencias.map(s => `<li>${s}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    
                    ${item.modificable ? `
                        <div class="botones-accion">
                            <button class="btn btn-ajustar" onclick='abrirModalAjuste(${JSON.stringify(item)})'>
                                üìù Ajustar Cantidad
                            </button>
                            <button class="btn btn-precio" onclick='abrirModalPrecio(${JSON.stringify(item)})'>
                                üí∞ Ajustar Precio
                            </button>
                            ${criterio.desglose ? `
                                <button class="btn btn-desglose" onclick='abrirModalDesglose(${JSON.stringify(item)})'>
                                    üìä Proponer Desglose
                                </button>
                            ` : ''}
                            <button class="btn btn-dt" onclick='abrirModalDT(${JSON.stringify(item)})'>
                                üìã Crear Decisi√≥n T√©cnica
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;
            
            return card;
        }

        function formatearPeso(valor) {
            if (!valor) return '$0';
            return '$' + valor.toLocaleString('es-CO');
        }

        function formatearNumero(valor) {
            if (!valor) return '0';
            return valor.toLocaleString('es-CO');
        }

        function filtrarItems(filtro) {
            const cards = document.querySelectorAll('.item-card');
            const botones = document.querySelectorAll('.filtro-btn');
            
            // Actualizar botones
            botones.forEach(btn => btn.classList.remove('activo'));
            event.target.classList.add('activo');
            
            cards.forEach(card => {
                let mostrar = true;
                
                switch(filtro) {
                    case 'todos':
                        mostrar = true;
                        break;
                    case 'modificables':
                        mostrar = card.dataset.modificable === 'true';
                        break;
                    case 'no-modificables':
                        mostrar = card.dataset.modificable === 'false';
                        break;
                    case 'con-riesgos':
                        mostrar = card.dataset.tieneRiesgos === 'true';
                        break;
                    case 'fibra':
                        mostrar = card.dataset.categoria === 'fibra';
                        break;
                    case 'tetra':
                        mostrar = card.dataset.categoria === 'tetra';
                        break;
                    case 'gsm':
                        mostrar = card.dataset.categoria === 'gsm';
                        break;
                }
                
                card.style.display = mostrar ? 'block' : 'none';
            });
        }

        function abrirModalAjuste(item) {
            const modal = document.getElementById('modalAjuste');
            const titulo = document.getElementById('modal-titulo');
            const body = document.getElementById('modal-body');
            
            titulo.textContent = `Ajustar Cantidad: ${item.codigo} - ${item.descripcion}`;
            
            body.innerHTML = `
                <div class="form-group">
                    <label class="form-label">Cantidad Actual: ${formatearNumero(item.cantidad)} ${item.unidad}</label>
                    <input type="number" id="nueva-cantidad" class="form-control" value="${item.cantidad}" placeholder="Nueva cantidad">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Justificaci√≥n del Cambio:</label>
                    <textarea id="justificacion-cambio" class="form-control" placeholder="Explica por qu√© propones este cambio..."></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">An√°lisis de Impacto:</label>
                    <div id="analisis-impacto" style="background: #f8f9fa; padding: 15px; border-radius: 6px;">
                        <em>Ingresa nueva cantidad y justificaci√≥n para ver el an√°lisis...</em>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-ajustar" onclick="analizarCambio('${item.codigo}')">üîç Analizar Impacto</button>
                    <button class="btn btn-dt" onclick="generarDT('${item.codigo}')">üìã Generar DT</button>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        function abrirModalPrecio(item) {
            const modal = document.getElementById('modalAjuste');
            const titulo = document.getElementById('modal-titulo');
            const body = document.getElementById('modal-body');
            
            titulo.textContent = `Ajustar Precio: ${item.codigo} - ${item.descripcion}`;
            
            body.innerHTML = `
                <div class="form-group">
                    <label class="form-label">Precio Unitario Actual: ${formatearPeso(item.vu_cop)} COP</label>
                    <input type="number" id="nuevo-precio" class="form-control" value="${item.vu_cop}" placeholder="Nuevo precio unitario">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Justificaci√≥n del Cambio:</label>
                    <textarea id="justificacion-precio" class="form-control" placeholder="Explica por qu√© propones este cambio de precio..."></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Nuevo Total Estimado:</label>
                    <div id="nuevo-total" style="font-size: 24px; font-weight: bold; color: #007bff;">
                        ${formatearPeso(item.total_cop)}
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-ajustar" onclick="calcularNuevoTotal('${item.codigo}', ${item.cantidad})">üí∞ Calcular Total</button>
                    <button class="btn btn-dt" onclick="generarDTPrecio('${item.codigo}')">üìã Generar DT</button>
                </div>
            `;
            
            modal.style.display = 'block';
            
            // Listener para actualizar total en tiempo real
            document.getElementById('nuevo-precio').addEventListener('input', function() {
                const nuevoPrecio = parseFloat(this.value) || 0;
                const nuevoTotal = nuevoPrecio * item.cantidad;
                document.getElementById('nuevo-total').textContent = formatearPeso(nuevoTotal);
            });
        }

        function abrirModalDesglose(item) {
            const modal = document.getElementById('modalAjuste');
            const titulo = document.getElementById('modal-titulo');
            const body = document.getElementById('modal-body');
            
            titulo.textContent = `Proponer Desglose: ${item.codigo} - ${item.descripcion}`;
            
            body.innerHTML = `
                <p><strong>Desglose Actual (Estimado):</strong></p>
                <ul>
                    ${item.criterio_tecnico.desglose.map(d => `<li>${d}</li>`).join('')}
                </ul>
                
                <div class="form-group">
                    <label class="form-label">Propuesta de √çtems Espec√≠ficos:</label>
                    <textarea id="desglose-propuesto" class="form-control" rows="8" placeholder="Ejemplo:&#10;1.1.2.1 - Conectores SC/APC x 500 @ $50,000 = $25,000,000&#10;1.1.2.2 - Splitters 1:8 x 100 @ $200,000 = $20,000,000&#10;..."></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Justificaci√≥n:</label>
                    <textarea id="justificacion-desglose" class="form-control" placeholder="Por qu√© es necesario este desglose..."></textarea>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-desglose" onclick="validarDesglose()">‚úÖ Validar Desglose</button>
                    <button class="btn btn-dt" onclick="generarDTDesglose('${item.codigo}')">üìã Generar DT</button>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        function abrirModalDT(item) {
            const modal = document.getElementById('modalAjuste');
            const titulo = document.getElementById('modal-titulo');
            const body = document.getElementById('modal-body');
            
            titulo.textContent = `Crear Decisi√≥n T√©cnica: ${item.codigo}`;
            
            body.innerHTML = `
                <div class="form-group">
                    <label class="form-label">Tipo de Cambio:</label>
                    <select id="tipo-cambio" class="form-control">
                        <option value="cantidad">Ajuste de Cantidad</option>
                        <option value="precio">Ajuste de Precio</option>
                        <option value="desglose">Propuesta de Desglose</option>
                        <option value="eliminacion">Eliminaci√≥n de √çtem</option>
                        <option value="otro">Otro</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Observaci√≥n T√©cnica:</label>
                    <textarea id="observacion-dt" class="form-control" rows="6" placeholder="Describe tu observaci√≥n t√©cnica detallada..."></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Justificaci√≥n:</label>
                    <textarea id="justificacion-dt" class="form-control" rows="4" placeholder="Justifica t√©cnicamente el cambio propuesto..."></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Impacto en Otros √çtems:</label>
                    <input type="text" id="items-impactados" class="form-control" placeholder="Ej: 1.1.5, 1.1.10, 1.1.13">
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-dt" onclick="generarDTCompleto('${item.codigo}')">üìã Generar DT Completo</button>
                    <button class="btn btn-ajustar" onclick="previsualizarDT('${item.codigo}')">üëÅÔ∏è Previsualizar</button>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        function cerrarModal() {
            document.getElementById('modalAjuste').style.display = 'none';
        }

        function analizarCambio(codigo) {
            const nuevaCantidad = parseFloat(document.getElementById('nueva-cantidad').value);
            const justificacion = document.getElementById('justificacion-cambio').value;
            
            if (!justificacion) {
                alert('‚ùå Debes proporcionar una justificaci√≥n');
                return;
            }
            
            const item = wbsData.items.find(i => i.codigo === codigo);
            const cambio = nuevaCantidad - item.cantidad;
            const cambioTotal = cambio * item.vu_cop;
            
            const analisisHTML = `
                <h4>üìä AN√ÅLISIS DE IMPACTO</h4>
                <p><strong>Cambio en Cantidad:</strong> ${formatearNumero(cambio)} ${item.unidad} (${cambio > 0 ? '+' : ''}${((cambio/item.cantidad)*100).toFixed(1)}%)</p>
                <p><strong>Impacto Econ√≥mico:</strong> ${formatearPeso(Math.abs(cambioTotal))} COP ${cambioTotal > 0 ? '(incremento)' : '(ahorro)'}</p>
                <p><strong>Nuevo Total:</strong> ${formatearPeso(item.total_cop + cambioTotal)} COP</p>
                
                ${item.items_dependientes ? `
                    <hr style="margin: 15px 0;">
                    <p><strong>‚ö†Ô∏è √çtems Dependientes Afectados:</strong></p>
                    <ul>
                        ${item.items_dependientes.map(dep => `<li>${dep}</li>`).join('')}
                    </ul>
                ` : ''}
                
                <hr style="margin: 15px 0;">
                <p><strong>üéØ Recomendaci√≥n del Sistema:</strong></p>
                <p style="background: #e7f3ff; padding: 10px; border-radius: 4px;">
                    ${cambio > 0 ? '‚ö†Ô∏è El aumento requiere validaci√≥n t√©cnica y aprobaci√≥n PMO' : '‚úÖ La reducci√≥n puede generar ahorros pero requiere validar que no comprometa objetivos'}
                </p>
            `;
            
            document.getElementById('analisis-impacto').innerHTML = analisisHTML;
        }

        function generarDTCompleto(codigo) {
            const tipoCambio = document.getElementById('tipo-cambio').value;
            const observacion = document.getElementById('observacion-dt').value;
            const justificacion = document.getElementById('justificacion-dt').value;
            const itemsImpactados = document.getElementById('items-impactados').value;
            
            if (!observacion || !justificacion) {
                alert('‚ùå Debes completar observaci√≥n y justificaci√≥n');
                return;
            }
            
            // Generar DT Markdown completo con YAML
            const item = wbsData.items.find(i => i.codigo === codigo);
            const dtMarkdown = generarDTMarkdown(item, {
                tipo: tipoCambio,
                observacion: observacion,
                justificacion: justificacion,
                items_impactados: itemsImpactados
            });
            
            // Descargar archivo .md
            const fecha = new Date().toISOString().split('T')[0];
            const dtID = `DT-${item.categoria.toUpperCase()}-${String(Math.floor(Math.random()*1000)).padStart(3, '0')}-${fecha}`;
            const blob = new Blob([dtMarkdown], {type: 'text/markdown;charset=utf-8'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${dtID}.md`;
            a.click();
            URL.revokeObjectURL(url);
            
            // Mostrar instrucciones
            alert(`‚úÖ DECISI√ìN T√âCNICA GENERADA

Archivo: ${dtID}.md

üìã PR√ìXIMOS PASOS:
1. El archivo se descarg√≥ en tu carpeta Downloads
2. Mu√©velo a: II. Apendices Tecnicos/Decisiones_Tecnicas/
3. √Åbrelo en Cursor IDE
4. En Cursor, escribe: "Ejecuta ${dtID}"
5. Cursor leer√° el YAML y ejecutar√° los cambios

El archivo contiene:
‚úì An√°lisis completo
‚úì Valores actuales vs propuestos
‚úì Riesgos asociados
‚úì Archivos afectados
‚úì Instrucciones YAML para Cursor`);
            
            cerrarModal();
        }

        function generarDTMarkdown(item, cambios) {
            const fecha = new Date().toISOString().split('T')[0];
            const timestamp = new Date().toISOString();
            const dtID = `DT-${item.categoria.toUpperCase()}-${String(Math.floor(Math.random()*1000)).padStart(3, '0')}`;
            
            // Valores propuestos (se pueden obtener del modal si hay cambios de cantidad/precio)
            let nuevaCantidad = item.cantidad;
            let nuevoVU = item.vu_cop;
            
            // Intentar obtener valores del modal si existen
            const inputCantidad = document.getElementById('nueva-cantidad');
            const inputPrecio = document.getElementById('nuevo-precio');
            if (inputCantidad && inputCantidad.value) {
                nuevaCantidad = parseFloat(inputCantidad.value);
            }
            if (inputPrecio && inputPrecio.value) {
                nuevoVU = parseFloat(inputPrecio.value);
            }
            
            const nuevoTotal = nuevaCantidad * nuevoVU;
            const deltaCantidad = nuevaCantidad - item.cantidad;
            const deltaTotal = nuevoTotal - item.total_cop;
            const porcentajeCantidad = ((deltaCantidad / item.cantidad) * 100).toFixed(1);
            const porcentajeTotal = ((deltaTotal / item.total_cop) * 100).toFixed(1);
            
            return `# DECISI√ìN T√âCNICA - ${dtID}
**Sistema:** ${item.categoria} | **Fecha:** ${fecha} | **Estado:** ‚è≥ Pendiente Aprobaci√≥n

---

## 1. CONTEXTO AUTO-GENERADO

| Campo | Valor |
|-------|-------|
| √çtem WBS | ${item.codigo} |
| Descripci√≥n | ${item.descripcion} |
| Unidad | ${item.unidad} |
| Tipo | ${item.tipo} |
| Modificable | ${item.modificable ? 'S√≠' : 'No'} |
| Fecha generaci√≥n | ${fecha} |
| Tipo de cambio | ${cambios.tipo} |

---

## 2. OBSERVACI√ìN DEL USUARIO

${cambios.observacion}

---

## 3. JUSTIFICACI√ìN T√âCNICA

${cambios.justificacion}

---

## 4. VALORES: ACTUAL vs PROPUESTO

| Campo | Actual | Propuesto | Œî | Œî % |
|-------|--------|-----------|---|-----|
| Cantidad | ${formatearNumero(item.cantidad)} ${item.unidad} | ${formatearNumero(nuevaCantidad)} ${item.unidad} | ${formatearNumero(deltaCantidad)} | ${porcentajeCantidad}% |
| V/U (COP) | ${formatearPeso(item.vu_cop)} | ${formatearPeso(nuevoVU)} | ${formatearPeso(nuevoVU - item.vu_cop)} | ${(((nuevoVU - item.vu_cop)/item.vu_cop)*100).toFixed(1)}% |
| Total (COP) | ${formatearPeso(item.total_cop)} | ${formatearPeso(nuevoTotal)} | ${formatearPeso(deltaTotal)} | ${porcentajeTotal}% |

**Impacto Econ√≥mico:** ${deltaTotal < 0 ? 'AHORRO' : 'INCREMENTO'} de ${formatearPeso(Math.abs(deltaTotal))} COP

---

## 5. CRITERIO T√âCNICO ACTUAL

${item.criterio_tecnico ? `
**Justificaci√≥n:** ${item.criterio_tecnico.justificacion}

**Fuente:** ${item.criterio_tecnico.fuente}

**Normas aplicables:** ${item.criterio_tecnico.normas ? item.criterio_tecnico.normas.join(', ') : 'N/A'}

**C√°lculo base:** ${item.criterio_tecnico.calculo}

${item.criterio_tecnico.desglose ? `
**Desglose:**
${item.criterio_tecnico.desglose.map(d => `- ${d}`).join('\n')}
` : ''}

**Restricci√≥n:** ${item.criterio_tecnico.restriccion}
` : '_No documentado_'}

---

## 6. IMPACTO EN OTROS √çTEMS WBS

${item.items_dependientes ? `
**√çtems que requieren rec√°lculo:**
${item.items_dependientes.map(dep => `- ${dep}`).join('\n')}
` : '_No hay √≠tems dependientes identificados_'}

${cambios.items_impactados ? `
**√çtems adicionales mencionados:**
${cambios.items_impactados.split(',').map(i => `- ${i.trim()}`).join('\n')}
` : ''}

---

## 7. ARCHIVOS AFECTADOS

${item.archivos_relacionados ? item.archivos_relacionados.map(arch => `- [ ] \`${arch}\``).join('\n') : '_No documentado_'}

**Archivos principales a actualizar:**
- [ ] \`WBS_Presupuestal_v3.0.md\` ‚Üí Recalcular totales
- [ ] \`MATRIZ_DEPENDENCIAS_DOCUMENTALES_v1.0.md\` ‚Üí Agregar nueva fila
${deltaTotal !== 0 ? '- [ ] `MATRIZ_RIESGOS_PMO_AMPLIADA_v1.0.md` ‚Üí Actualizar riesgos si aplica' : ''}

---

## 8. AN√ÅLISIS DE RIESGOS

### Riesgos Actuales:
${item.riesgos_asociados && item.riesgos_asociados.length > 0 ? item.riesgos_asociados.map(r => `
- **${r.id}**: ${r.descripcion}
  - Probabilidad: ${r.probabilidad}
  - Impacto: ${r.impacto}
`).join('\n') : '_Sin riesgos identificados en base de datos_'}

### Nuevos Riesgos Potenciales:
${deltaCantidad < 0 ? '- ‚ö†Ô∏è Riesgo de insuficiencia si estimaci√≥n es conservadora' : ''}
${deltaCantidad > 0 ? '- ‚ö†Ô∏è Riesgo de sobrecosto si cantidad excesiva' : ''}
${Math.abs(porcentajeTotal) > 10 ? '- ‚ö†Ô∏è Impacto econ√≥mico significativo (>10%) requiere validaci√≥n PMO' : ''}

_A completar por especialista/PMO tras revisi√≥n_

---

## 9. RECOMENDACI√ìN DEL SISTEMA

${deltaTotal < 0 ? `
‚úÖ **RECOMENDACI√ìN: ANALIZAR PARA APROBACI√ìN**

**PROS:**
- Ahorro CAPEX: ${formatearPeso(Math.abs(deltaTotal))} (${Math.abs(porcentajeTotal)}%)
- Optimizaci√≥n de recursos
- Mejora en relaci√≥n costo-beneficio

**CONTRAS:**
- Requiere validaci√≥n que no comprometa objetivos t√©cnicos
- Posible impacto en ${item.items_dependientes ? item.items_dependientes.length : 0} √≠tems dependientes
- Necesita aprobaci√≥n PMO

**DECISI√ìN SUGERIDA:** Revisar criterios t√©cnicos y aprobar si cumple requisitos m√≠nimos
` : deltaTotal > 0 ? `
‚ö†Ô∏è **RECOMENDACI√ìN: VALIDAR NECESIDAD**

**PROS:**
- Puede mejorar calidad/capacidad
- Posible reducci√≥n de riesgos t√©cnicos

**CONTRAS:**
- Incremento CAPEX: ${formatearPeso(Math.abs(deltaTotal))} (${Math.abs(porcentajeTotal)}%)
- Requiere justificaci√≥n s√≥lida
- Necesita aprobaci√≥n PMO

**DECISI√ìN SUGERIDA:** Validar que incremento est√© justificado t√©cnicamente
` : `
‚ÑπÔ∏è **SIN IMPACTO ECON√ìMICO**

Cambio no afecta costo total. Validar solo aspectos t√©cnicos.
`}

---

## 10. INSTRUCCIONES PARA CURSOR ‚öôÔ∏è

\`\`\`yaml
# Configuraci√≥n de ejecuci√≥n automatizada
dt_metadata:
  id: "${dtID}"
  fecha: "${fecha}"
  timestamp: "${timestamp}"
  item_wbs: "${item.codigo}"
  tipo_cambio: "${cambios.tipo}"
  estado: "pendiente_ejecucion"

archivos_actualizar:
  - file: "IX. WBS y Planificacion/WBS_Presupuestal_v3.0.md"
    accion: "actualizar_y_versionar"
    seccion: "Item ${item.codigo}"
    cambios:
      - campo: "cantidad"
        buscar: "${item.cantidad}"
        reemplazar: "${nuevaCantidad}"
        tipo: "numero"
      - campo: "total_cop"
        buscar: "${item.total_cop}"
        reemplazar: "${nuevoTotal}"
        tipo: "numero"
        recalcular: true
    versionamiento:
      version_actual: "v3.0"
      version_nueva: "v3.1"
      razon: "${dtID} - ${cambios.tipo}"
      agregar_nota: "Origen: ${dtID} | Fecha: ${fecha}"

${item.archivos_relacionados ? item.archivos_relacionados.map((arch, idx) => `
  - file: "${arch.split('(')[0].trim()}"
    accion: "validar_y_actualizar"
    seccion: "${arch.includes('(') ? arch.match(/\(([^)]+)\)/)[1] : 'Buscar contexto'}"
    cambios:
      - campo: "cantidad_item_${item.codigo}"
        buscar: "${item.cantidad}"
        reemplazar: "${nuevaCantidad}"
        validar_contexto: true
        notas: "Verificar que sea el √≠tem correcto antes de aplicar"
`).join('') : ''}
  - file: "VIII. Documentos Maestros y Metodologia/Matrices_Dependencias/MATRIZ_DEPENDENCIAS_DOCUMENTALES_v1.0.md"
    accion: "agregar_fila"
    seccion: "Tabla principal"
    nueva_fila:
      sistema: "${item.categoria}"
      decision_tecnica: "${dtID}"
      archivos_afectados: "WBS_Presupuestal, ${item.archivos_relacionados ? item.archivos_relacionados.length : 0} archivos t√©cnicos"
      tipo_impacto: "${cambios.tipo === 'cantidad' ? 'Cantidades' : cambios.tipo === 'precio' ? 'Costos' : 'Especificaciones'}"

${item.items_dependientes && item.items_dependientes.length > 0 ? `
items_dependientes:
  recalcular: true
  items:
${item.items_dependientes.map(dep => `    - "${dep}"`).join('\n')}
  formula_base: "proporcional_a_item_principal"
` : ''}

validaciones:
  - verificar_archivos_existen: true
  - backup_antes_modificar: true
  - validar_formato_numeros: true
  - validar_normas_aplicables: ${item.criterio_tecnico?.normas ? JSON.stringify(item.criterio_tecnico.normas) : '[]'}
  - confirmar_con_usuario: true

notificaciones:
  - tipo: "inicio"
    mensaje: "Iniciando ejecuci√≥n de ${dtID}"
  - tipo: "progreso"
    mensaje: "Actualizando archivo {nombre_archivo}..."
  - tipo: "completado"
    mensaje: "‚úÖ ${dtID} ejecutado exitosamente - {cantidad_archivos} archivos actualizados"
  - tipo: "error"
    mensaje: "‚ùå Error en {archivo}: {descripcion_error}"

manejo_errores:
  - archivo_no_existe: "reportar_y_continuar"
  - seccion_no_encontrada: "pedir_confirmacion_manual"
  - validacion_falla: "detener_y_reportar"
  - backup_falla: "detener_ejecucion"
\`\`\`

---

## 11. ESTADO Y APROBACIONES

- [x] ‚è≥ Generado autom√°ticamente (${fecha})
- [ ] üìã Revisado por especialista: ________________ Fecha: _______
- [ ] ‚úÖ Aprobado PMO: ________________ Fecha: _______
- [ ] üîß Ejecutado por Cursor: ________________ Fecha: _______
- [ ] ‚úÖ Validado en campo: ________________ Fecha: _______

---

## 12. LOG DE EJECUCI√ìN

_Se completar√° autom√°ticamente al ejecutar desde Cursor_

\`\`\`
Fecha ejecuci√≥n: 
Usuario Cursor: 
Archivos modificados: 
Errores encontrados: 
Tiempo ejecuci√≥n: 
\`\`\`

---

**ID DT:** \`${dtID}\`  
**Versi√≥n:** 1.0  
**Generado desde:** WBS Interactiva v3.0  
**Timestamp:** ${timestamp}  
**Formato:** Markdown con YAML embebido  
`;
        }

        // Cerrar modal al hacer clic fuera
        window.onclick = function(event) {
            const modal = document.getElementById('modalAjuste');
            if (event.target == modal) {
                cerrarModal();
            }
        }

        // Cargar WBS al iniciar
        document.addEventListener('DOMContentLoaded', cargarWBS);
    </script>
</body>
</html>

