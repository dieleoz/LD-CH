<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WBS COMPLETA - Todos los √çtems Interactivos v4.0</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 10px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            body {
                padding: 5px;
            }
            
            .container {
                border-radius: 8px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 22px;
            }
            
            .content {
                padding: 20px;
            }
            
            .wbs-tree {
                font-size: 12px;
            }
            
            .wbs-item {
                margin: 8px 0;
                padding: 10px;
            }
            
            .wbs-item h3 {
                font-size: 14px;
            }
            
            table {
                font-size: 11px;
            }
            
            .wbs-table th,
            .wbs-table td {
                padding: 6px 4px;
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 18px;
            }
            
            .content {
                padding: 15px;
            }
            
            .wbs-tree {
                font-size: 11px;
            }
            
            .wbs-item {
                margin: 6px 0;
                padding: 8px;
            }
            
            .wbs-table {
                font-size: 10px;
            }
            
            .wbs-table th,
            .wbs-table td {
                padding: 4px 2px;
            }
        }
        
        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .stats-bar {
            background: #f8f9fa;
            padding: 15px 20px;
            display: flex;
            justify-content: space-around;
            border-bottom: 2px solid #dee2e6;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #007bff;
        }
        
        .stat-label {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }
        
        .filtros {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filtro-btn {
            padding: 8px 16px;
            border: 2px solid #dee2e6;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .filtro-btn:hover {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        
        .filtro-btn.activo {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }
        
        .btn-nuevo-capitulo {
            padding: 10px 20px;
            background: #6610f2;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            margin-left: auto;
        }
        
        .btn-nuevo-capitulo:hover {
            background: #520dc2;
        }
        
        .capitulo-seccion {
            margin: 20px;
        }
        
        .capitulo-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .capitulo-header:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .capitulo-titulo {
            font-size: 20px;
            font-weight: bold;
        }
        
        .capitulo-count {
            background: white;
            color: #667eea;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
        }
        
        .subcapitulo-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 12px 20px;
            margin: 15px 20px 10px 20px;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }
        
        .subcapitulo-header h4 {
            margin: 0;
            color: #495057;
            font-size: 16px;
            font-weight: 600;
        }
        
        .item-card {
            margin: 10px 20px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            overflow: hidden;
            background: white;
            transition: all 0.3s;
        }
        
        .item-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        .item-header {
            padding: 15px 20px;
            background: #f8f9fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #dee2e6;
        }
        
        .item-codigo {
            font-weight: bold;
            font-size: 16px;
            color: #007bff;
        }
        
        .item-modificable {
            background: #28a745;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
        }
        
        .item-body {
            padding: 15px 20px;
        }
        
        .item-descripcion {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .item-valores {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        
        .valor-box {
            text-align: center;
        }
        
        .valor-label {
            font-size: 11px;
            color: #6c757d;
            margin-bottom: 3px;
        }
        
        .valor-dato {
            font-size: 15px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .botones-accion {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 13px;
        }
        
        .btn-dt {
            background: #6610f2;
            color: white;
        }
        
        .btn-dt:hover {
            background: #520dc2;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 0;
            border: none;
            width: 90%;
            max-width: 800px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px 12px 0 0;
        }
        
        .close {
            color: white;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: #f8f9fa;
        }
        
        .modal-body {
            padding: 30px;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }
        
        .form-control {
            width: 100%;
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #007bff;
        }
        
        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }
        
        .oculto {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä WBS PRESUPUESTAL COMPLETA v4.0</h1>
            <p>APP La Dorada-Chiriguan√° | 159 √çtems Totales (134 Modificables) + Proponer Nuevos Cap√≠tulos</p>
        </div>

        <div class="stats-bar">
            <div class="stat-item">
                <div class="stat-value" id="total-items">0</div>
                <div class="stat-label">√çTEMS TOTALES</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="total-capitulos">6</div>
                <div class="stat-label">CAP√çTULOS</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="total-modificables">0</div>
                <div class="stat-label">MODIFICABLES</div>
            </div>
        </div>

        <div class="filtros">
            <button class="filtro-btn activo" onclick="filtrarItems('todos')">üìã Todos</button>
            <button class="filtro-btn" onclick="filtrarItems('capitulo-1')">Cap 1: Control</button>
            <button class="filtro-btn" onclick="filtrarItems('capitulo-2')">Cap 2: Telecom</button>
            <button class="filtro-btn" onclick="filtrarItems('capitulo-3')">Cap 3: Seguridad</button>
            <button class="filtro-btn" onclick="filtrarItems('capitulo-4')">Cap 4: Pasos Nivel</button>
            <button class="filtro-btn" onclick="filtrarItems('capitulo-5')">Cap 5: Centro Control</button>
            <button class="filtro-btn" onclick="filtrarItems('capitulo-6')">Cap 6: Material Rodante</button>
            <button class="btn-nuevo-capitulo" onclick="abrirModalNuevoCapitulo()">‚ûï Proponer Nuevo Cap√≠tulo</button>
        </div>

        <div id="wbs-container">
            <!-- Los cap√≠tulos e √≠tems se cargan aqu√≠ din√°micamente -->
        </div>
    </div>

    <!-- Modal DT -->
    <div id="modalDT" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="cerrarModal('modalDT')">&times;</span>
                <h2 id="modal-dt-titulo">Crear Decisi√≥n T√©cnica</h2>
            </div>
            <div class="modal-body" id="modal-dt-body">
                <!-- Contenido din√°mico -->
            </div>
        </div>
    </div>

    <!-- Modal Nuevo Cap√≠tulo -->
    <div id="modalNuevoCapitulo" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="cerrarModal('modalNuevoCapitulo')">&times;</span>
                <h2>‚ûï Proponer Nuevo Cap√≠tulo</h2>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">N√∫mero de Cap√≠tulo:</label>
                    <input type="number" id="nuevo-cap-numero" class="form-control" value="7" min="7" max="20">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Nombre del Cap√≠tulo:</label>
                    <input type="text" id="nuevo-cap-nombre" class="form-control" placeholder="Ej: SISTEMAS DE ENERG√çA">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Descripci√≥n del Cap√≠tulo:</label>
                    <textarea id="nuevo-cap-descripcion" class="form-control" rows="4" placeholder="Describe el alcance y contenido del nuevo cap√≠tulo..."></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Justificaci√≥n T√©cnica:</label>
                    <textarea id="nuevo-cap-justificacion" class="form-control" rows="4" placeholder="Por qu√© se necesita este nuevo cap√≠tulo..."></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Presupuesto Estimado (COP):</label>
                    <input type="number" id="nuevo-cap-presupuesto" class="form-control" placeholder="Estimaci√≥n inicial">
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-dt" onclick="generarDTNuevoCapitulo()">üìã Generar DT de Nuevo Cap√≠tulo</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Cargar datos desde archivos JS -->
    <script src="datos_wbs_TODOS_items.js?v=1.0.4"></script>
    <script src="wbs_metadata_enriquecida.js?v=2.0.0"></script>
    <script src="criterios_tecnicos_base.js?v=1.0.0"></script>
    
    <script>
        let wbsData = { items: [] };
        let itemsPorCapitulo = {};
        let criteriosTecnicos = {};

        // Cargar criterios t√©cnicos desde JS
        if (typeof criteriosTecnicosBase !== 'undefined') {
            criteriosTecnicos = criteriosTecnicosBase.criterios;
            console.log('‚úÖ Criterios t√©cnicos cargados:', Object.keys(criteriosTecnicos).length, '√≠tems con criterios');
        } else {
            console.warn('‚ö†Ô∏è No se carg√≥ criterios_tecnicos_base.js');
            criteriosTecnicos = {};
        }

        // Usar datos cargados desde el archivo JS
        if (typeof wbsDataGlobal !== 'undefined') {
            wbsData = wbsDataGlobal;
            procesarYCargarWBS();
        } else {
            console.error('Error: No se pudo cargar wbsDataGlobal');
            alert('No se pudo cargar los datos. Usando datos demo.');
            cargarDatosDemo();
        }

        function procesarYCargarWBS() {
            // Verificar que wbsMetadata est√© disponible
            console.log('üîç Verificando disponibilidad de metadata:');
            console.log('  - typeof wbsMetadata:', typeof wbsMetadata);
            console.log('  - typeof window.wbsMetadata:', typeof window.wbsMetadata);
            if (typeof wbsMetadata !== 'undefined' && wbsMetadata && wbsMetadata.items) {
                console.log('‚úÖ wbsMetadata.items tiene', Object.keys(wbsMetadata.items).length, 'items');
                console.log('   Items con metadata:', Object.keys(wbsMetadata.items).slice(0, 10).join(', '));
            }
            
            // Agrupar por cap√≠tulo
            itemsPorCapitulo = {};
            
            wbsData.items.forEach(item => {
                // Extraer cap√≠tulo del c√≥digo (primer d√≠gito)
                const capitulo = item.codigo.split('.')[0];
                if (!itemsPorCapitulo[capitulo]) {
                    itemsPorCapitulo[capitulo] = [];
                }
                item.capitulo = capitulo; // Asegurar que tenga cap√≠tulo
                itemsPorCapitulo[capitulo].push(item);
            });
            
            cargarWBS();
        }

        function cargarWBS() {
            const container = document.getElementById('wbs-container');
            container.innerHTML = '';
            
            let totalModificables = 0;
            let totalItemsNivel3 = 0;
            
            console.log('========== INICIANDO CARGA DE WBS ==========');
            console.log(`Total de √≠tems en datos: ${wbsData.items.length}`);
            console.log(`Cap√≠tulos encontrados: ${Object.keys(itemsPorCapitulo).join(', ')}`);
            
            // Crear secciones por cap√≠tulo (ordenar num√©ricamente)
            Object.keys(itemsPorCapitulo).sort((a, b) => Number(a) - Number(b)).forEach(capitulo => {
                const items = itemsPorCapitulo[capitulo];
                const capSeccion = crearSeccionCapitulo(capitulo, items);
                container.appendChild(capSeccion);
                
                // Contar solo √≠tems de nivel 3 (X.Y.ZZZ) como modificables
                const itemsN3 = items.filter(i => i.codigo && i.codigo.match(/^\d+\.\d+\.\d+$/));
                totalItemsNivel3 += itemsN3.length;
                totalModificables += itemsN3.filter(i => i.modificable).length;
                
                console.log(`Cap√≠tulo ${capitulo}: ${itemsN3.length} √≠tems nivel 3, ${itemsN3.filter(i => i.modificable).length} modificables`);
            });
            
            console.log(`========== RESUMEN CARGA ==========`);
            console.log(`Total √≠tems nivel 3 cargados: ${totalItemsNivel3}`);
            console.log(`Total modificables: ${totalModificables}`);
            console.log(`=======================================`);
            
            // Actualizar stats
            document.getElementById('total-items').textContent = totalItemsNivel3;
            document.getElementById('total-capitulos').textContent = Object.keys(itemsPorCapitulo).length;
            document.getElementById('total-modificables').textContent = totalModificables;
        }

        function crearSeccionCapitulo(capitulo, items) {
            const seccion = document.createElement('div');
            seccion.className = 'capitulo-seccion';
            seccion.dataset.capitulo = capitulo;
            
            const nombresCap = {
                '1': 'CONTROL Y SE√ëALIZACI√ìN VIRTUAL',
                '2': 'TELECOMUNICACIONES',
                '3': 'SISTEMAS ITS Y SEGURIDAD',
                '4': 'PASOS A NIVEL',
                '5': 'CENTRO DE CONTROL OPERACIONAL',
                '6': 'MATERIAL RODANTE'
            };
            
            const header = document.createElement('div');
            header.className = 'capitulo-header';
            header.onclick = () => toggleCapitulo(capitulo);
            header.innerHTML = `
                <div class="capitulo-titulo">CAP√çTULO ${capitulo}: ${nombresCap[capitulo] || 'NUEVO CAP√çTULO'}</div>
                <div class="capitulo-count">${items.length} √≠tems</div>
            `;
            
            seccion.appendChild(header);
            
            const itemsContainer = document.createElement('div');
            itemsContainer.id = `items-capitulo-${capitulo}`;
            
            // Filtrar para mostrar solo √≠tems de nivel 3 (X.Y.ZZZ)
            // Cap√≠tulos (1, 2...) y Subcap√≠tulos (1.1, 1.2...) NO se muestran como tarjetas
            const itemsNivel3 = items.filter(item => {
                // Nivel 3 tiene patr√≥n: X.Y.ZZZ (ej: 1.1.100, 2.3.103)
                return item.codigo && item.codigo.match(/^\d+\.\d+\.\d+$/);
            });
            
            // Agrupar por subcap√≠tulo (extrayendo los primeros 2 niveles correctamente)
            const itemsPorSubcapitulo = {};
            itemsNivel3.forEach(item => {
                // Extraer subcap√≠tulo usando split para manejar cualquier n√∫mero de d√≠gitos
                const partes = item.codigo.split('.');
                const sub = partes[0] + '.' + partes[1]; // "1.1", "2.3", "10.15", etc.
                if (!itemsPorSubcapitulo[sub]) {
                    itemsPorSubcapitulo[sub] = [];
                }
                itemsPorSubcapitulo[sub].push(item);
            });
            
            // Crear secciones por subcap√≠tulo (ordenar num√©ricamente)
            const subCaps = Object.keys(itemsPorSubcapitulo).sort((a, b) => {
                const [a1, a2] = a.split('.').map(Number);
                const [b1, b2] = b.split('.').map(Number);
                return (a1 - b1) || (a2 - b2);
            });
            
            console.log(`Cap√≠tulo ${capitulo}: ${itemsNivel3.length} √≠tems en ${subCaps.length} subcap√≠tulos`);
            
            subCaps.forEach(subCap => {
                // Buscar info del subcap√≠tulo
                const subInfo = items.find(i => i.codigo === subCap);
                if (subInfo) {
                    const subHeader = document.createElement('div');
                    subHeader.className = 'subcapitulo-header';
                    subHeader.innerHTML = `<h4>üìÅ ${subCap} - ${subInfo.descripcion} (${itemsPorSubcapitulo[subCap].length} √≠tems)</h4>`;
                    itemsContainer.appendChild(subHeader);
                }
                
                // Agregar √≠tems del subcap√≠tulo (ordenar por c√≥digo)
                itemsPorSubcapitulo[subCap].sort((a, b) => {
                    return a.codigo.localeCompare(b.codigo, undefined, { numeric: true });
                }).forEach(item => {
                    const card = crearCardItem(item);
                    itemsContainer.appendChild(card);
                });
            });
            
            seccion.appendChild(itemsContainer);
            
            return seccion;
        }

        function crearCardItem(item) {
            const card = document.createElement('div');
            card.className = 'item-card';
            card.dataset.codigo = item.codigo;
            card.dataset.capitulo = item.capitulo;
            
            // Buscar criterio t√©cnico para este √≠tem
            const criterio = criteriosTecnicos[item.codigo];
            
            // Si no hay criterio t√©cnico, buscar metadata enriquecida
            let metadata = null;
            if (!criterio) {
                // Intentar m√∫ltiples formas de acceso
                let wbsMetadataEncontrada = null;
                
                // Primero intentar con variable local
                if (typeof wbsMetadata !== 'undefined' && wbsMetadata && wbsMetadata.items) {
                    wbsMetadataEncontrada = wbsMetadata;
                }
                // Luego intentar con window.wbsMetadata
                else if (typeof window.wbsMetadata !== 'undefined' && window.wbsMetadata && window.wbsMetadata.items) {
                    wbsMetadataEncontrada = window.wbsMetadata;
                }
                
                // Si encontramos metadata, buscar el item
                if (wbsMetadataEncontrada && wbsMetadataEncontrada.items[item.codigo]) {
                    metadata = wbsMetadataEncontrada.items[item.codigo];
                }
            }
            
            card.innerHTML = `
                <div class="item-header">
                    <div class="item-codigo">${item.codigo}</div>
                    ${item.modificable ? '<div class="item-modificable">‚úÖ MODIFICABLE</div>' : ''}
                </div>
                
                <div class="item-body">
                    <div class="item-descripcion">${item.descripcion}</div>
                    
                    <div class="item-valores">
                        <div class="valor-box">
                            <div class="valor-label">Cantidad</div>
                            <div class="valor-dato">${item.cantidad || 'N/A'}</div>
                        </div>
                        <div class="valor-box">
                            <div class="valor-label">Unidad</div>
                            <div class="valor-dato">${item.unidad || 'N/A'}</div>
                        </div>
                        <div class="valor-box">
                            <div class="valor-label">Tipo</div>
                            <div class="valor-dato" style="color: ${item.tipo === 'SUMINISTRO' ? '#28a745' : item.tipo === 'OBRA' ? '#ffc107' : '#17a2b8'}">
                                ${item.tipo || 'N/A'}
                            </div>
                        </div>
                        <div class="valor-box">
                            <div class="valor-label">V/U (COP)</div>
                            <div class="valor-dato">${formatearPeso(item.vu_cop)}</div>
                        </div>
                        <div class="valor-box">
                            <div class="valor-label">Total (COP)</div>
                            <div class="valor-dato">${formatearPeso(item.total_cop)}</div>
                        </div>
                    </div>
                    
                    ${criterio ? `
                        <div style="background: #e7f3ff; border-left: 4px solid #007bff; padding: 15px; margin: 15px 0; border-radius: 6px;">
                            <div style="font-weight: bold; color: #007bff; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                                üéØ CRITERIO T√âCNICO
                                <button onclick='descargarCriterioDetallado("${item.codigo}")' style="margin-left: auto; padding: 5px 10px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                    üì• Descargar Detalle
                                </button>
                            </div>
                            <div style="color: #495057; font-size: 14px; line-height: 1.6;">
                                <strong>Justificaci√≥n:</strong> ${criterio.criterio_tecnico.justificacion}<br>
                                <strong>C√°lculo:</strong> ${criterio.criterio_tecnico.calculo_detallado}<br>
                                ${criterio.criterio_tecnico.desglose ? `
                                    <strong>Desglose:</strong>
                                    <ul style="margin: 8px 0; padding-left: 20px;">
                                        ${criterio.criterio_tecnico.desglose.map(d => `<li>${d}</li>`).join('')}
                                    </ul>
                                ` : ''}
                                <strong>Fuente normativa:</strong> ${criterio.criterio_tecnico.fuente_normativa}<br>
                                <strong>Restricci√≥n:</strong> <span style="color: #dc3545; font-weight: 600;">${criterio.criterio_tecnico.restriccion}</span>
                            </div>
                        </div>
                        
                        ${criterio.criterio_tecnico.alternativas && criterio.criterio_tecnico.alternativas.length > 0 ? `
                            <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin: 15px 0; border-radius: 6px;">
                                <div style="font-weight: bold; color: #856404; margin-bottom: 10px;">üí° ALTERNATIVAS T√âCNICAS</div>
                                <ul style="color: #856404; font-size: 13px; margin: 0; padding-left: 20px; line-height: 1.8;">
                                    ${criterio.criterio_tecnico.alternativas.map(alt => `<li>${alt}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        
                        ${criterio.riesgos_asociados && criterio.riesgos_asociados.length > 0 ? `
                            <div style="background: #f8d7da; border-left: 4px solid #dc3545; padding: 15px; margin: 15px 0; border-radius: 6px;">
                                <div style="font-weight: bold; color: #dc3545; margin-bottom: 10px;">‚ö†Ô∏è RIESGOS ASOCIADOS (${criterio.riesgos_asociados.length})</div>
                                ${criterio.riesgos_asociados.map(r => `
                                    <div style="background: white; padding: 10px; margin: 8px 0; border-radius: 4px;">
                                        <strong style="color: #dc3545;">${r.id}:</strong> ${r.descripcion}<br>
                                        <small style="color: #6c757d;">
                                            Probabilidad: ${r.probabilidad} | Impacto: ${r.impacto}<br>
                                            Estrategia: ${r.estrategia}
                                        </small>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    ` : metadata ? `
                        <div style="background: #e7f3ff; border-left: 4px solid #007bff; padding: 15px; margin: 15px 0; border-radius: 6px;">
                            <div style="font-weight: bold; color: #007bff; margin-bottom: 10px;">üî¨ JUSTIFICACI√ìN T√âCNICA</div>
                            <div style="color: #495057; font-size: 14px; line-height: 1.6;">
                                ${metadata.justificacion_tecnica || 'Por definir'}
                            </div>
                            ${metadata.referencias_contractuales && metadata.referencias_contractuales.length > 0 ? `
                                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #dee2e6;">
                                    <strong style="color: #856404;">‚öñÔ∏è Referencias:</strong>
                                    <ul style="margin: 8px 0; padding-left: 20px; font-size: 13px;">
                                        ${metadata.referencias_contractuales.map(ref => `<li>${ref}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            ${metadata.criterios_diseno && metadata.criterios_diseno.length > 0 ? `
                                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #dee2e6;">
                                    <strong style="color: #856404;">‚öôÔ∏è Criterios:</strong>
                                    <ul style="margin: 8px 0; padding-left: 20px; font-size: 13px;">
                                        ${metadata.criterios_diseno.slice(0, 2).map(crit => `<li>${crit}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    ` : `
                        <div style="background: #fff3cd; border: 1px solid #ffc107; padding: 12px; margin: 15px 0; border-radius: 6px; text-align: center;">
                            <span style="color: #856404;">‚ö†Ô∏è Criterio t√©cnico no documentado para este √≠tem</span>
                            <button onclick='solicitarCriterioTecnico("${item.codigo}")' style="margin-left: 10px; padding: 5px 10px; background: #ffc107; border: none; border-radius: 4px; cursor: pointer;">
                                üìù Solicitar Documentaci√≥n
                            </button>
                        </div>
                    `}
                    
                    <div class="botones-accion">
                        <button class="btn btn-dt" onclick='abrirModalDT("${item.codigo}")'>üìã Crear DT</button>
                        ${criterio && criterio.criterio_tecnico.documentos_referencia ? `
                            <button class="btn" style="background: #17a2b8; color: white;" onclick='mostrarDocumentosReferencia("${item.codigo}")'>
                                üìö Ver Documentos
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
            
            return card;
        }

        function formatearPeso(valor) {
            if (!valor) return '$0';
            return '$' + valor.toLocaleString('es-CO');
        }

        function toggleCapitulo(capitulo) {
            const container = document.getElementById(`items-capitulo-${capitulo}`);
            container.classList.toggle('oculto');
        }

        function filtrarItems(filtro) {
            const secciones = document.querySelectorAll('.capitulo-seccion');
            const botones = document.querySelectorAll('.filtro-btn');
            
            // Actualizar botones
            botones.forEach(btn => btn.classList.remove('activo'));
            event.target.classList.add('activo');
            
            secciones.forEach(seccion => {
                if (filtro === 'todos') {
                    seccion.style.display = 'block';
                } else if (filtro.startsWith('capitulo-')) {
                    const cap = filtro.split('-')[1];
                    seccion.style.display = seccion.dataset.capitulo === cap ? 'block' : 'none';
                }
            });
        }

        function abrirModalDT(codigo) {
            const item = wbsData.items.find(i => i.codigo === codigo);
            const modal = document.getElementById('modalDT');
            const titulo = document.getElementById('modal-dt-titulo');
            const body = document.getElementById('modal-dt-body');
            
            // Obtener metadata enriquecida si existe
            const metadata = (typeof wbsMetadata !== 'undefined' && wbsMetadata.items && wbsMetadata.items[codigo]) 
                ? wbsMetadata.items[codigo] 
                : null;
            
            titulo.textContent = `Crear DT: ${codigo} - ${item.descripcion}`;
            
            body.innerHTML = `
                <div class="form-group">
                    <label class="form-label">Tipo de Cambio:</label>
                    <select id="dt-tipo-cambio" class="form-control">
                        <option value="cantidad">Ajuste de Cantidad</option>
                        <option value="precio">Ajuste de Precio</option>
                        <option value="eliminacion">Eliminaci√≥n de √çtem</option>
                        <option value="criterio_tecnico">Ajuste Criterio T√©cnico (Justificaci√≥n)</option>
                        <option value="riesgo">Identificaci√≥n de Riesgo</option>
                        <option value="cronograma">Ajuste de Cronograma</option>
                        <option value="riesgo_cronograma">Riesgo + Ajuste Cronograma</option>
                        <option value="otro">Otro</option>
                    </select>
                </div>
                
                ${metadata && metadata.referencias_contractuales && metadata.referencias_contractuales.length > 0 ? `
                    <div style="background: #fff9e6; padding: 15px; border-radius: 4px; border-left: 4px solid #ffc107; margin: 15px 0;">
                        <strong>‚öñÔ∏è Referencias Contractuales:</strong>
                        <ul style="margin: 10px 0 0 20px; padding-left: 10px;">
                            ${metadata.referencias_contractuales.map(ref => `<li style="margin: 5px 0;">${ref}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}
                
                <div class="form-group">
                    <label class="form-label">Observaci√≥n T√©cnica:</label>
                    <textarea id="dt-observacion" class="form-control" rows="4" placeholder="Describe tu propuesta..."></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Justificaci√≥n:</label>
                    <textarea id="dt-justificacion" class="form-control" rows="6" placeholder="Justifica t√©cnicamente el cambio...">${metadata && metadata.justificacion_tecnica ? metadata.justificacion_tecnica : ''}</textarea>
                </div>
                
                ${metadata && metadata.criterios_diseno && metadata.criterios_diseno.length > 0 ? `
                    <div style="background: #f9fbe7; padding: 15px; border-radius: 4px; border-left: 4px solid #cddc39; margin: 15px 0;">
                        <strong>‚öôÔ∏è Criterios de Dise√±o Actuales:</strong>
                        <ul style="margin: 10px 0 0 20px; padding-left: 10px;">
                            ${metadata.criterios_diseno.map(crit => `<li style="margin: 5px 0;">${crit}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-dt" onclick="generarDTItem('${codigo}')">üìã Generar DT</button>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        function abrirModalNuevoCapitulo() {
            document.getElementById('modalNuevoCapitulo').style.display = 'block';
        }

        function cerrarModal(idModal) {
            document.getElementById(idModal).style.display = 'none';
        }

        function generarDTItem(codigo) {
            const item = wbsData.items.find(i => i.codigo === codigo);
            const tipo = document.getElementById('dt-tipo-cambio').value;
            const observacion = document.getElementById('dt-observacion').value;
            const justificacion = document.getElementById('dt-justificacion').value;
            
            if (!observacion || !justificacion) {
                alert('‚ùå Debes completar observaci√≥n y justificaci√≥n');
                return;
            }
            
            const fecha = new Date().toISOString().split('T')[0];
            const sistema = item.capitulo === '1' ? 'FIBRA' : 
                           item.capitulo === '2' ? 'TETRA' : 
                           item.capitulo === '3' ? 'CCTV' : 
                           item.capitulo === '4' ? 'SAI' : 
                           item.capitulo === '5' ? 'SE√ëALIZACION' : 
                           item.capitulo === '6' ? 'CTC' : 'SISTEMA';
            const dtID = `DT-${sistema}-${String(Math.floor(Math.random()*1000)).padStart(3, '0')}-${fecha}`;
            
            const dtContent = `# DECISI√ìN T√âCNICA: ${dtID}
**√çtem WBS:** ${codigo} - ${item.descripcion}  
**Tipo de cambio:** ${tipo}  
**Fecha:** ${fecha}  
**Especialista:** [Nombre del especialista]  

---

## 1. DESCRIPCI√ìN DEL √çTEM ACTUAL

**C√≥digo WBS:** ${codigo}  
**Descripci√≥n:** ${item.descripcion}  
**Cantidad actual:** ${item.cantidad} ${item.unidad}  
**Valor unitario:** $${parseInt(item.valor_unitario).toLocaleString('es-CO')} COP  
**Valor total:** $${parseInt(item.total).toLocaleString('es-CO')} COP  
**Tipo:** ${item.tipo}  
**Cap√≠tulo:** ${item.capitulo}  

---

## 2. OBSERVACI√ìN DEL ESPECIALISTA

${observacion}

---

## 3. JUSTIFICACI√ìN T√âCNICA

${justificacion}

---

## 4. TIPO DE CAMBIO PROPUESTO

**Categor√≠a:** ${tipo}

---

## 5. PROPUESTA DE CAMBIO

### Valores propuestos:
- **Cantidad nueva:** [Especificar] ${item.unidad}
- **Valor unitario nuevo:** [Especificar] COP
- **Justificaci√≥n del cambio:** ${justificacion}

---

## 6. IMPACTO ESPERADO

### Impacto presupuestal:
- **Valor actual:** $${parseInt(item.total).toLocaleString('es-CO')} COP
- **Valor propuesto:** [Calcular]
- **Variaci√≥n:** [+/- %]

### Impacto en cronograma:
- [Especificar d√≠as de impacto]

### Impacto en riesgos:
- [Identificar nuevos riesgos o mitigados]

---

## 7. ARCHIVOS AFECTADOS

- IX. WBS y Planificacion/WBS_Presupuestal_v2.0.md (Item ${codigo})
- [Otros archivos seg√∫n aplique]

---

## 8. √çTEMS DEPENDIENTES

- [Listar √≠tems WBS que se ven afectados]

---

## 9. ALTERNATIVAS CONSIDERADAS

1. **Alternativa 1:** [Descripci√≥n]
2. **Alternativa 2:** [Descripci√≥n]
3. **Alternativa seleccionada:** [Descripci√≥n y justificaci√≥n]

---

## 10. INSTRUCCIONES PARA CURSOR ‚öôÔ∏è

\`\`\`yaml
dt_metadata:
  dt_id: "${dtID}"
  item_wbs: "${codigo}"
  tipo_cambio: "${tipo}"
  fecha: "${fecha}"
  especialista: "[Nombre]"
  
archivos_actualizar:
  - file: "IX. WBS y Planificacion/WBS_Presupuestal_v2.0.md"
    accion: "actualizar_y_versionar"
    seccion: "Item ${codigo}"
    cambios:
      - campo: "cantidad"
        buscar: "${item.cantidad}"
        reemplazar: "[NUEVA_CANTIDAD]"
      - campo: "valor_unitario"
        buscar: "${item.valor_unitario}"
        reemplazar: "[NUEVO_VALOR]"
    versionamiento:
      version_actual: "v2.0"
      version_nueva: "v2.1"
      razon: "${dtID} - ${tipo}"
      agregar_nota: "Origen: ${dtID} | Fecha: ${fecha}"

items_dependientes:
  recalcular: false
  items: []
  formula_base: "proporcional_a_item_principal"

validaciones:
  - verificar_archivos_existen: true
  - backup_antes_modificar: true
  - validar_formato_numeros: true
  - confirmar_con_usuario: true

manejo_errores:
  - archivo_no_existe: "reportar_y_continuar"
  - seccion_no_encontrada: "pedir_confirmacion_manual"
  - validacion_falla: "detener_y_reportar"
  - backup_falla: "detener_ejecucion"
\`\`\`

---

## 11. ESTADO DE EJECUCI√ìN

- [ ] üìù Revisado por PMO
- [ ] ‚úÖ Aprobado para ejecuci√≥n
- [ ] üîß Ejecutado por Cursor: [fecha-hora]
- [ ] üìä Validado: Cambios aplicados correctamente

---

## 12. LOG DE EJECUCI√ìN

\`\`\`
[Pendiente de ejecuci√≥n]

Fecha ejecuci√≥n: 
Usuario Cursor: 
Archivos modificados: 
√çtems recalculados: 
Errores encontrados: 
Tiempo ejecuci√≥n: 
\`\`\`

---

**Generado desde:** WBS Interactiva v4.0  
**Fecha generaci√≥n:** ${fecha}  
**Sistema:** ${sistema}  
**Especialista:** [Nombre]  
`;
            
            // Descargar archivo
            const blob = new Blob([dtContent], {type: 'text/markdown;charset=utf-8'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${dtID}.md`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert(`‚úÖ DT GENERADA Y DESCARGADA\\n\\nArchivo: ${dtID}.md\\n\\nPr√≥ximos pasos:\\n1. Completa los campos [NUEVA_CANTIDAD] y [NUEVO_VALOR] en el YAML\\n2. Mueve a: II/Decisiones_Tecnicas/\\n3. Abre en Cursor\\n4. Cursor preguntar√° si ejecutar\\n5. Confirma y revisa cambios`);
            
            cerrarModal('modalDT');
        }

        function generarDTNuevoCapitulo() {
            const numero = document.getElementById('nuevo-cap-numero').value;
            const nombre = document.getElementById('nuevo-cap-nombre').value;
            const descripcion = document.getElementById('nuevo-cap-descripcion').value;
            const justificacion = document.getElementById('nuevo-cap-justificacion').value;
            const presupuesto = document.getElementById('nuevo-cap-presupuesto').value;
            
            if (!nombre || !descripcion || !justificacion) {
                alert('‚ùå Debes completar todos los campos');
                return;
            }
            
            const dtID = `DT-CAP${numero}-${String(Math.floor(Math.random()*1000)).padStart(3, '0')}`;
            const fecha = new Date().toISOString().split('T')[0];
            
            const dtContent = `# DECISI√ìN T√âCNICA - ${dtID}
**Tipo:** Propuesta Nuevo Cap√≠tulo | **Fecha:** ${fecha}

## 1. PROPUESTA DE NUEVO CAP√çTULO

**Cap√≠tulo:** ${numero}
**Nombre:** ${nombre}

## 2. DESCRIPCI√ìN

${descripcion}

## 3. JUSTIFICACI√ìN T√âCNICA

${justificacion}

## 4. PRESUPUESTO ESTIMADO

Total estimado: $${parseInt(presupuesto).toLocaleString('es-CO')} COP

## 5. PR√ìXIMOS PASOS

- [ ] Aprobaci√≥n PMO
- [ ] Desarrollo de estructura detallada
- [ ] Definici√≥n de √≠tems y sub-√≠tems
- [ ] Integraci√≥n en WBS oficial

---

**Generado desde:** WBS Interactiva v4.0
`;
            
            // Descargar archivo
            const blob = new Blob([dtContent], {type: 'text/markdown;charset=utf-8'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${dtID}-${fecha}.md`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert(`‚úÖ DT DE NUEVO CAP√çTULO GENERADA\\n\\nArchivo: ${dtID}-${fecha}.md\\n\\nPr√≥ximos pasos:\\n1. Mueve a: II/Decisiones_Tecnicas/\\n2. Revisa con PMO\\n3. Si se aprueba, se agregar√° al WBS oficial`);
            
            cerrarModal('modalNuevoCapitulo');
        }

        function descargarCriterioDetallado(codigo) {
            const item = wbsData.items.find(i => i.codigo === codigo);
            const criterio = criteriosTecnicos[codigo];
            
            if (!criterio) {
                alert('‚ö†Ô∏è No hay criterio t√©cnico documentado para este √≠tem');
                return;
            }
            
            const fecha = new Date().toISOString().split('T')[0];
            const contenidoMD = `# CRITERIO T√âCNICO DETALLADO
## √çtem ${codigo} - ${item.descripcion}

**Fecha:** ${fecha}  
**Documento:** Criterio T√©cnico  
**Estado:** Vigente  

---

## 1. IDENTIFICACI√ìN DEL √çTEM

| Campo | Valor |
|-------|-------|
| C√≥digo WBS | ${codigo} |
| Descripci√≥n | ${item.descripcion} |
| Cantidad | ${item.cantidad} ${item.unidad} |
| Valor Unitario | ${formatearPeso(item.vu_cop)} COP |
| Valor Total | ${formatearPeso(item.total_cop)} COP |
| Tipo | ${item.tipo} |
| Cap√≠tulo | ${item.capitulo} |

---

## 2. CRITERIO T√âCNICO

### Justificaci√≥n:
${criterio.criterio_tecnico.justificacion}

### C√°lculo Detallado:
${criterio.criterio_tecnico.calculo_detallado}

### Desglose:
${criterio.criterio_tecnico.desglose ? criterio.criterio_tecnico.desglose.map((d, i) => `${i + 1}. ${d}`).join('\n') : '_No aplica_'}

---

## 3. FUENTES Y REFERENCIAS

### Normativa Aplicable:
${criterio.criterio_tecnico.fuente_normativa}

### Fuente de Dise√±o:
${criterio.criterio_tecnico.fuente_diseno}

### Documentos de Referencia:
${criterio.criterio_tecnico.documentos_referencia ? criterio.criterio_tecnico.documentos_referencia.map(d => `- ${d}`).join('\n') : '_No documentado_'}

---

## 4. RESTRICCIONES Y L√çMITES

${criterio.criterio_tecnico.restriccion}

---

## 5. ALTERNATIVAS T√âCNICAS

${criterio.criterio_tecnico.alternativas ? criterio.criterio_tecnico.alternativas.map((alt, i) => `
### Alternativa ${i + 1}:
${alt}
`).join('\n') : '_No se han evaluado alternativas_'}

---

## 6. RIESGOS ASOCIADOS

${criterio.riesgos_asociados && criterio.riesgos_asociados.length > 0 ? criterio.riesgos_asociados.map(r => `
### ${r.id}
**Descripci√≥n:** ${r.descripcion}  
**Probabilidad:** ${r.probabilidad}  
**Impacto:** ${r.impacto}  
**Estrategia de mitigaci√≥n:** ${r.estrategia}  
`).join('\n') : '_No se han identificado riesgos espec√≠ficos para este √≠tem_'}

---

**Generado desde:** WBS Interactiva v4.0  
**Fecha generaci√≥n:** ${fecha}  
**Formato:** Markdown  
`;
            
            // Descargar archivo
            const blob = new Blob([contenidoMD], {type: 'text/markdown;charset=utf-8'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `CRITERIO_TECNICO_${codigo.replace(/\./g, '-')}_${fecha}.md`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert(`‚úÖ Criterio t√©cnico descargado\\n\\nArchivo: CRITERIO_TECNICO_${codigo.replace(/\\./g, '-')}_${fecha}.md\\n\\nContiene:\\n- Justificaci√≥n completa\\n- C√°lculo detallado\\n- Desglose\\n- Fuentes normativas\\n- Documentos de referencia\\n- Alternativas\\n- Riesgos`);
        }

        function solicitarCriterioTecnico(codigo) {
            const item = wbsData.items.find(i => i.codigo === codigo);
            
            if (confirm(`Solicitar documentaci√≥n de criterio t√©cnico para:\\n\\n${codigo} - ${item.descripcion}\\n\\n¬øGenerar solicitud?`)) {
                const fecha = new Date().toISOString().split('T')[0];
                const solicitudMD = `# SOLICITUD DE DOCUMENTACI√ìN - CRITERIO T√âCNICO
## √çtem ${codigo} - ${item.descripcion}

**Fecha solicitud:** ${fecha}  
**Solicitante:** Usuario WBS Interactiva  

---

## √çTEM SOLICITADO

- **C√≥digo WBS:** ${codigo}
- **Descripci√≥n:** ${item.descripcion}
- **Cantidad actual:** ${item.cantidad} ${item.unidad}
- **Total:** ${formatearPeso(item.total_cop)} COP

---

## INFORMACI√ìN REQUERIDA

### 1. Justificaci√≥n t√©cnica:
¬øPor qu√© se estableci√≥ esta cantidad espec√≠fica (${item.cantidad} ${item.unidad})?

### 2. C√°lculo detallado:
¬øC√≥mo se calcul√≥ este valor? (F√≥rmula, criterios, normas)

### 3. Desglose (si aplica):
¬øCu√°l es la composici√≥n detallada?

### 4. Fuentes normativas:
¬øQu√© normas o est√°ndares aplican?

### 5. Documentos de referencia:
¬øEn qu√© documentos se encuentra el detalle?

### 6. Restricciones:
¬øCu√°les son los l√≠mites m√≠nimos/m√°ximos permitidos?

### 7. Alternativas:
¬øSe evaluaron otras opciones?

---

## PR√ìXIMOS PASOS

- [ ] Especialista completa informaci√≥n
- [ ] PMO revisa y aprueba
- [ ] Se agrega a: criterios_tecnicos_base.json
- [ ] Se actualiza WBS Interactiva

---

**Generado desde:** WBS Interactiva v4.0  
**Archivo:** SOLICITUD_CRITERIO_${codigo.replace(/\./g, '-')}_${fecha}.md  
`;
                
                // Descargar solicitud
                const blob = new Blob([solicitudMD], {type: 'text/markdown;charset=utf-8'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `SOLICITUD_CRITERIO_${codigo.replace(/\./g, '-')}_${fecha}.md`;
                a.click();
                URL.revokeObjectURL(url);
                
                alert(`‚úÖ Solicitud generada\\n\\nEnviar a especialista para que documente el criterio t√©cnico.`);
            }
        }

        function mostrarDocumentosReferencia(codigo) {
            const criterio = criteriosTecnicos[codigo];
            
            if (!criterio || !criterio.criterio_tecnico.documentos_referencia) {
                alert('‚ö†Ô∏è No hay documentos de referencia disponibles');
                return;
            }
            
            const docs = criterio.criterio_tecnico.documentos_referencia;
            let mensaje = `üìö DOCUMENTOS DE REFERENCIA\\n\\n√çtem ${codigo}:\\n\\n`;
            docs.forEach((doc, i) => {
                mensaje += `${i + 1}. ${doc}\\n`;
            });
            mensaje += `\\nüí° Consulta estos documentos para mayor detalle.`;
            
            alert(mensaje);
        }

        function cargarDatosDemo() {
            // Fallback si no se carga el JSON
            wbsData = {
                items: [
                    {codigo: "1.1.100", descripcion: "Servidores CTC principales", cantidad: 2, vu_cop: 180000000, total_cop: 360000000, modificable: true, capitulo: "1", unidad: "UND", tipo: "SUMINISTRO"}
                ]
            };
            procesarYCargarWBS();
        }

        // Cerrar modal al hacer clic fuera
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
    </script>
</body>
</html>

