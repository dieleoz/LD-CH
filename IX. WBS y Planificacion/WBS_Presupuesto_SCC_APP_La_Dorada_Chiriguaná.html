<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WBS Presupuesto SCC - APP La Dorada-Chiriguan√°</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 10px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            body {
                padding: 5px;
            }
            
            .container {
                border-radius: 8px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 22px;
            }
            
            .content {
                padding: 20px;
            }
            
            .controls {
                flex-direction: column;
                gap: 10px;
            }
            
            .controls button {
                padding: 10px 15px;
                font-size: 14px;
            }
            
            table {
                font-size: 11px;
            }
            
            .budget-table th,
            .budget-table td {
                padding: 6px 4px;
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 18px;
            }
            
            .content {
                padding: 15px;
            }
            
            .controls button {
                padding: 8px 12px;
                font-size: 12px;
            }
            
            .budget-table {
                font-size: 10px;
            }
            
            .budget-table th,
            .budget-table td {
                padding: 4px 2px;
            }
        }
        
        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .controls {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
        }
        
        .filter-group {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-left: auto;
        }
        
        .filter-group label {
            font-size: 14px;
            font-weight: 500;
            color: #495057;
        }
        
        .filter-group select {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .table-container {
            overflow-x: auto;
            max-height: 600px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        thead th {
            background: #343a40;
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            border-right: 1px solid #495057;
        }
        
        tbody tr {
            border-bottom: 1px solid #dee2e6;
        }
        
        tbody tr:hover {
            background: #f8f9fa;
        }
        
        tbody td {
            padding: 10px 8px;
            border-right: 1px solid #dee2e6;
        }
        
        .nivel-1 {
            background: #e3f2fd;
            font-weight: 700;
            font-size: 14px;
            color: #1565c0;
        }
        
        .nivel-2 {
            background: #f1f8e9;
            font-weight: 600;
            padding-left: 20px !important;
            color: #558b2f;
        }
        
        .nivel-3 {
            padding-left: 40px !important;
        }
        
        .tipo-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .subtotal-row {
            background: #fff3cd !important;
            font-weight: bold;
        }
        
        .subtotal-row td {
            border-top: 2px solid #ffc107 !important;
            border-bottom: 2px solid #ffc107 !important;
        }
        
        .total-row {
            background: #28a745 !important;
            font-weight: bold;
            font-size: 16px;
        }
        
        .total-row td {
            border-top: 3px solid #1e7e34 !important;
            border-bottom: 3px solid #1e7e34 !important;
            color: white !important;
        }
        
        .tipo-OBRA {
            background: #fff3cd;
            color: #856404;
        }
        
        .tipo-SUMINISTRO {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .tipo-SERVICIO {
            background: #d4edda;
            color: #155724;
        }
        
        .stats {
            padding: 20px 30px;
            background: #f8f9fa;
            border-top: 1px solid #dee2e6;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .stat-card h3 {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stat-card p {
            font-size: 24px;
            font-weight: 700;
            color: #212529;
        }
        
        .icon {
            width: 18px;
            height: 18px;
        }
        
        .empty-cell {
            color: #adb5bd;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä WBS PRESUPUESTO SISTEMA DE COMUNICACIONES Y CONTROL</h1>
            <p>APP La Dorada-Chiriguan√° | UF-2.2 | Versi√≥n 3.4 (Actualizada 08/10/2025)</p>
            <div style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 6px; padding: 15px; margin: 15px 0;">
                <h3 style="color: #155724; margin-bottom: 10px;">‚úÖ WBS ACTUALIZADA v3.0 - CAMBIOS T√âCNICOS APLICADOS</h3>
                <p style="color: #155724; margin: 5px 0;"><strong>DT-CTC-003:</strong> Software CTC + ETCS L2 + FENOCO (+$79,352M) ‚≠ê</p>
                <p style="color: #155724; margin: 5px 0;"><strong>DT-SCADA (3 DTs):</strong> Software, Servidores, Interfaces L2/L3 (+$9,212M)</p>
                <p style="color: #155724; margin: 5px 0;"><strong>DT-TETRA-001:</strong> ATP 15‚Üí8 UND (-$7,480M)</p>
                <p style="color: #155724; margin: 5px 0;"><strong>Total incremento neto:</strong> +$89,084,588,766 COP (+56.0%)</p>
            </div>
        </div>
        
        <div class="controls">
            <button class="btn btn-success" onclick="exportarExcel()">
                <svg class="icon" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"/>
                </svg>
                Exportar a Excel
            </button>
            
            <button class="btn btn-primary" onclick="mostrarDesglose()">
                <svg class="icon" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                Ver Desglose AIU
            </button>
            
            <button class="btn btn-info" onclick="generarActaObra()" style="background: #17a2b8;">
                <svg class="icon" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                    <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"/>
                </svg>
                Ver Acta de Obra
            </button>
            
            <button class="btn btn-warning" onclick="validarCapitulo4()">
                <svg class="icon" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                </svg>
                Validar Cap. 4
            </button>
            <button class="btn btn-danger" onclick="validarCalculos()">
                <svg class="icon" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z" clip-rule="evenodd"/>
                </svg>
                Validar C√°lculos
            </button>
            <button class="btn btn-info" onclick="imprimirPDF()">
                <svg class="icon" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v3a2 2 0 002 2h1v2a2 2 0 002 2h6a2 2 0 002-2v-2h1a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z" clip-rule="evenodd"/>
                </svg>
                Imprimir PDF
            </button>
            
            <div class="filter-group">
                <label for="filtroTipo">Filtrar por tipo:</label>
                <select id="filtroTipo" onchange="filtrarPorTipo()">
                    <option value="TODOS">Todos</option>
                    <option value="OBRA">Obra Civil</option>
                    <option value="SUMINISTRO">Suministros</option>
                    <option value="SERVICIO">Servicios</option>
                </select>
            </div>
        </div>
        
        <div class="table-container">
            <table id="wbsTable">
                <thead>
                    <tr>
                        <th style="width: 80px;">√çTEM</th>
                        <th style="width: 400px;">DESCRIPCI√ìN</th>
                        <th style="width: 120px;">TIPO</th>
                        <th style="width: 80px;">UNIDAD</th>
                        <th style="width: 100px;">CANTIDAD</th>
                        <th style="width: 120px;">VU (COP)</th>
                        <th style="width: 120px;">TOTAL (COP)</th>
                        <th style="width: 120px;">TOTAL (USD)</th>
                    </tr>
                </thead>
                <tbody id="wbsBody">
                </tbody>
            </table>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <h3>Total √çtems</h3>
                <p id="totalItems">-</p>
            </div>
            <div class="stat-card" style="border-color: #856404;">
                <h3>√çtems Obra Civil</h3>
                <p id="totalObra">-</p>
            </div>
            <div class="stat-card" style="border-color: #0c5460;">
                <h3>√çtems Suministros</h3>
                <p id="totalSuministro">-</p>
            </div>
            <div class="stat-card" style="border-color: #155724;">
                <h3>√çtems Servicios</h3>
                <p id="totalServicio">-</p>
            </div>
        </div>
    </div>

    <!-- Cargar datos sincronizados desde fuente √∫nica (Mejora v14.7.4) -->
    <script src="datos_wbs_TODOS_items.js?v=20251012"></script>
    
    <script>
        // Convertir datos de WBS Completa a formato WBS Presupuestal
        let wbsData = [];
        
        if (typeof window.datos_wbs !== 'undefined' && window.datos_wbs.items) {
            // Transformar formato de datos_wbs_TODOS_items.js a formato presupuestal
            wbsData = window.datos_wbs.items.map(item => {
                // Determinar nivel basado en el c√≥digo (ej: "1.1.100" = nivel 3)
                const nivel = item.codigo.split('.').length;
                
                return {
                    nivel: nivel,
                    item: item.codigo,
                    descripcion: item.descripcion,
                    unidad: item.unidad || "",
                    cantidad: item.cantidad || "",
                    vu: item.vu_cop ? item.vu_cop.toLocaleString('es-CO') : "",
                    total: item.total_cop ? item.total_cop.toLocaleString('es-CO') : "",
                    tipo: item.tipo || ""
                };
            });
            
            console.log('‚úÖ Datos cargados desde datos_wbs_TODOS_items.js:', wbsData.length, 'items');
            console.log('üìÖ √öltima actualizaci√≥n WBS:', window.datos_wbs.fecha_actualizacion);
        } else {
            console.warn('‚ö†Ô∏è No se pudo cargar datos_wbs_TODOS_items.js, usando datos hardcoded');
            wbsData = [
            // CAP√çTULO 1: FIBRA √ìPTICA (Datos de respaldo)
            {nivel: 1, item: "1", descripcion: "FIBRA √ìPTICA", unidad: "", cantidad: "", vu: "", total: "", tipo: ""},
            {nivel: 2, item: "1.1", descripcion: "SUMINISTROS", unidad: "", cantidad: "", vu: "", total: "", tipo: ""},
            {nivel: 3, item: "1.1.1", descripcion: "Cable FO LPOC03120484ZC - 48 fibras G.652D", unidad: "km", cantidad: "594", vu: "9,811,013", total: "5,827,741,722", tipo: "SUMINISTRO"},
            {nivel: 3, item: "1.1.2", descripcion: "Empalmes y conectores", unidad: "GL", cantidad: "1", vu: "150,000,000", total: "150,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "1.1.3", descripcion: "Cajas de empalme y distribuci√≥n 80x80", unidad: "UND", cantidad: "2,068", vu: "1,350,000", total: "2,791,800,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "1.1.4", descripcion: "Tritubo 40mm (11/4) RDE 13.6 R√≠gido - Rollos x 400m", unidad: "ROLLO", cantidad: "1,485", vu: "15,845", total: "23,529,825", tipo: "SUMINISTRO"},
            {nivel: 3, item: "1.1.5", descripcion: "Uniones r√°pidas 40mm (1-1/4) - 3 v√≠as", unidad: "UND", cantidad: "6,204", vu: "35,000", total: "217,140,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "1.1.6", descripcion: "Equipos terminales de fibra (ODF)", unidad: "UND", cantidad: "8", vu: "25,000,000", total: "200,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "1.1.7", descripcion: "Fusionadoras de fibra √≥ptica (principal + respaldo)", unidad: "UND", cantidad: "2", vu: "50,000,000", total: "100,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "1.1.8", descripcion: "OTDR (Reflect√≥metro) - principal + respaldo", unidad: "UND", cantidad: "2", vu: "30,000,000", total: "60,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "1.1.9", descripcion: "Muflas para fusionado (6,600 + 10% repuesto)", unidad: "UND", cantidad: "7,260", vu: "25,000", total: "181,500,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "1.1.10", descripcion: "Insumos para fusionado (6,600 fusiones)", unidad: "GL", cantidad: "1", vu: "99,000,000", total: "99,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "1.1.11", descripcion: "Fibra repuesto (10% de 594 km)", unidad: "km", cantidad: "59.4", vu: "9,811,013", total: "582,774,172", tipo: "SUMINISTRO"},
            {nivel: 3, item: "1.1.12", descripcion: "Tritubo repuesto (5% de 1,485 rollos)", unidad: "ROLLO", cantidad: "74", vu: "15,845", total: "1,172,530", tipo: "SUMINISTRO"},
            {nivel: 3, item: "1.1.13", descripcion: "Cajas repuesto (5% de 2,068)", unidad: "UND", cantidad: "104", vu: "1,350,000", total: "140,400,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "1.1.14", descripcion: "Uniones repuesto (5% de 6,204)", unidad: "UND", cantidad: "310", vu: "35,000", total: "10,850,000", tipo: "SUMINISTRO"},
            {nivel: 2, item: "1.2", descripcion: "OBRA CIVIL", unidad: "", cantidad: "", vu: "", total: "", tipo: ""},
            {nivel: 3, item: "1.2.1", descripcion: "Mano de obra zanja 70cm√ó40cm + instalaci√≥n fibra", unidad: "km", cantidad: "594", vu: "90,188,987", total: "53,572,258,278", tipo: "OBRA"},
            {nivel: 2, item: "1.3", descripcion: "SERVICIOS", unidad: "", cantidad: "", vu: "", total: "", tipo: ""},
            {nivel: 3, item: "1.3.1", descripcion: "Instalaci√≥n y tendido de cable", unidad: "km", cantidad: "594", vu: "800,000", total: "475,200,000", tipo: "SERVICIO"},
            {nivel: 3, item: "1.3.2", descripcion: "Fusi√≥n y certificaci√≥n de enlaces (6,600 fusiones)", unidad: "UND", cantidad: "6,600", vu: "25,000", total: "165,000,000", tipo: "SERVICIO"},
            {nivel: 3, item: "1.3.3", descripcion: "Pruebas OTDR y documentaci√≥n", unidad: "GL", cantidad: "1", vu: "50,000,000", total: "50,000,000", tipo: "SERVICIO"},

            // CAP√çTULO 2: SISTEMA DE ENERG√çA Y RESPALDO (CCO + ESTACIONES ENCE + TALLERES + PASOS A NIVEL)
            {nivel: 1, item: "2", descripcion: "SISTEMA DE ENERG√çA Y RESPALDO (CCO + ESTACIONES ENCE + TALLERES + PASOS A NIVEL)", unidad: "", cantidad: "", vu: "", total: "", tipo: ""},
            {nivel: 2, item: "2.1", descripcion: "SUMINISTROS ENERG√çA NO-TETRA", unidad: "", cantidad: "", vu: "", total: "", tipo: ""},
            {nivel: 3, item: "2.1.1", descripcion: "UPS/SAI para CCO (1)", unidad: "UND", cantidad: "1", vu: "100,000,000", total: "100,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "2.1.2", descripcion: "UPS/SAI para 5 estaciones ENCE", unidad: "UND", cantidad: "5", vu: "50,000,000", total: "250,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "2.1.3", descripcion: "UPS/SAI para 2 talleres", unidad: "UND", cantidad: "2", vu: "40,000,000", total: "80,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "2.1.4", descripcion: "UPS/SAI para 24 pasos a nivel equipados", unidad: "UND", cantidad: "24", vu: "15,000,000", total: "360,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "2.1.5", descripcion: "Banco de bater√≠as CCO", unidad: "UND", cantidad: "1", vu: "50,000,000", total: "50,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "2.1.6", descripcion: "Plantas el√©ctricas de respaldo CCO", unidad: "UND", cantidad: "2", vu: "80,000,000", total: "160,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "2.1.7", descripcion: "Sistema de transferencia autom√°tica", unidad: "UND", cantidad: "32", vu: "15,000,000", total: "480,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "2.1.8", descripcion: "Tableros el√©ctricos principales", unidad: "UND", cantidad: "32", vu: "20,000,000", total: "640,000,000", tipo: "SUMINISTRO"},
            {nivel: 2, item: "2.2", descripcion: "OBRA CIVIL ENERG√çA", unidad: "", cantidad: "", vu: "", total: "", tipo: ""},
            {nivel: 3, item: "2.2.1", descripcion: "Sala de equipos el√©ctricos CCO", unidad: "m¬≤", cantidad: "100", vu: "3,000,000", total: "300,000,000", tipo: "OBRA"},
            {nivel: 3, item: "2.2.2", descripcion: "Cimentaciones plantas el√©ctricas", unidad: "UND", cantidad: "3", vu: "20,000,000", total: "60,000,000", tipo: "OBRA"},
            {nivel: 3, item: "2.2.3", descripcion: "Acometidas el√©ctricas principales", unidad: "UND", cantidad: "8", vu: "15,000,000", total: "120,000,000", tipo: "OBRA"},
            {nivel: 3, item: "2.2.4", descripcion: "Sistema de puesta a tierra", unidad: "GL", cantidad: "1", vu: "80,000,000", total: "80,000,000", tipo: "OBRA"},
            {nivel: 2, item: "2.3", descripcion: "SERVICIOS ENERG√çA", unidad: "", cantidad: "", vu: "", total: "", tipo: ""},
            {nivel: 3, item: "2.3.1", descripcion: "Instalaci√≥n sistemas el√©ctricos", unidad: "GL", cantidad: "1", vu: "150,000,000", total: "150,000,000", tipo: "SERVICIO"},
            {nivel: 3, item: "2.3.2", descripcion: "Puesta en marcha sistemas", unidad: "GL", cantidad: "1", vu: "100,000,000", total: "100,000,000", tipo: "SERVICIO"},
            {nivel: 3, item: "2.3.3", descripcion: "Pruebas de autonom√≠a y respaldo", unidad: "GL", cantidad: "1", vu: "80,000,000", total: "80,000,000", tipo: "SERVICIO"},

            // CAP√çTULO 3: SISTEMAS DE COMUNICACI√ìN TETRA
            {nivel: 1, item: "3", descripcion: "SISTEMAS DE COMUNICACI√ìN TETRA", unidad: "", cantidad: "", vu: "", total: "", tipo: ""},
            {nivel: 2, item: "3.1", descripcion: "SUMINISTROS TETRA", unidad: "", cantidad: "", vu: "", total: "", tipo: ""},
            {nivel: 3, item: "3.1.1", descripcion: "Torres autosoportadas 40-60m (37 estaciones)", unidad: "UND", cantidad: "37", vu: "250,000,000", total: "9,250,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "3.1.2", descripcion: "Estaciones base TETRA", unidad: "UND", cantidad: "37", vu: "80,000,000", total: "2,960,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "3.1.3", descripcion: "Antenas TETRA", unidad: "UND", cantidad: "37", vu: "15,000,000", total: "555,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "3.1.4", descripcion: "UPS/SAI 3kVA", unidad: "UND", cantidad: "37", vu: "25,000,000", total: "925,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "3.1.5", descripcion: "Bater√≠as VRLA", unidad: "UND", cantidad: "37", vu: "12,000,000", total: "444,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "3.1.6", descripcion: "Radios punto a punto 1GB", unidad: "UND", cantidad: "74", vu: "120,000,000", total: "8,880,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "3.1.7", descripcion: "Antenas parab√≥licas", unidad: "UND", cantidad: "74", vu: "25,000,000", total: "1,850,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "3.1.8", descripcion: "Radios TETRA embarcados (locomotoras)", unidad: "UND", cantidad: "30", vu: "45,000,000", total: "1,350,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "3.1.9", descripcion: "Antenas embarcadas", unidad: "UND", cantidad: "30", vu: "8,000,000", total: "240,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "3.1.10", descripcion: "Radios port√°tiles TETRA", unidad: "UND", cantidad: "80", vu: "8,000,000", total: "640,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "3.1.11", descripcion: "Consolas de despacho CCO", unidad: "UND", cantidad: "3", vu: "80,000,000", total: "240,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "3.1.12", descripcion: "Sistema de control TETRA centralizado", unidad: "GL", cantidad: "1", vu: "150,000,000", total: "150,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "3.1.13", descripcion: "Repuestos TETRA (10%)", unidad: "GL", cantidad: "1", vu: "1,444,000,000", total: "1,444,000,000", tipo: "SUMINISTRO"},
            {nivel: 2, item: "3.2", descripcion: "OBRA CIVIL TETRA", unidad: "", cantidad: "", vu: "", total: "", tipo: ""},
            {nivel: 3, item: "3.2.1", descripcion: "Casetas t√©cnicas 6√ó4√ó3m", unidad: "UND", cantidad: "37", vu: "65,000,000", total: "2,405,000,000", tipo: "OBRA"},
            {nivel: 3, item: "3.2.2", descripcion: "Cimentaciones torres", unidad: "UND", cantidad: "37", vu: "25,000,000", total: "925,000,000", tipo: "OBRA"},
            {nivel: 3, item: "3.2.3", descripcion: "Cerramiento perimetral", unidad: "UND", cantidad: "37", vu: "30,000,000", total: "1,110,000,000", tipo: "OBRA"},
            {nivel: 3, item: "3.2.4", descripcion: "V√≠as de acceso", unidad: "UND", cantidad: "37", vu: "25,000,000", total: "925,000,000", tipo: "OBRA"},
            {nivel: 3, item: "3.2.5", descripcion: "Sistemas de seguridad", unidad: "UND", cantidad: "37", vu: "20,000,000", total: "740,000,000", tipo: "OBRA"},
            {nivel: 2, item: "3.3", descripcion: "SERVICIOS TETRA", unidad: "", cantidad: "", vu: "", total: "", tipo: ""},
            {nivel: 3, item: "3.3.1", descripcion: "Montaje e instalaci√≥n torres", unidad: "UND", cantidad: "37", vu: "15,000,000", total: "555,000,000", tipo: "SERVICIO"},
            {nivel: 3, item: "3.3.2", descripcion: "Instalaci√≥n equipos TETRA", unidad: "UND", cantidad: "37", vu: "12,000,000", total: "444,000,000", tipo: "SERVICIO"},
            {nivel: 3, item: "3.3.3", descripcion: "Configuraci√≥n red TETRA", unidad: "GL", cantidad: "1", vu: "200,000,000", total: "200,000,000", tipo: "SERVICIO"},
            {nivel: 3, item: "3.3.4", descripcion: "Pruebas cobertura y calidad", unidad: "GL", cantidad: "1", vu: "150,000,000", total: "150,000,000", tipo: "SERVICIO"},
            {nivel: 3, item: "3.3.5", descripcion: "Capacitaci√≥n operadores", unidad: "GL", cantidad: "1", vu: "100,000,000", total: "100,000,000", tipo: "SERVICIO"},


            // CAP√çTULO 4: SISTEMA DE CONTROL Y SE√ëALIZACI√ìN VIRTUAL + INTEROPERABILIDAD FENOCO
            {nivel: 1, item: "4", descripcion: "SISTEMA DE CONTROL Y SE√ëALIZACI√ìN VIRTUAL + INTEROPERABILIDAD FENOCO", unidad: "", cantidad: "", vu: "", total: "", tipo: ""},
            
            // A. EQUIPAMIENTO 15 LOCOMOTORAS (TUS OBLIGACIONES CONTRACTUALES)
            {nivel: 2, item: "4.1", descripcion: "EQUIPAMIENTO 15 LOCOMOTORAS INTEROPERABILIDAD", unidad: "", cantidad: "", vu: "", total: "", tipo: ""},
            {nivel: 3, item: "4.1.1", descripcion: "Sistema Control Propio LD-CH (15 locomotoras)", unidad: "GL", cantidad: "1", vu: "1,200,000,000", total: "1,200,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "4.1.2", descripcion: "ITCS OBC FENOCO (15 locomotoras)", unidad: "UND", cantidad: "15", vu: "80,000,000", total: "1,200,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "4.1.3", descripcion: "Display dual integrado (15 locomotoras)", unidad: "UND", cantidad: "15", vu: "35,000,000", total: "525,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "4.1.4", descripcion: "GPS dual ambos sistemas (15 locomotoras)", unidad: "UND", cantidad: "30", vu: "8,000,000", total: "240,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "4.1.5", descripcion: "Radio TETRA dual (15 locomotoras)", unidad: "UND", cantidad: "30", vu: "45,000,000", total: "1,350,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "4.1.6", descripcion: "Interface frenos com√∫n (15 locomotoras)", unidad: "UND", cantidad: "15", vu: "25,000,000", total: "375,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "4.1.7", descripcion: "Registrador jur√≠dico (15 locomotoras)", unidad: "UND", cantidad: "15", vu: "18,000,000", total: "270,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "4.1.8", descripcion: "Switch selector modo (15 locomotoras)", unidad: "UND", cantidad: "15", vu: "5,000,000", total: "75,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "4.1.9", descripcion: "Base datos LD-CH (licencia)", unidad: "GL", cantidad: "1", vu: "225,000,000", total: "225,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "4.1.10", descripcion: "Base datos FENOCO 246km (licencia)", unidad: "GL", cantidad: "1", vu: "300,000,000", total: "300,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "4.1.11", descripcion: "Software integraci√≥n dual (licencia)", unidad: "GL", cantidad: "1", vu: "450,000,000", total: "450,000,000", tipo: "SUMINISTRO"},
            
            // B. SISTEMA CTC PROPIO LA DORADA-CHIRIGUAN√Å
            {nivel: 2, item: "4.2", descripcion: "SISTEMA CTC PROPIO CCO", unidad: "", cantidad: "", vu: "", total: "", tipo: ""},
            {nivel: 3, item: "4.2.1", descripcion: "Servidores CTC redundantes", unidad: "UND", cantidad: "2", vu: "120,000,000", total: "240,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "4.2.2", descripcion: "Software CTC licencia base", unidad: "GL", cantidad: "1", vu: "800,000,000", total: "800,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "4.2.3", descripcion: "Estaciones trabajo operador", unidad: "UND", cantidad: "6", vu: "25,000,000", total: "150,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "4.2.4", descripcion: "Video wall / displays", unidad: "GL", cantidad: "1", vu: "180,000,000", total: "180,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "4.2.5", descripcion: "Sistema SCADA integrado", unidad: "GL", cantidad: "1", vu: "400,000,000", total: "400,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "4.2.6", descripcion: "Base datos operacional", unidad: "UND", cantidad: "2", vu: "60,000,000", total: "120,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "4.2.7", descripcion: "Servidor aplicaciones", unidad: "UND", cantidad: "2", vu: "80,000,000", total: "160,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "4.2.8", descripcion: "Sistema backup/almacenamiento", unidad: "GL", cantidad: "1", vu: "150,000,000", total: "150,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "4.2.9", descripcion: "Network switches/routers", unidad: "UND", cantidad: "8", vu: "15,000,000", total: "120,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "4.2.10", descripcion: "UPS sala control", unidad: "GL", cantidad: "1", vu: "100,000,000", total: "100,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "4.2.11", descripcion: "Consolas operador ergon√≥micas", unidad: "UND", cantidad: "6", vu: "30,000,000", total: "180,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "4.2.12", descripcion: "Sistema gesti√≥n incidentes", unidad: "GL", cantidad: "1", vu: "120,000,000", total: "120,000,000", tipo: "SUMINISTRO"},
            
            // C. L√ìGICA CONTROL Y APLICACIONES
            {nivel: 2, item: "4.3", descripcion: "L√ìGICA CONTROL Y APLICACIONES", unidad: "", cantidad: "", vu: "", total: "", tipo: ""},
            {nivel: 3, item: "4.3.1", descripcion: "M√≥dulo gesti√≥n autoridades movimiento", unidad: "GL", cantidad: "1", vu: "180,000,000", total: "180,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "4.3.2", descripcion: "Desv√≠os motorizados (25 unidades)", unidad: "UND", cantidad: "25", vu: "95,000,000", total: "2,375,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "4.3.3", descripcion: "Desv√≠os manuales (95 unidades)", unidad: "UND", cantidad: "95", vu: "35,000,000", total: "3,325,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "4.3.4", descripcion: "M√≥dulo TSR (Speed Restrictions)", unidad: "GL", cantidad: "1", vu: "100,000,000", total: "100,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "4.3.5", descripcion: "Sistema tracking GPS tiempo real", unidad: "GL", cantidad: "1", vu: "200,000,000", total: "200,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "4.3.6", descripcion: "M√≥dulo detecci√≥n conflictos", unidad: "GL", cantidad: "1", vu: "120,000,000", total: "120,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "4.3.7", descripcion: "Sistema gesti√≥n zonas trabajo", unidad: "GL", cantidad: "1", vu: "80,000,000", total: "80,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "4.3.8", descripcion: "Interface comunicaci√≥n trenes", unidad: "GL", cantidad: "1", vu: "150,000,000", total: "150,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "4.3.9", descripcion: "Sistema alarmas y eventos", unidad: "GL", cantidad: "1", vu: "100,000,000", total: "100,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "4.3.10", descripcion: "Registrador eventos (5 a√±os)", unidad: "GL", cantidad: "1", vu: "120,000,000", total: "120,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "4.3.11", descripcion: "Software an√°lisis operacional", unidad: "GL", cantidad: "1", vu: "100,000,000", total: "100,000,000", tipo: "SUMINISTRO"},
            
            // D. GATEWAY INTEROPERABILIDAD
            {nivel: 2, item: "4.4", descripcion: "GATEWAY INTEROPERABILIDAD FENOCO", unidad: "", cantidad: "", vu: "", total: "", tipo: ""},
            {nivel: 3, item: "4.4.1", descripcion: "Gateway API CTC ‚Üî ITCS", unidad: "GL", cantidad: "1", vu: "350,000,000", total: "350,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "4.4.2", descripcion: "Servidor interfaz redundante", unidad: "UND", cantidad: "2", vu: "100,000,000", total: "200,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "4.4.3", descripcion: "Protocolo comunicaci√≥n est√°ndar", unidad: "GL", cantidad: "1", vu: "250,000,000", total: "250,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "4.4.4", descripcion: "Middleware integraci√≥n", unidad: "GL", cantidad: "1", vu: "180,000,000", total: "180,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "4.4.5", descripcion: "Sistema autenticaci√≥n segura", unidad: "GL", cantidad: "1", vu: "120,000,000", total: "120,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "4.4.6", descripcion: "Firewall/seguridad cibern√©tica", unidad: "GL", cantidad: "1", vu: "150,000,000", total: "150,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "4.4.7", descripcion: "Sistema monitoreo interfaz", unidad: "GL", cantidad: "1", vu: "100,000,000", total: "100,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "4.4.8", descripcion: "Logs transacciones auditor√≠a", unidad: "GL", cantidad: "1", vu: "80,000,000", total: "80,000,000", tipo: "SUMINISTRO"},
            
            // E. ENCLAVAMIENTOS ELECTR√ìNICOS (5 ESTACIONES)
            {nivel: 2, item: "4.5", descripcion: "ENCLAVAMIENTOS ELECTR√ìNICOS (5 ESTACIONES)", unidad: "", cantidad: "", vu: "", total: "", tipo: ""},
            {nivel: 3, item: "4.5.1", descripcion: "Interlocking Controller vital (5 estaciones)", unidad: "UND", cantidad: "5", vu: "250,000,000", total: "1,250,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "4.5.2", descripcion: "Panel control local LCP (5 estaciones)", unidad: "UND", cantidad: "5", vu: "50,000,000", total: "250,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "4.5.3", descripcion: "M√≥dulos I/O campo (5 estaciones)", unidad: "UND", cantidad: "5", vu: "80,000,000", total: "400,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "4.5.4", descripcion: "Switch machines el√©ctricos (8 por estaci√≥n)", unidad: "UND", cantidad: "40", vu: "28,000,000", total: "1,120,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "4.5.5", descripcion: "Circuitos v√≠a detecci√≥n (10 por estaci√≥n)", unidad: "UND", cantidad: "50", vu: "15,000,000", total: "750,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "4.5.6", descripcion: "Cableado se√±alizaci√≥n completo (5 estaciones)", unidad: "GL", cantidad: "5", vu: "60,000,000", total: "300,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "4.5.7", descripcion: "Casetas equipos 4x4m (5 estaciones)", unidad: "UND", cantidad: "5", vu: "90,000,000", total: "450,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "4.5.8", descripcion: "Software l√≥gica interlocking (5 licencias)", unidad: "GL", cantidad: "5", vu: "120,000,000", total: "600,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "4.5.9", descripcion: "Ingenier√≠a aplicaci√≥n espec√≠fica (5 estaciones)", unidad: "GL", cantidad: "5", vu: "100,000,000", total: "500,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "4.5.10", descripcion: "Pruebas SAT + certificaci√≥n (5 estaciones)", unidad: "GL", cantidad: "5", vu: "80,000,000", total: "400,000,000", tipo: "SUMINISTRO"},
            
            // F. PASOS A NIVEL ACTIVOS (14 Tipo B + 9 Tipo C = 23)
            {nivel: 2, item: "4.6", descripcion: "PASOS A NIVEL ACTIVOS (23)", unidad: "", cantidad: "", vu: "", total: "", tipo: ""},
            {nivel: 3, item: "4.6.1", descripcion: "Controlador XP4/similar (23 PAN)", unidad: "UND", cantidad: "23", vu: "22,000,000", total: "506,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "4.6.2", descripcion: "Flashers LED (14B√ó2 + 9C√ó4 = 64)", unidad: "UND", cantidad: "64", vu: "5,000,000", total: "320,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "4.6.3", descripcion: "Bells (14B√ó1 + 9C√ó2 = 32)", unidad: "UND", cantidad: "32", vu: "4,000,000", total: "128,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "4.6.4", descripcion: "Gates motorizados (9C√ó2 = 18)", unidad: "UND", cantidad: "18", vu: "18,000,000", total: "324,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "4.6.5", descripcion: "Circuitos aproximaci√≥n CWT (23 PAN)", unidad: "UND", cantidad: "23", vu: "10,000,000", total: "230,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "4.6.6", descripcion: "Casetas 6√ó6 equipadas (23 PAN)", unidad: "UND", cantidad: "23", vu: "50,000,000", total: "1,150,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "4.6.7", descripcion: "Cableado completo (23 PAN)", unidad: "UND", cantidad: "23", vu: "16,000,000", total: "372,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "4.6.8", descripcion: "Se√±alizaci√≥n vial (23 PAN)", unidad: "UND", cantidad: "23", vu: "11,000,000", total: "248,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "4.6.9", descripcion: "UPS y respaldo (23 PAN)", unidad: "UND", cantidad: "23", vu: "12,000,000", total: "276,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "4.6.10", descripcion: "Instalaci√≥n y comisionamiento (23 PAN)", unidad: "UND", cantidad: "23", vu: "20,000,000", total: "450,000,000", tipo: "SUMINISTRO"},
            
            // G. OBRA CIVIL
            {nivel: 2, item: "4.7", descripcion: "OBRA CIVIL", unidad: "", cantidad: "", vu: "", total: "", tipo: ""},
            {nivel: 3, item: "4.7.1", descripcion: "Centro de Control Operativo (CCO)", unidad: "m¬≤", cantidad: "850", vu: "3,000,000", total: "2,550,000,000", tipo: "OBRA"},
            {nivel: 3, item: "4.7.2", descripcion: "Sala de servidores y comunicaciones", unidad: "m¬≤", cantidad: "250", vu: "2,500,000", total: "625,000,000", tipo: "OBRA"},
            {nivel: 3, item: "4.7.3", descripcion: "Departure Test Station (DTS) Chiriguan√°", unidad: "GL", cantidad: "1", vu: "120,000,000", total: "120,000,000", tipo: "OBRA"},
            {nivel: 3, item: "4.7.4", descripcion: "Zona segura temporal punto cambio", unidad: "GL", cantidad: "1", vu: "50,000,000", total: "50,000,000", tipo: "OBRA"},
            {nivel: 3, item: "4.7.5", descripcion: "C√°maras vigilancia punto cambio", unidad: "UND", cantidad: "3", vu: "8,000,000", total: "24,000,000", tipo: "OBRA"},
            
            // H. SERVICIOS
            {nivel: 2, item: "4.8", descripcion: "SERVICIOS", unidad: "", cantidad: "", vu: "", total: "", tipo: ""},
            {nivel: 3, item: "4.8.1", descripcion: "Survey 3 tipos locomotoras", unidad: "GL", cantidad: "3", vu: "50,000,000", total: "150,000,000", tipo: "SERVICIO"},
            {nivel: 3, item: "4.8.2", descripcion: "Dise√±o instalaci√≥n locomotoras", unidad: "GL", cantidad: "3", vu: "40,000,000", total: "120,000,000", tipo: "SERVICIO"},
            {nivel: 3, item: "4.8.3", descripcion: "Instalaci√≥n f√≠sica locomotoras", unidad: "UND", cantidad: "15", vu: "40,000,000", total: "600,000,000", tipo: "SERVICIO"},
            {nivel: 3, item: "4.8.4", descripcion: "Configuraci√≥n software locomotoras", unidad: "UND", cantidad: "15", vu: "35,000,000", total: "525,000,000", tipo: "SERVICIO"},
            {nivel: 3, item: "4.8.5", descripcion: "Pruebas est√°ticas locomotoras", unidad: "UND", cantidad: "15", vu: "25,000,000", total: "375,000,000", tipo: "SERVICIO"},
            {nivel: 3, item: "4.8.6", descripcion: "Pruebas din√°micas LD", unidad: "UND", cantidad: "15", vu: "30,000,000", total: "450,000,000", tipo: "SERVICIO"},
            {nivel: 3, item: "4.8.7", descripcion: "Pruebas territorio FENOCO", unidad: "UND", cantidad: "15", vu: "35,000,000", total: "525,000,000", tipo: "SERVICIO"},
            {nivel: 3, item: "4.8.8", descripcion: "Certificaci√≥n homologaci√≥n", unidad: "GL", cantidad: "1", vu: "250,000,000", total: "250,000,000", tipo: "SERVICIO"},
            {nivel: 3, item: "4.8.9", descripcion: "Capacitaci√≥n maquinistas", unidad: "GL", cantidad: "1", vu: "180,000,000", total: "180,000,000", tipo: "SERVICIO"},
            {nivel: 3, item: "4.8.10", descripcion: "Ingenier√≠a integraci√≥n CTC-ITCS", unidad: "GL", cantidad: "1", vu: "400,000,000", total: "400,000,000", tipo: "SERVICIO"},
            {nivel: 3, item: "4.8.11", descripcion: "Desarrollo protocolo comunicaci√≥n", unidad: "GL", cantidad: "1", vu: "300,000,000", total: "300,000,000", tipo: "SERVICIO"},
            {nivel: 3, item: "4.8.12", descripcion: "Coordinaci√≥n t√©cnica FENOCO (12 meses)", unidad: "GL", cantidad: "1", vu: "180,000,000", total: "180,000,000", tipo: "SERVICIO"},
            {nivel: 3, item: "4.8.13", descripcion: "Pruebas integraci√≥n conjuntas", unidad: "GL", cantidad: "1", vu: "250,000,000", total: "250,000,000", tipo: "SERVICIO"},
            {nivel: 3, item: "4.8.14", descripcion: "Documentaci√≥n t√©cnica interfaz", unidad: "GL", cantidad: "1", vu: "120,000,000", total: "120,000,000", tipo: "SERVICIO"},
            {nivel: 3, item: "4.8.15", descripcion: "Acuerdos operacionales (SLA)", unidad: "GL", cantidad: "1", vu: "100,000,000", total: "100,000,000", tipo: "SERVICIO"},
            {nivel: 3, item: "4.8.16", descripcion: "Plan contingencia operacional", unidad: "GL", cantidad: "1", vu: "80,000,000", total: "80,000,000", tipo: "SERVICIO"},

            // CAP√çTULO 5: SISTEMA CCTV Y SEGURIDAD
            {nivel: 1, item: "5", descripcion: "SISTEMA CCTV Y SEGURIDAD", unidad: "", cantidad: "", vu: "", total: "", tipo: ""},
            {nivel: 2, item: "5.1", descripcion: "SUMINISTROS CCTV", unidad: "", cantidad: "", vu: "", total: "", tipo: ""},
            {nivel: 3, item: "5.1.1", descripcion: "C√°maras CCTV IP (73 unidades)", unidad: "UND", cantidad: "73", vu: "8,000,000", total: "584,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "5.1.2", descripcion: "Sistema grabaci√≥n centralizado", unidad: "GL", cantidad: "1", vu: "120,000,000", total: "120,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "5.1.3", descripcion: "Monitores sala control", unidad: "UND", cantidad: "8", vu: "15,000,000", total: "120,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "5.1.4", descripcion: "Sistema transmisi√≥n fibra", unidad: "GL", cantidad: "1", vu: "80,000,000", total: "80,000,000", tipo: "SUMINISTRO"},
            {nivel: 2, item: "5.2", descripcion: "OBRA CIVIL CCTV", unidad: "", cantidad: "", vu: "", total: "", tipo: ""},
            {nivel: 3, item: "5.2.1", descripcion: "Instalaci√≥n c√°maras CCTV", unidad: "UND", cantidad: "73", vu: "5,000,000", total: "365,000,000", tipo: "OBRA"},
            {nivel: 2, item: "5.3", descripcion: "SERVICIOS CCTV", unidad: "", cantidad: "", vu: "", total: "", tipo: ""},
            {nivel: 3, item: "5.3.1", descripcion: "Configuraci√≥n sistema CCTV", unidad: "GL", cantidad: "1", vu: "60,000,000", total: "60,000,000", tipo: "SERVICIO"},

            // CAP√çTULO 6: SISTEMA DE SEGURIDAD Y PROTECCI√ìN
            {nivel: 1, item: "6", descripcion: "SISTEMA DE SEGURIDAD Y PROTECCI√ìN", unidad: "", cantidad: "", vu: "", total: "", tipo: ""},
            {nivel: 2, item: "6.1", descripcion: "SUMINISTROS", unidad: "", cantidad: "", vu: "", total: "", tipo: ""},
            {nivel: 3, item: "6.1.1", descripcion: "Sistema de Detecci√≥n de Incendios", unidad: "GL", cantidad: "1", vu: "150,000,000", total: "150,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "6.1.2", descripcion: "Sistema de Supresi√≥n de Incendios", unidad: "GL", cantidad: "1", vu: "200,000,000", total: "200,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "6.1.3", descripcion: "Sistema de Control de Acceso", unidad: "GL", cantidad: "1", vu: "100,000,000", total: "100,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "6.1.4", descripcion: "Sistema de Alarma y Notificaci√≥n", unidad: "GL", cantidad: "1", vu: "80,000,000", total: "80,000,000", tipo: "SUMINISTRO"},
            {nivel: 2, item: "6.2", descripcion: "OBRA CIVIL", unidad: "", cantidad: "", vu: "", total: "", tipo: ""},
            {nivel: 3, item: "6.2.1", descripcion: "Instalaci√≥n de sistemas de seguridad", unidad: "GL", cantidad: "1", vu: "120,000,000", total: "120,000,000", tipo: "OBRA"},
            {nivel: 2, item: "6.3", descripcion: "SERVICIOS", unidad: "", cantidad: "", vu: "", total: "", tipo: ""},
            {nivel: 3, item: "6.3.1", descripcion: "Configuraci√≥n y pruebas de sistemas", unidad: "GL", cantidad: "1", vu: "100,000,000", total: "100,000,000", tipo: "SERVICIO"},

            // CAP√çTULO 7: SISTEMA DE MANTENIMIENTO Y SOPORTE
            {nivel: 1, item: "7", descripcion: "SISTEMA DE MANTENIMIENTO Y SOPORTE", unidad: "", cantidad: "", vu: "", total: "", tipo: ""},
            {nivel: 2, item: "7.1", descripcion: "SUMINISTROS", unidad: "", cantidad: "", vu: "", total: "", tipo: ""},
            {nivel: 3, item: "7.1.1", descripcion: "Herramientas especializadas", unidad: "GL", cantidad: "1", vu: "80,000,000", total: "80,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "7.1.2", descripcion: "Equipos de prueba y medici√≥n", unidad: "GL", cantidad: "1", vu: "120,000,000", total: "120,000,000", tipo: "SUMINISTRO"},
            {nivel: 3, item: "7.1.3", descripcion: "Repuestos y componentes", unidad: "GL", cantidad: "1", vu: "200,000,000", total: "200,000,000", tipo: "SUMINISTRO"},
            {nivel: 2, item: "7.2", descripcion: "SERVICIOS", unidad: "", cantidad: "", vu: "", total: "", tipo: ""},
            {nivel: 3, item: "7.2.1", descripcion: "Capacitaci√≥n t√©cnica especializada", unidad: "GL", cantidad: "1", vu: "150,000,000", total: "150,000,000", tipo: "SERVICIO"},
            {nivel: 3, item: "7.2.2", descripcion: "Soporte t√©cnico y mantenimiento", unidad: "GL", cantidad: "1", vu: "300,000,000", total: "300,000,000", tipo: "SERVICIO"},
            {nivel: 3, item: "7.2.3", descripcion: "Documentaci√≥n t√©cnica y manuales", unidad: "GL", cantidad: "1", vu: "100,000,000", total: "100,000,000", tipo: "SERVICIO"}
            ];
        }
        
        console.log('üìä Total items en WBS Presupuestal:', wbsData.length);

        let filteredData = [...wbsData];

        function renderTable() {
            const tbody = document.getElementById('wbsBody');
            tbody.innerHTML = '';

            let currentChapter = '';
            let chapterSubtotal = 0;
            let totalGeneral = 0;
            const TRM = 4400; // Tasa de cambio USD/COP

            // Funci√≥n para convertir string a n√∫mero
            const parseNumber = (str) => {
                if (!str) return 0;
                return parseFloat(str.toString().replace(/,/g, '')) || 0;
            };

            filteredData.forEach((item, index) => {
                // Detectar inicio de nuevo cap√≠tulo
                if (item.nivel === 1 && item.descripcion) {
                    // Agregar subtotal del cap√≠tulo anterior si existe
                    if (currentChapter && chapterSubtotal > 0) {
                        const subtotalRow = document.createElement('tr');
                        subtotalRow.className = 'subtotal-row';
                        subtotalRow.innerHTML = `
                            <td colspan="6" style="text-align: right; font-weight: bold; background: #fff3cd; padding: 10px;">SUBTOTAL ${currentChapter}</td>
                            <td style="text-align: right; font-weight: bold; background: #fff3cd;">$${chapterSubtotal.toLocaleString('es-CO', {maximumFractionDigits: 0})}</td>
                            <td style="text-align: right; font-weight: bold; background: #fff3cd;">$${(chapterSubtotal/TRM).toLocaleString('en-US', {maximumFractionDigits: 0})} USD</td>
                        `;
                        tbody.appendChild(subtotalRow);
                    }
                    
                    // Iniciar nuevo cap√≠tulo
                    currentChapter = item.descripcion;
                    chapterSubtotal = 0;
                }

                const row = document.createElement('tr');
                row.className = `nivel-${item.nivel}`;

                const tipoBadge = item.tipo ? `<span class="tipo-badge tipo-${item.tipo}">${item.tipo}</span>` : '';
                
                // Acumular subtotal solo para items con valores
                if (item.total && parseNumber(item.total) > 0) {
                    chapterSubtotal += parseNumber(item.total);
                    totalGeneral += parseNumber(item.total);
                }

                row.innerHTML = `
                    <td>${item.item}</td>
                    <td>${item.descripcion}</td>
                    <td>${tipoBadge}</td>
                    <td class="${item.unidad ? '' : 'empty-cell'}">${item.unidad || 'N/A'}</td>
                    <td class="${item.cantidad ? '' : 'empty-cell'}">${item.cantidad || 'N/A'}</td>
                    <td class="${item.vu ? '' : 'empty-cell'}">${item.vu ? '$' + parseNumber(item.vu).toLocaleString('es-CO', {maximumFractionDigits: 0}) : 'N/A'}</td>
                    <td class="${item.total ? '' : 'empty-cell'}">${item.total ? '$' + parseNumber(item.total).toLocaleString('es-CO', {maximumFractionDigits: 0}) : 'N/A'}</td>
                    <td class="${item.total ? '' : 'empty-cell'}">${item.total ? '$' + (parseNumber(item.total)/TRM).toLocaleString('en-US', {maximumFractionDigits: 0}) + ' USD' : 'N/A'}</td>
                `;

                tbody.appendChild(row);
            });

            // Agregar subtotal del √∫ltimo cap√≠tulo
            if (currentChapter && chapterSubtotal > 0) {
                const subtotalRow = document.createElement('tr');
                subtotalRow.className = 'subtotal-row';
                subtotalRow.innerHTML = `
                    <td colspan="6" style="text-align: right; font-weight: bold; background: #fff3cd; padding: 10px;">SUBTOTAL ${currentChapter}</td>
                    <td style="text-align: right; font-weight: bold; background: #fff3cd;">$${chapterSubtotal.toLocaleString('es-CO', {maximumFractionDigits: 0})}</td>
                    <td style="text-align: right; font-weight: bold; background: #fff3cd;">$${(chapterSubtotal/TRM).toLocaleString('en-US', {maximumFractionDigits: 0})} USD</td>
                `;
                tbody.appendChild(subtotalRow);
            }

            // Agregar fila de total general
            const totalRow = document.createElement('tr');
            totalRow.className = 'total-row';
            
            // Obtener filtro actual
            const filtroTipo = document.getElementById('filtroTipo').value;
            let totalCalculado = 0;
            let descripcionTotal = 'TOTAL GENERAL (FILTRADO)';
            
            // Calcular total con regla correcta: AIU solo OBRA, IVA sobre SUM+SERV+(5% OBRA)
            let sumaSuministros = 0;
            let sumaObra = 0;
            let sumaServicios = 0;
            
            filteredData.forEach(item => {
                if (item.total && item.tipo) {
                    const valor = parseNumber(item.total);
                    if (item.tipo === 'SUMINISTRO') {
                        sumaSuministros += valor;
                    } else if (item.tipo === 'OBRA') {
                        sumaObra += valor;
                    } else if (item.tipo === 'SERVICIO') {
                        sumaServicios += valor;
                    }
                }
            });
            
            if (filtroTipo === 'TODOS') {
                // CD = SUM + OBRA + SERV
                const cd = sumaSuministros + sumaObra + sumaServicios;
                // AIU = 0.33 √ó OBRA
                const aiu = sumaObra * 0.33;
                // IVA = 0.19 √ó SUM + 0.19 √ó SERV + 0.19 √ó (0.05 √ó OBRA)
                const iva = (sumaSuministros * 0.19) + (sumaServicios * 0.19) + (sumaObra * 0.05 * 0.19);
                totalCalculado = cd + aiu + iva;
                descripcionTotal = `TOTAL GENERAL (CD + AIU solo OBRA + IVA)`;
            } else if (filtroTipo === 'SUMINISTRO') {
                // Suministros: solo IVA 19%
                const iva = sumaSuministros * 0.19;
                totalCalculado = sumaSuministros + iva;
                descripcionTotal = `TOTAL SUMINISTROS - CD: $${sumaSuministros.toLocaleString('es-CO')} + IVA 19%: $${iva.toLocaleString('es-CO')}`;
            } else if (filtroTipo === 'OBRA') {
                // Obra: AIU 33% + IVA sobre utilidad
                const aiu = sumaObra * 0.33;
                const iva = sumaObra * 0.05 * 0.19;
                totalCalculado = sumaObra + aiu + iva;
                descripcionTotal = `TOTAL OBRA - CD: $${sumaObra.toLocaleString('es-CO')} + AIU 33%: $${aiu.toLocaleString('es-CO')} + IVA/Util: $${iva.toLocaleString('es-CO')}`;
            } else if (filtroTipo === 'SERVICIO') {
                // Servicios: IVA 19%
                const iva = sumaServicios * 0.19;
                totalCalculado = sumaServicios + iva;
                descripcionTotal = `TOTAL SERVICIOS - CD: $${sumaServicios.toLocaleString('es-CO')} + IVA 19%: $${iva.toLocaleString('es-CO')}`;
            }
            
            totalRow.innerHTML = `
                <td colspan="6" style="text-align: right; font-weight: bold; background: #28a745; color: white; padding: 15px; font-size: 16px;">${descripcionTotal}</td>
                <td style="text-align: right; font-weight: bold; background: #28a745; color: white; font-size: 16px;">$${totalCalculado.toLocaleString('es-CO', {maximumFractionDigits: 0})}</td>
                <td style="text-align: right; font-weight: bold; background: #28a745; color: white; font-size: 16px;">$${(totalCalculado/TRM).toLocaleString('en-US', {maximumFractionDigits: 0})} USD</td>
            `;
            tbody.appendChild(totalRow);

            updateStats();
        }

        function calcularAIUeIVA() {
            // Funci√≥n para convertir string a n√∫mero
            const parseNumber = (str) => {
                if (!str) return 0;
                return parseFloat(str.toString().replace(/,/g, '')) || 0;
            };

            // Calcular subtotales por cap√≠tulo y tipo
            const subtotales = {};
            
            wbsData.forEach(item => {
                if (item.tipo && item.total) {
                    const capitulo = item.item.split('.')[0];
                    if (!subtotales[capitulo]) {
                        subtotales[capitulo] = { SUMINISTRO: 0, OBRA: 0, SERVICIO: 0 };
                    }
                    subtotales[capitulo][item.tipo] += parseNumber(item.total);
                }
            });
            
            // Calcular AIU e IVA
            let totalCD = 0;
            let totalAIU = 0;
            let totalIVA = 0;
            let totalGeneral = 0;
            let totalSuministros = 0;
            let totalObraCivil = 0;
            let totalServicios = 0;
            const capitulos = {};
            
            Object.keys(subtotales).forEach(capitulo => {
                const cap = subtotales[capitulo];
                
                // Costo Directo = SUM + OBRA + SERV
                const cd = cap.SUMINISTRO + cap.OBRA + cap.SERVICIO;
                totalCD += cd;
                totalSuministros += cap.SUMINISTRO;
                totalObraCivil += cap.OBRA;
                totalServicios += cap.SERVICIO;
                
                // AIU = 0.33 √ó OBRA (solo OBRA)
                const administracion = cap.OBRA * 0.23;
                const imprevistos = cap.OBRA * 0.05;
                const utilidad = cap.OBRA * 0.05;
                const aiuCap = administracion + imprevistos + utilidad;
                totalAIU += aiuCap;
                
                // IVA = 0.19 √ó SUM + 0.19 √ó SERV + 0.19 √ó (0.05 √ó OBRA)
                const ivaSuministros = cap.SUMINISTRO * 0.19;
                const ivaServicios = cap.SERVICIO * 0.19;
                const ivaUtilidad = cap.OBRA * 0.05 * 0.19; // IVA sobre utilidad de OBRA
                const ivaCap = ivaSuministros + ivaServicios + ivaUtilidad;
                totalIVA += ivaCap;
                
                // Guardar por cap√≠tulo
                capitulos[capitulo] = {
                    suministros: cap.SUMINISTRO,
                    obraCivil: cap.OBRA,
                    servicios: cap.SERVICIO,
                    costoDirecto: cd,
                    administracion: administracion,
                    imprevistos: imprevistos,
                    utilidad: utilidad,
                    aiu: aiuCap,
                    ivaSuministros: ivaSuministros,
                    ivaServicios: ivaServicios,
                    ivaUtilidad: ivaUtilidad,
                    iva: ivaCap,
                    total: cd + aiuCap + ivaCap
                };
            });
            
            totalGeneral = totalCD + totalAIU + totalIVA;
            
            return {
                costoDirecto: totalCD,
                aiu: totalAIU,
                iva: totalIVA,
                total: totalGeneral,
                subtotales: subtotales,
                capitulos: capitulos,
                totalSuministros: totalSuministros,
                totalObraCivil: totalObraCivil,
                totalServicios: totalServicios
            };
        }

        function updateStats() {
            // Funci√≥n para contar √≠tems por tipo
            let totalItems = 0;
            let totalObra = 0;
            let totalSuministro = 0;
            let totalServicio = 0;
            
            filteredData.forEach(item => {
                if (item.tipo) {
                    totalItems++;
                    if (item.tipo === 'OBRA') totalObra++;
                    else if (item.tipo === 'SUMINISTRO') totalSuministro++;
                    else if (item.tipo === 'SERVICIO') totalServicio++;
                }
            });
            
            // Actualizar los elementos del DOM
            document.getElementById('totalItems').textContent = totalItems;
            document.getElementById('totalObra').textContent = totalObra;
            document.getElementById('totalSuministro').textContent = totalSuministro;
            document.getElementById('totalServicio').textContent = totalServicio;
        }

        function actualizarEstadisticas() {
            const calculos = calcularAIUeIVA();
            
            // Actualizar estad√≠sticas b√°sicas
            updateStats();
            
            // Agregar estad√≠sticas financieras
            const statsContainer = document.querySelector('.stats');
            statsContainer.innerHTML += `
                <div class="stat-card" style="border-color: #dc3545;">
                    <h3>Costo Directo Total</h3>
                    <p>$${calculos.costoDirecto.toLocaleString('es-CO', {maximumFractionDigits: 0})}</p>
                </div>
                <div class="stat-card" style="border-color: #ffc107;">
                    <h3>AIU Total</h3>
                    <p>$${calculos.aiu.toLocaleString('es-CO', {maximumFractionDigits: 0})}</p>
                </div>
                <div class="stat-card" style="border-color: #17a2b8;">
                    <h3>IVA Total</h3>
                    <p>$${calculos.iva.toLocaleString('es-CO', {maximumFractionDigits: 0})}</p>
                </div>
                <div class="stat-card" style="border-color: #28a745;">
                    <h3>Total General (COP)</h3>
                    <p>$${calculos.total.toLocaleString('es-CO', {maximumFractionDigits: 0})}</p>
                </div>
                <div class="stat-card" style="border-color: #6f42c1;">
                    <h3>Total General (USD)</h3>
                    <p>$${(calculos.total/4400).toLocaleString('en-US', {maximumFractionDigits: 0})}</p>
                </div>
            `;
        }

        function filtrarPorTipo() {
            const filtro = document.getElementById('filtroTipo').value;
            
            if (filtro === 'TODOS') {
                filteredData = [...wbsData];
            } else {
                filteredData = wbsData.filter(item => item.tipo === filtro || item.tipo === '');
            }
            
            renderTable();
        }

        function exportarExcel() {
            console.log('üîµ Iniciando exportaci√≥n de WBS completa...');
            
            // Verificar que XLSX est√© disponible
            if (typeof XLSX === 'undefined') {
                alert('‚ùå Error: La librer√≠a XLSX no est√° cargada.\nPor favor, verifica tu conexi√≥n a internet y recarga la p√°gina.');
                console.error('XLSX no est√° disponible');
                return;
            }
            
            console.log('‚úÖ Librer√≠a XLSX disponible');
            console.log('üìä Datos filtrados:', filteredData.length, '√≠tems');
            
            try {
                // Preparar datos para Excel
                const excelData = filteredData.map(item => {
                    const parseNumber = (str) => {
                        if (!str) return 0;
                        return parseFloat(str.toString().replace(/,/g, '')) || 0;
                    };
                    
                    return {
                        '√çTEM': item.item,
                        'DESCRIPCI√ìN': item.descripcion,
                        'TIPO': item.tipo,
                        'UNIDAD': item.unidad,
                        'CANTIDAD': parseNumber(item.cantidad),
                        'VU (COP)': parseNumber(item.vu),
                        'TOTAL (COP)': parseNumber(item.total),
                        'TOTAL (USD)': parseNumber(item.total) / 4400
                    };
                });

                // Crear hoja de trabajo
                const ws = XLSX.utils.json_to_sheet(excelData);
                
                // Ajustar ancho de columnas
                const colWidths = [
                    { wch: 15 }, // √çTEM
                    { wch: 60 }, // DESCRIPCI√ìN
                    { wch: 15 }, // TIPO
                    { wch: 10 }, // UNIDAD
                    { wch: 12 }, // CANTIDAD
                    { wch: 15 }, // VU (COP)
                    { wch: 15 }, // TOTAL (COP)
                    { wch: 15 }  // TOTAL (USD)
                ];
                ws['!cols'] = colWidths;

                // Crear libro de trabajo
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'WBS Presupuesto SCC');

                // Agregar hoja de resumen con desglose por cap√≠tulo
                const calculos = calcularAIUeIVA();
                const resumenData = [
                    ['RESUMEN EJECUTIVO - WBS v2.9 (Actualizada 08/10/2025)', ''],
                    [''],
                    ['TOTALES GENERALES', ''],
                    ['Costo Directo Total', calculos.costoDirecto],
                    ['  Suministros', calculos.totalSuministros],
                    ['  Obra Civil', calculos.totalObraCivil],
                    ['  Servicios', calculos.totalServicios],
                    ['AIU Total (solo OBRA)', calculos.aiu],
                    ['  Administraci√≥n 23%', calculos.totalObraCivil * 0.23],
                    ['  Imprevistos 5%', calculos.totalObraCivil * 0.05],
                    ['  Utilidad 5%', calculos.totalObraCivil * 0.05],
                    ['IVA Total', calculos.iva],
                    ['  IVA Suministros 19%', calculos.totalSuministros * 0.19],
                    ['  IVA Servicios 19%', calculos.totalServicios * 0.19],
                    ['  IVA/Utilidad Obra 19%', calculos.totalObraCivil * 0.05 * 0.19],
                    ['TOTAL PROYECTO (COP)', calculos.total],
                    ['TOTAL PROYECTO (USD)', calculos.total / 4400],
                    ['TRM (COP/USD)', 4400],
                    [''],
                    ['CAMBIOS T√âCNICOS RECIENTES (8-Oct-2025)', ''],
                    ['DT-SCADA-001', 'Servidores SCADA +$400M'],
                    ['DT-SCADA-002', 'Software SCADA +$4,500M'],
                    ['DT-SCADA-003', 'Interfaces L2/L3 +$3,912M'],
                    ['DT-CTC-002', 'Software CTC Virtual +$8,000M'],
                    ['Total incremento', '+$16,812,000,000 COP']
                ];
                
                const wsResumen = XLSX.utils.aoa_to_sheet(resumenData);
                wsResumen['!cols'] = [{ wch: 35 }, { wch: 25 }];
                XLSX.utils.book_append_sheet(wb, wsResumen, 'Resumen Ejecutivo');
                
                // Agregar hoja de desglose por cap√≠tulo
                const desgloseCapData = [
                    ['DESGLOSE POR CAP√çTULO - WBS v2.9'],
                    [''],
                    ['CAP', 'NOMBRE', 'SUMINISTROS', 'OBRA', 'SERVICIOS', 'CD', 'ADM 23%', 'IMP 5%', 'UTIL 5%', 'IVA/UTIL', 'IVA SUM+SERV', 'AIU', 'IVA TOTAL', 'TOTAL', 'USD']
                ];
                
                Object.keys(calculos.capitulos).sort().forEach(cap => {
                    const c = calculos.capitulos[cap];
                    const nombresCap = {
                        '1': 'CONTROL Y SE√ëALIZACI√ìN',
                        '2': 'TELECOMUNICACIONES', 
                        '3': 'ITS Y SEGURIDAD',
                        '4': 'PASOS A NIVEL',
                        '5': 'CCO',
                        '6': 'MATERIAL RODANTE'
                    };
                    desgloseCapData.push([
                        cap,
                        nombresCap[cap],
                        c.suministros,
                        c.obraCivil,
                        c.servicios,
                        c.costoDirecto,
                        c.administracion,
                        c.imprevistos,
                        c.utilidad,
                        c.ivaUtilidad,
                        (c.ivaSuministros + c.ivaServicios),
                        c.aiu,
                        c.iva,
                        c.total,
                        c.total / 4400
                    ]);
                });
                
                const wsDesglose = XLSX.utils.aoa_to_sheet(desgloseCapData);
                wsDesglose['!cols'] = [
                    {wch: 5}, {wch: 25}, {wch: 18}, {wch: 18}, {wch: 18}, {wch: 18},
                    {wch: 15}, {wch: 15}, {wch: 15}, {wch: 15}, {wch: 15}, {wch: 15}, {wch: 15}, {wch: 18}, {wch: 15}
                ];
                XLSX.utils.book_append_sheet(wb, wsDesglose, 'Desglose por Cap√≠tulo');

                // Exportar archivo
                const fileName = `WBS_Presupuesto_SCC_APP_La_Dorada_Chiriguan√°_v2.9_${new Date().toISOString().split('T')[0]}.xlsx`;
                console.log('üíæ Intentando guardar archivo:', fileName);
                
                XLSX.writeFile(wb, fileName);
                
                console.log('‚úÖ Archivo exportado exitosamente');
                // Mostrar confirmaci√≥n
                alert(`‚úÖ WBS completa exportada exitosamente:\n\nüìÑ ${fileName}\n\nBusca el archivo en tu carpeta de Descargas.`);
                
            } catch (error) {
                console.error('‚ùå Error al exportar Excel:', error);
                console.error('Stack trace:', error.stack);
                alert(`‚ùå Error al exportar el archivo Excel:\n\n${error.message}\n\nAbre la consola del navegador (F12) para ver m√°s detalles.`);
            }
        }

        function exportarDesgloseExcel() {
            console.log('üîµ Iniciando exportaci√≥n de desglose AIU...');
            
            // Verificar que XLSX est√© disponible
            if (typeof XLSX === 'undefined') {
                alert('‚ùå Error: La librer√≠a XLSX no est√° cargada.\nPor favor, verifica tu conexi√≥n a internet y recarga la p√°gina.');
                console.error('XLSX no est√° disponible');
                return;
            }
            
            console.log('‚úÖ Librer√≠a XLSX disponible');
            
            try {
                const calculos = calcularAIUeIVA();
                console.log('‚úÖ C√°lculos obtenidos:', calculos);
                
                const nombresCap = {
                    '1': 'CONTROL Y SE√ëALIZACI√ìN VIRTUAL',
                    '2': 'TELECOMUNICACIONES COLOCALIZADAS', 
                    '3': 'SISTEMAS ITS Y SEGURIDAD',
                    '4': 'PASOS A NIVEL',
                    '5': 'CENTRO DE CONTROL OPERACIONAL',
                    '6': 'MATERIAL RODANTE'
                };
                
                // Preparar datos del desglose CON DETALLE AIU/IVA
                const desgloseData = [
                    ['DESGLOSE PRESUPUESTAL POR CAP√çTULOS - WBS v2.9'],
                    ['Fecha:', new Date().toLocaleDateString('es-CO')],
                    ['Proyecto: APP La Dorada-Chiriguan√° | UF-2.2'],
                    [],
                    ['CAP√çTULO', 'CONCEPTO', 'SUMINISTROS', 'OBRA', 'SERVICIOS', 'CD', 'AIU/IVA', 'TOTAL COP', 'TOTAL USD']
                ];
                
                // Agregar datos POR CAP√çTULO con desglose completo
                Object.keys(calculos.capitulos).sort().forEach(cap => {
                    const c = calculos.capitulos[cap];
                    
                    // Fila principal del cap√≠tulo
                    desgloseData.push([
                        `CAP ${cap}`,
                        nombresCap[cap],
                        c.suministros,
                        c.obraCivil,
                        c.servicios,
                        c.costoDirecto,
                        '',
                        '',
                        ''
                    ]);
                    
                    // Desglose AIU (solo si hay OBRA)
                    if (c.obraCivil > 0) {
                        desgloseData.push([
                            '', '  ‚Ü≥ Administraci√≥n (23%)', '', '', '', '', c.administracion, '', c.administracion / 4400
                        ]);
                        desgloseData.push([
                            '', '  ‚Ü≥ Imprevistos (5%)', '', '', '', '', c.imprevistos, '', c.imprevistos / 4400
                        ]);
                        desgloseData.push([
                            '', '  ‚Ü≥ Utilidad (5%)', '', '', '', '', c.utilidad, '', c.utilidad / 4400
                        ]);
                    }
                    
                    // Desglose IVA
                    desgloseData.push([
                        '', '  ‚Ü≥ IVA Suministros (19%)', '', '', '', '', c.ivaSuministros, '', c.ivaSuministros / 4400
                    ]);
                    desgloseData.push([
                        '', '  ‚Ü≥ IVA Servicios (19%)', '', '', '', '', c.ivaServicios, '', c.ivaServicios / 4400
                    ]);
                    if (c.obraCivil > 0) {
                        desgloseData.push([
                            '', '  ‚Ü≥ IVA/Utilidad Obra (19%√ó5%)', '', '', '', '', c.ivaUtilidad, '', c.ivaUtilidad / 4400
                        ]);
                    }
                    
                    // Totales del cap√≠tulo
                    desgloseData.push([
                        '', 'AIU TOTAL', '', '', '', '', c.aiu, '', c.aiu / 4400
                    ]);
                    desgloseData.push([
                        '', 'IVA TOTAL', '', '', '', '', c.iva, '', c.iva / 4400
                    ]);
                    desgloseData.push([
                        '', 'TOTAL CAP√çTULO ' + cap, '', '', '', '', '', c.total, c.total / 4400
                    ]);
                    
                    // L√≠nea separadora
                    desgloseData.push([]);
                });
                
                // TOTALES GENERALES
                desgloseData.push([]);
                desgloseData.push(['TOTALES GENERALES', '', '', '', '', '', '', '', '']);
                desgloseData.push([
                    'TOTAL GENERAL', 'SUMINISTROS',
                    calculos.totalSuministros, '', '', calculos.totalSuministros, '', '', calculos.totalSuministros / 4400
                ]);
                desgloseData.push([
                    'TOTAL GENERAL', 'OBRA CIVIL',
                    '', calculos.totalObraCivil, '', calculos.totalObraCivil, '', '', calculos.totalObraCivil / 4400
                ]);
                desgloseData.push([
                    'TOTAL GENERAL', 'SERVICIOS',
                    '', '', calculos.totalServicios, calculos.totalServicios, '', '', calculos.totalServicios / 4400
                ]);
                desgloseData.push([]);
                desgloseData.push([
                    'TOTAL GENERAL', 'COSTO DIRECTO',
                    '', '', '', calculos.costoDirecto, '', '', calculos.costoDirecto / 4400
                ]);
                desgloseData.push([
                    'TOTAL GENERAL', 'AIU TOTAL (33% OBRA)',
                    '', '', '', '', calculos.aiu, '', calculos.aiu / 4400
                ]);
                desgloseData.push([
                    'TOTAL GENERAL', 'IVA TOTAL',
                    '', '', '', '', calculos.iva, '', calculos.iva / 4400
                ]);
                desgloseData.push([]);
                desgloseData.push([
                    'TOTAL PROYECTO', '',
                    '', '', '', '', '', calculos.total, calculos.total / 4400
                ]);
                
                // Crear hoja
                console.log('üìÑ Creando hoja de Excel con datos...');
                const ws = XLSX.utils.aoa_to_sheet(desgloseData);
                console.log('‚úÖ Hoja creada');
                
                // Formato de columnas
                ws['!cols'] = [
                    { wch: 12 },  // CAP√çTULO
                    { wch: 45 },  // CONCEPTO
                    { wch: 18 },  // SUMINISTROS
                    { wch: 18 },  // OBRA
                    { wch: 18 },  // SERVICIOS
                    { wch: 18 },  // CD
                    { wch: 18 },  // AIU/IVA
                    { wch: 20 },  // TOTAL COP
                    { wch: 18 }   // TOTAL USD
                ];
                
                // Crear libro
                console.log('üìö Creando libro de trabajo...');
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Desglose AIU');
                console.log('‚úÖ Hoja "Desglose AIU" agregada');
                
                // Agregar hoja de resumen ejecutivo ACTUALIZADA
                const resumenData = [
                    ['RESUMEN EJECUTIVO - WBS v3.0 (Actualizada 08/10/2025)'],
                    ['Proyecto: APP La Dorada-Chiriguan√° | UF-2.2'],
                    ['Fecha:', new Date().toLocaleDateString('es-CO')],
                    [],
                    ['CONCEPTO', 'VALOR COP', 'VALOR USD'],
                    ['Costo Directo Total', calculos.costoDirecto, calculos.costoDirecto / 4400],
                    [],
                    ['DESGLOSE POR TIPO:'],
                    ['  Suministros', calculos.totalSuministros, calculos.totalSuministros / 4400],
                    ['  Obra Civil', calculos.totalObraCivil, calculos.totalObraCivil / 4400],
                    ['  Servicios', calculos.totalServicios, calculos.totalServicios / 4400],
                    [],
                    ['AIU TOTAL (solo OBRA)', calculos.aiu, calculos.aiu / 4400],
                    ['  ‚Ü≥ Administraci√≥n 23%', calculos.totalObraCivil * 0.23, (calculos.totalObraCivil * 0.23) / 4400],
                    ['  ‚Ü≥ Imprevistos 5%', calculos.totalObraCivil * 0.05, (calculos.totalObraCivil * 0.05) / 4400],
                    ['  ‚Ü≥ Utilidad 5%', calculos.totalObraCivil * 0.05, (calculos.totalObraCivil * 0.05) / 4400],
                    [],
                    ['IVA TOTAL', calculos.iva, calculos.iva / 4400],
                    ['  ‚Ü≥ IVA Suministros 19%', calculos.totalSuministros * 0.19, (calculos.totalSuministros * 0.19) / 4400],
                    ['  ‚Ü≥ IVA Servicios 19%', calculos.totalServicios * 0.19, (calculos.totalServicios * 0.19) / 4400],
                    ['  ‚Ü≥ IVA/Utilidad Obra 19%', calculos.totalObraCivil * 0.05 * 0.19, (calculos.totalObraCivil * 0.05 * 0.19) / 4400],
                    [],
                    ['TOTAL PROYECTO (COP)', calculos.total, calculos.total / 4400],
                    ['TRM (COP/USD)', 4400, ''],
                    [],
                    [],
                    ['CAMBIOS T√âCNICOS RECIENTES (7-8 Oct 2025)'],
                    ['DT-TETRA-001', 'ATP 15‚Üí8 UND', '-$7,479,500,000'],
                    ['DT-SCADA-001', 'Servidores SCADA $400M c/u', '+$800,000,000'],
                    ['DT-SCADA-002', 'Software SCADA', '+$4,500,000,000'],
                    ['DT-SCADA-003', 'Interfaces L2/L3', '+$3,912,000,000'],
                    ['DT-CTC-002', 'Software CTC Virtual', '+$8,000,000,000'],
                    ['DT-CTC-003', 'Software CTC ETCS L2 + FENOCO', '+$79,352,088,766'],
                    ['Total incremento neto', '+$89,084,588,766 COP']
                ];
                
                console.log('üìù Creando hoja resumen...');
                const wsResumen = XLSX.utils.aoa_to_sheet(resumenData);
                wsResumen['!cols'] = [{ wch: 40 }, { wch: 22 }, { wch: 20 }];
                XLSX.utils.book_append_sheet(wb, wsResumen, 'Resumen Ejecutivo');
                console.log('‚úÖ Hoja "Resumen Ejecutivo" agregada');
                
                // Exportar
                const fileName = `Desglose_AIU_WBS_v3.0_${new Date().toISOString().split('T')[0]}.xlsx`;
                console.log('üíæ Intentando guardar archivo:', fileName);
                
                XLSX.writeFile(wb, fileName);
                
                console.log('‚úÖ Archivo exportado exitosamente');
                alert(`‚úÖ Desglose AIU exportado exitosamente:\n\nüìÑ ${fileName}\n\nBusca el archivo en tu carpeta de Descargas.`);
            } catch (error) {
                console.error('‚ùå Error exportando desglose:', error);
                console.error('Stack trace:', error.stack);
                alert(`‚ùå Error al exportar desglose AIU:\n\n${error.message}\n\nAbre la consola del navegador (F12) para ver m√°s detalles.`);
            }
        }

        function mostrarDesglose() {
            try {
                const calculos = calcularAIUeIVA();
                const nombresCap = {
                    '1': 'CONTROL Y SE√ëALIZACI√ìN VIRTUAL',
                    '2': 'TELECOMUNICACIONES COLOCALIZADAS', 
                    '3': 'SISTEMAS ITS Y SEGURIDAD',
                    '4': 'PASOS A NIVEL',
                    '5': 'CENTRO DE CONTROL OPERACIONAL',
                    '6': 'MATERIAL RODANTE'
                };
                
                let desgloseHTML = `
                    <div style="background: white; padding: 20px; border-radius: 8px; margin: 20px 0;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div>
                                <h2 style="color: #1e3c72; margin: 0;">üìä DESGLOSE PRESUPUESTAL POR CAP√çTULOS</h2>
                                <h3 style="color: #28a745; margin: 5px 0 0 0; font-size: 14px;">‚úÖ WBS Actualizada v3.0 - DT-CTC-003: Software CTC + ETCS L2 + FENOCO aplicado</h3>
                            </div>
                            <button id="btnExportarDesglose" class="btn btn-success" style="background: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                                üì• Exportar Desglose a Excel
                            </button>
                        </div>
                        <table style="width: 100%; border-collapse: collapse; font-size: 11px; margin-bottom: 20px;">
                            <thead>
                                <tr style="background: #343a40; color: white;">
                                    <th style="padding: 10px; border: 1px solid #495057; text-align: center;">CAP√çTULO</th>
                                    <th style="padding: 10px; border: 1px solid #495057; text-align: center;">SUMINISTROS<br/>(COP)</th>
                                    <th style="padding: 10px; border: 1px solid #495057; text-align: center;">OBRA CIVIL<br/>(COP)</th>
                                    <th style="padding: 10px; border: 1px solid #495057; text-align: center;">SERVICIOS<br/>(COP)</th>
                                    <th style="padding: 10px; border: 1px solid #495057; text-align: center;">COSTO DIRECTO<br/>(COP)</th>
                                    <th style="padding: 10px; border: 1px solid #495057; text-align: center;">AIU 33%<br/>(COP)</th>
                                    <th style="padding: 10px; border: 1px solid #495057; text-align: center;">IVA<br/>(COP)</th>
                                    <th style="padding: 10px; border: 1px solid #495057; text-align: center;">TOTAL<br/>(COP)</th>
                                    <th style="padding: 10px; border: 1px solid #495057; text-align: center;">TOTAL<br/>(USD)</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                let granTotal = 0;
                Object.keys(calculos.subtotales).forEach(capitulo => {
                    const cap = calculos.subtotales[capitulo];
                    
                    // CD = SUM + OBRA + SERV
                    const cdCap = cap.SUMINISTRO + cap.OBRA + cap.SERVICIO;
                    
                    // AIU = 0.33 √ó OBRA (solo OBRA)
                    const aiuCap = cap.OBRA * 0.33;
                    
                    // IVA = 0.19 √ó SUM + 0.19 √ó SERV + 0.19 √ó (0.05 √ó OBRA)
                    const ivaCap = (cap.SUMINISTRO * 0.19) + (cap.SERVICIO * 0.19) + (cap.OBRA * 0.05 * 0.19);
                    
                    const totalCap = cdCap + aiuCap + ivaCap;
                    granTotal += totalCap;
                    
                    // Determinar color de fila para Cap√≠tulo 4
                    const rowStyle = capitulo === '4' ? 'background: #fff3cd; font-weight: bold;' : '';
                    
                    // Obtener datos detallados del cap√≠tulo
                    const capDetalle = calculos.capitulos[capitulo] || {};
                    
                    desgloseHTML += `
                        <tr style="${rowStyle}">
                            <td style="padding: 8px; border: 1px solid #dee2e6; font-weight: bold;">${capitulo}. ${nombresCap[capitulo] || 'CAP√çTULO ' + capitulo}</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6; text-align: right;">$${cap.SUMINISTRO.toLocaleString('es-CO', {maximumFractionDigits: 0})}</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6; text-align: right;">$${cap.OBRA.toLocaleString('es-CO', {maximumFractionDigits: 0})}</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6; text-align: right;">$${cap.SERVICIO.toLocaleString('es-CO', {maximumFractionDigits: 0})}</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6; text-align: right; font-weight: bold;">$${cdCap.toLocaleString('es-CO', {maximumFractionDigits: 0})}</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6; text-align: right;">$${aiuCap.toLocaleString('es-CO', {maximumFractionDigits: 0})}</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6; text-align: right;">$${ivaCap.toLocaleString('es-CO', {maximumFractionDigits: 0})}</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6; text-align: right; font-weight: bold; background: #e3f2fd;">$${totalCap.toLocaleString('es-CO', {maximumFractionDigits: 0})}</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6; text-align: right; font-weight: bold;">$${(totalCap/4400).toLocaleString('en-US', {maximumFractionDigits: 0})}</td>
                        </tr>
                    `;
                    
                    // Agregar desglose detallado de AIU si hay OBRA
                    if (cap.OBRA > 0) {
                        desgloseHTML += `
                            <tr style="background: #fffbf0; font-size: 10px;">
                                <td colspan="5" style="padding: 3px 8px 3px 50px; border: 1px solid #dee2e6; font-style: italic; color: #856404;">‚Ü≥ Administraci√≥n (23%)</td>
                                <td style="padding: 3px 8px; border: 1px solid #dee2e6; text-align: right; color: #856404;">${(capDetalle.administracion || 0).toLocaleString('es-CO', {maximumFractionDigits: 0})}</td>
                                <td style="padding: 3px 8px; border: 1px solid #dee2e6;"></td>
                                <td style="padding: 3px 8px; border: 1px solid #dee2e6;"></td>
                                <td style="padding: 3px 8px; border: 1px solid #dee2e6; text-align: right; color: #856404;">${((capDetalle.administracion || 0)/4400).toLocaleString('en-US', {maximumFractionDigits: 0})}</td>
                            </tr>
                            <tr style="background: #fffbf0; font-size: 10px;">
                                <td colspan="5" style="padding: 3px 8px 3px 50px; border: 1px solid #dee2e6; font-style: italic; color: #856404;">‚Ü≥ Imprevistos (5%)</td>
                                <td style="padding: 3px 8px; border: 1px solid #dee2e6; text-align: right; color: #856404;">${(capDetalle.imprevistos || 0).toLocaleString('es-CO', {maximumFractionDigits: 0})}</td>
                                <td style="padding: 3px 8px; border: 1px solid #dee2e6;"></td>
                                <td style="padding: 3px 8px; border: 1px solid #dee2e6;"></td>
                                <td style="padding: 3px 8px; border: 1px solid #dee2e6; text-align: right; color: #856404;">${((capDetalle.imprevistos || 0)/4400).toLocaleString('en-US', {maximumFractionDigits: 0})}</td>
                            </tr>
                            <tr style="background: #fffbf0; font-size: 10px;">
                                <td colspan="5" style="padding: 3px 8px 3px 50px; border: 1px solid #dee2e6; font-style: italic; color: #856404;">‚Ü≥ Utilidad (5%)</td>
                                <td style="padding: 3px 8px; border: 1px solid #dee2e6; text-align: right; color: #856404;">${(capDetalle.utilidad || 0).toLocaleString('es-CO', {maximumFractionDigits: 0})}</td>
                                <td style="padding: 3px 8px; border: 1px solid #dee2e6;"></td>
                                <td style="padding: 3px 8px; border: 1px solid #dee2e6;"></td>
                                <td style="padding: 3px 8px; border: 1px solid #dee2e6; text-align: right; color: #856404;">${((capDetalle.utilidad || 0)/4400).toLocaleString('en-US', {maximumFractionDigits: 0})}</td>
                            </tr>
                        `;
                    }
                    
                    // Desglose completo de IVA
                    desgloseHTML += `
                        <tr style="background: #f0f8ff; font-size: 10px;">
                            <td colspan="5" style="padding: 3px 8px 3px 50px; border: 1px solid #dee2e6; font-style: italic; color: #004085;">‚Ü≥ IVA Suministros (19%)</td>
                            <td style="padding: 3px 8px; border: 1px solid #dee2e6;"></td>
                            <td style="padding: 3px 8px; border: 1px solid #dee2e6; text-align: right; color: #004085;">${(capDetalle.ivaSuministros || 0).toLocaleString('es-CO', {maximumFractionDigits: 0})}</td>
                            <td style="padding: 3px 8px; border: 1px solid #dee2e6;"></td>
                            <td style="padding: 3px 8px; border: 1px solid #dee2e6; text-align: right; color: #004085;">${((capDetalle.ivaSuministros || 0)/4400).toLocaleString('en-US', {maximumFractionDigits: 0})}</td>
                        </tr>
                        <tr style="background: #f0f8ff; font-size: 10px;">
                            <td colspan="5" style="padding: 3px 8px 3px 50px; border: 1px solid #dee2e6; font-style: italic; color: #004085;">‚Ü≥ IVA Servicios (19%)</td>
                            <td style="padding: 3px 8px; border: 1px solid #dee2e6;"></td>
                            <td style="padding: 3px 8px; border: 1px solid #dee2e6; text-align: right; color: #004085;">${(capDetalle.ivaServicios || 0).toLocaleString('es-CO', {maximumFractionDigits: 0})}</td>
                            <td style="padding: 3px 8px; border: 1px solid #dee2e6;"></td>
                            <td style="padding: 3px 8px; border: 1px solid #dee2e6; text-align: right; color: #004085;">${((capDetalle.ivaServicios || 0)/4400).toLocaleString('en-US', {maximumFractionDigits: 0})}</td>
                        </tr>
                        <tr style="background: #f0f8ff; font-size: 10px;">
                            <td colspan="5" style="padding: 3px 8px 3px 50px; border: 1px solid #dee2e6; font-style: italic; color: #004085;">‚Ü≥ IVA/Utilidad Obra (19% √ó 5%)</td>
                            <td style="padding: 3px 8px; border: 1px solid #dee2e6;"></td>
                            <td style="padding: 3px 8px; border: 1px solid #dee2e6; text-align: right; color: #004085;">${(capDetalle.ivaUtilidad || 0).toLocaleString('es-CO', {maximumFractionDigits: 0})}</td>
                            <td style="padding: 3px 8px; border: 1px solid #dee2e6;"></td>
                            <td style="padding: 3px 8px; border: 1px solid #dee2e6; text-align: right; color: #004085;">${((capDetalle.ivaUtilidad || 0)/4400).toLocaleString('en-US', {maximumFractionDigits: 0})}</td>
                        </tr>
                    `;
                });
                
                desgloseHTML += `
                            <tr style="background: #f8f9fa; font-weight: bold; border-top: 3px solid #28a745;">
                                <td style="padding: 10px; border: 1px solid #dee2e6; font-size: 14px;">TOTAL GENERAL</td>
                                <td style="padding: 10px; border: 1px solid #dee2e6; text-align: right; font-size: 14px;">$${Object.values(calculos.subtotales).reduce((sum, cap) => sum + cap.SUMINISTRO, 0).toLocaleString('es-CO', {maximumFractionDigits: 0})}</td>
                                <td style="padding: 10px; border: 1px solid #dee2e6; text-align: right; font-size: 14px;">$${Object.values(calculos.subtotales).reduce((sum, cap) => sum + cap.OBRA, 0).toLocaleString('es-CO', {maximumFractionDigits: 0})}</td>
                                <td style="padding: 10px; border: 1px solid #dee2e6; text-align: right; font-size: 14px;">$${Object.values(calculos.subtotales).reduce((sum, cap) => sum + cap.SERVICIO, 0).toLocaleString('es-CO', {maximumFractionDigits: 0})}</td>
                                <td style="padding: 10px; border: 1px solid #dee2e6; text-align: right; font-size: 14px;">$${calculos.costoDirecto.toLocaleString('es-CO', {maximumFractionDigits: 0})}</td>
                                <td style="padding: 10px; border: 1px solid #dee2e6; text-align: right; font-size: 14px;">$${calculos.aiu.toLocaleString('es-CO', {maximumFractionDigits: 0})}</td>
                                <td style="padding: 10px; border: 1px solid #dee2e6; text-align: right; font-size: 14px;">$${calculos.iva.toLocaleString('es-CO', {maximumFractionDigits: 0})}</td>
                                <td style="padding: 10px; border: 1px solid #dee2e6; text-align: right; font-size: 16px; background: #d4edda; color: #155724;">$${calculos.total.toLocaleString('es-CO', {maximumFractionDigits: 0})}</td>
                                <td style="padding: 10px; border: 1px solid #dee2e6; text-align: right; font-size: 16px; background: #d4edda; color: #155724;">$${(calculos.total/4400).toLocaleString('en-US', {maximumFractionDigits: 0})}</td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <div style="margin-top: 30px; padding: 20px; background: #e3f2fd; border-radius: 8px; border-left: 5px solid #2196f3;">
                        <h4 style="color: #1565c0; margin-bottom: 15px;">üìã RESUMEN EJECUTIVO</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <p><strong>Costo Directo Total:</strong> $${calculos.costoDirecto.toLocaleString('es-CO', {maximumFractionDigits: 0})} COP</p>
                                <p><strong>AIU (33%):</strong> $${calculos.aiu.toLocaleString('es-CO', {maximumFractionDigits: 0})} COP</p>
                                <p><strong>IVA Total:</strong> $${calculos.iva.toLocaleString('es-CO', {maximumFractionDigits: 0})} COP</p>
                            </div>
                            <div>
                                <p><strong>TOTAL PROYECTO (COP):</strong> $${calculos.total.toLocaleString('es-CO', {maximumFractionDigits: 0})} COP</p>
                                <p><strong>TOTAL PROYECTO (USD):</strong> $${(calculos.total/4400).toLocaleString('en-US', {maximumFractionDigits: 0})} USD</p>
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px; padding: 15px; background: #d4edda; border-radius: 6px; border-left: 5px solid #28a745;">
                            <h5 style="color: #155724; margin-bottom: 10px;">‚úÖ CAMBIOS T√âCNICOS RECIENTES (Sesi√≥n 8-Oct-2025)</h5>
                            <p style="color: #155724; margin: 5px 0;"><strong>DT-SCADA-001:</strong> Servidores SCADA +$400M</p>
                            <p style="color: #155724; margin: 5px 0;"><strong>DT-SCADA-002:</strong> Software SCADA +$4,500M</p>
                            <p style="color: #155724; margin: 5px 0;"><strong>DT-SCADA-003:</strong> Interfaces L2/L3 +$3,912M</p>
                            <p style="color: #155724; margin: 5px 0;"><strong>DT-CTC-002:</strong> Software CTC Virtual +$8,000M</p>
                        </div>
                        
                        <div style="margin-top: 15px; font-size: 12px; color: #666;">
                            <p><em>Nota: Los valores incluyen la aplicaci√≥n correcta de AIU (Administraci√≥n 23%, Imprevistos 5%, Utilidad 5%) e IVA diferenciado seg√∫n normativa colombiana.</em></p>
                            <p><em>TRM: 4,400 COP/USD</em></p>
                        </div>
                    </div>
                </div>
                `;
                
                // Crear ventana con mejor dise√±o
                const ventana = window.open('', '_blank', 'width=1400,height=900,scrollbars=yes,resizable=yes');
                
                // Preparar el HTML de la ventana
                const htmlContent = `
                    <html>
                    <head>
                        <title>Desglose Presupuestal - WBS SCC v2.9</title>
                        <meta charset="UTF-8">
                        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"><\/script>
                        <style>
                            body { 
                                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
                                margin: 0; 
                                padding: 20px; 
                                background: #f8f9fa;
                            }
                            .container {
                                max-width: 1400px;
                                margin: 0 auto;
                                background: white;
                                border-radius: 10px;
                                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                                overflow: hidden;
                            }
                            table { 
                                border-collapse: collapse; 
                                width: 100%; 
                                margin-bottom: 20px;
                            }
                            th, td { 
                                border: 1px solid #ddd; 
                                padding: 8px; 
                                text-align: left; 
                            }
                            th { 
                                background-color: #343a40; 
                                color: white;
                                font-weight: bold;
                            }
                            .print-btn {
                                position: fixed;
                                top: 20px;
                                right: 20px;
                                background: #007bff;
                                color: white;
                                border: none;
                                padding: 10px 20px;
                                border-radius: 5px;
                                cursor: pointer;
                                font-size: 14px;
                                z-index: 1000;
                            }
                        </style>
                        <script>
                            // Copiar datos del desglose para exportar
                            const datosDesglose = ${JSON.stringify(calculos)};
                            const nombresCapitulos = ${JSON.stringify(nombresCap)};
                            
                            function exportarDesgloseExcel() {
                                console.log('üîµ Iniciando exportaci√≥n de desglose AIU...');
                                
                                if (typeof XLSX === 'undefined') {
                                    alert('‚ùå Error: La librer√≠a XLSX no est√° cargada.\\nPor favor, verifica tu conexi√≥n a internet y recarga la p√°gina.');
                                    return;
                                }
                                
                                console.log('‚úÖ Librer√≠a XLSX disponible');
                                
                                try {
                                    const desgloseData = [
                                        ['DESGLOSE PRESUPUESTAL POR CAP√çTULOS - WBS v2.9'],
                                        ['Fecha:', new Date().toLocaleDateString('es-CO')],
                                        [],
                                        ['CAP√çTULO', 'SUMINISTROS (COP)', 'OBRA CIVIL (COP)', 'SERVICIOS (COP)', 'COSTO DIRECTO (COP)', 'AIU 33% (COP)', 'IVA (COP)', 'TOTAL (COP)', 'TOTAL (USD)']
                                    ];
                                    
                                    Object.keys(datosDesglose.subtotales).sort().forEach(cap => {
                                        const capData = datosDesglose.subtotales[cap];
                                        
                                        // CD = SUM + OBRA + SERV
                                        let cdCap = capData.SUMINISTRO + capData.OBRA + capData.SERVICIO;
                                        // AIU = 0.33 √ó OBRA (solo OBRA)
                                        let aiuCap = capData.OBRA * 0.33;
                                        // IVA = 0.19 √ó SUM + 0.19 √ó SERV + 0.19 √ó (0.05 √ó OBRA)
                                        let ivaCap = (capData.SUMINISTRO * 0.19) + (capData.SERVICIO * 0.19) + (capData.OBRA * 0.05 * 0.19);
                                        let totalCap = cdCap + aiuCap + ivaCap;
                                        
                                        desgloseData.push([
                                            cap + '. ' + (nombresCapitulos[cap] || 'CAP√çTULO ' + cap),
                                            capData.SUMINISTRO,
                                            capData.OBRA,
                                            capData.SERVICIO,
                                            cdCap,
                                            aiuCap,
                                            ivaCap,
                                            totalCap,
                                            totalCap / 4400
                                        ]);
                                    });
                                    
                                    desgloseData.push([]);
                                    desgloseData.push([
                                        'TOTAL GENERAL',
                                        Object.values(datosDesglose.subtotales).reduce((sum, cap) => sum + cap.SUMINISTRO, 0),
                                        Object.values(datosDesglose.subtotales).reduce((sum, cap) => sum + cap.OBRA, 0),
                                        Object.values(datosDesglose.subtotales).reduce((sum, cap) => sum + cap.SERVICIO, 0),
                                        datosDesglose.costoDirecto,
                                        datosDesglose.aiu,
                                        datosDesglose.iva,
                                        datosDesglose.total,
                                        datosDesglose.total / 4400
                                    ]);
                                    
                                    const ws = XLSX.utils.aoa_to_sheet(desgloseData);
                                    ws['!cols'] = [
                                        { wch: 40 }, { wch: 18 }, { wch: 18 }, { wch: 18 },
                                        { wch: 20 }, { wch: 18 }, { wch: 15 }, { wch: 20 }, { wch: 18 }
                                    ];
                                    
                                    const wb = XLSX.utils.book_new();
                                    XLSX.utils.book_append_sheet(wb, ws, 'Desglose AIU');
                                    
                                    const resumenData = [
                                        ['RESUMEN EJECUTIVO - WBS v2.9'],
                                        ['Fecha:', new Date().toLocaleDateString('es-CO')],
                                        [],
                                        ['CONCEPTO', 'VALOR'],
                                        ['Costo Directo Total (COP)', datosDesglose.costoDirecto],
                                        ['AIU 33% (COP)', datosDesglose.aiu],
                                        ['  - Administraci√≥n 23%', datosDesglose.costoDirecto * 0.23],
                                        ['  - Imprevistos 5%', datosDesglose.costoDirecto * 0.05],
                                        ['  - Utilidad 5%', datosDesglose.costoDirecto * 0.05],
                                        ['IVA Total (COP)', datosDesglose.iva],
                                        ['TOTAL PROYECTO (COP)', datosDesglose.total],
                                        ['TOTAL PROYECTO (USD)', datosDesglose.total / 4400],
                                        ['TRM (COP/USD)', 4400],
                                        [],
                                        ['DISTRIBUCI√ìN POR TIPO'],
                                        ['Suministros', Object.values(datosDesglose.subtotales).reduce((sum, cap) => sum + cap.SUMINISTRO, 0)],
                                        ['Obra Civil', Object.values(datosDesglose.subtotales).reduce((sum, cap) => sum + cap.OBRA, 0)],
                                        ['Servicios', Object.values(datosDesglose.subtotales).reduce((sum, cap) => sum + cap.SERVICIO, 0)],
                                        [],
                                        ['CAMBIOS T√âCNICOS RECIENTES (8-Oct-2025)'],
                                        ['DT-SCADA-001', 'Servidores SCADA +$400M'],
                                        ['DT-SCADA-002', 'Software SCADA +$4,500M'],
                                        ['DT-SCADA-003', 'Interfaces L2/L3 +$3,912M'],
                                        ['DT-CTC-002', 'Software CTC Virtual +$8,000M'],
                                        ['Total incremento', '+$16,812,000,000 COP']
                                    ];
                                    
                                    const wsResumen = XLSX.utils.aoa_to_sheet(resumenData);
                                    wsResumen['!cols'] = [{ wch: 30 }, { wch: 25 }];
                                    XLSX.utils.book_append_sheet(wb, wsResumen, 'Resumen Ejecutivo');
                                    
                                    const fileName = 'Desglose_AIU_WBS_v2.9_' + new Date().toISOString().split('T')[0] + '.xlsx';
                                    console.log('üíæ Guardando:', fileName);
                                    XLSX.writeFile(wb, fileName);
                                    
                                    console.log('‚úÖ Archivo exportado exitosamente');
                                    alert('‚úÖ Desglose AIU exportado exitosamente:\\n\\nüìÑ ' + fileName + '\\n\\nBusca el archivo en tu carpeta de Descargas.');
                                } catch (error) {
                                    console.error('‚ùå Error:', error);
                                    alert('‚ùå Error al exportar: ' + error.message);
                                }
                            }
                        <\/script>
                    </head>
                    <body>
                        <button class="print-btn" onclick="window.print()">üñ®Ô∏è Imprimir</button>
                        <div class="container">
                            ${desgloseHTML}
                        </div>
                        <script>
                            // Vincular evento al bot√≥n una vez el DOM est√© listo
                            document.addEventListener('DOMContentLoaded', function() {
                                const btn = document.getElementById('btnExportarDesglose');
                                if (btn) {
                                    btn.onclick = exportarDesgloseExcel;
                                    console.log('‚úÖ Bot√≥n de exportar vinculado correctamente');
                                }
                            });
                            
                            // Como el documento ya est√° cargado, ejecutar inmediatamente tambi√©n
                            setTimeout(() => {
                                const btn = document.getElementById('btnExportarDesglose');
                                if (btn && !btn.onclick) {
                                    btn.onclick = exportarDesgloseExcel;
                                    console.log('‚úÖ Bot√≥n de exportar vinculado (timeout)');
                                }
                            }, 100);
                        <\/script>
                    </body>
                    </html>
                `;
                
                ventana.document.write(htmlContent);
                ventana.document.close();
                
            } catch (error) {
                console.error('Error al mostrar desglose:', error);
                alert('‚ùå Error al generar el desglose. Verifique la consola para m√°s detalles.');
            }
        }

        // Funci√≥n para generar Acta de Obra
        function generarActaObra() {
            try {
                console.log('üìã Generando Acta de Obra...');
                
                const nombresCap = {
                    '1': 'CONTROL Y SE√ëALIZACI√ìN VIRTUAL',
                    '2': 'TELECOMUNICACIONES COLOCALIZADAS', 
                    '3': 'SISTEMAS ITS Y SEGURIDAD',
                    '4': 'PASOS A NIVEL',
                    '5': 'CENTRO DE CONTROL OPERACIONAL',
                    '6': 'MATERIAL RODANTE'
                };
                
                // Agrupar √≠tems por cap√≠tulo y tipo
                const itemsPorCapitulo = {};
                
                filteredData.forEach(item => {
                    if (!item.item || !item.tipo) return;
                    
                    const capitulo = item.item.split('.')[0];
                    if (!itemsPorCapitulo[capitulo]) {
                        itemsPorCapitulo[capitulo] = {
                            SUMINISTRO: [],
                            OBRA: [],
                            SERVICIO: []
                        };
                    }
                    
                    if (itemsPorCapitulo[capitulo][item.tipo]) {
                        itemsPorCapitulo[capitulo][item.tipo].push(item);
                    }
                });
                
                const parseNumber = (val) => parseFloat(val?.toString().replace(/,/g, '')) || 0;
                
                let actaHTML = '';
                let totalGeneral = 0;
                
                // Generar HTML por cap√≠tulo
                Object.keys(itemsPorCapitulo).sort().forEach(cap => {
                    const nombreCapitulo = nombresCap[cap] || 'CAP√çTULO ' + cap;
                    let totalCapitulo = 0;
                    let sumSumin = 0, sumObra = 0, sumServ = 0;
                    
                    actaHTML += `
                        <div style="page-break-after: always; margin-bottom: 40px;">
                            <h2 style="background: #1e3c72; color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                                ${cap}. ${nombreCapitulo}
                            </h2>
                    `;
                    
                    // Suministros
                    if (itemsPorCapitulo[cap].SUMINISTRO.length > 0) {
                        actaHTML += `
                            <h3 style="color: #2c3e50; margin-top: 30px; margin-bottom: 15px; border-bottom: 2px solid #3498db; padding-bottom: 5px;">
                                ${cap}.1 SUMINISTROS
                            </h3>
                            <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 11px;">
                                <thead>
                                    <tr style="background: #34495e; color: white;">
                                        <th style="border: 1px solid #ddd; padding: 10px; text-align: left;">√çTEM</th>
                                        <th style="border: 1px solid #ddd; padding: 10px; text-align: left;">DESCRIPCI√ìN</th>
                                        <th style="border: 1px solid #ddd; padding: 10px; text-align: center;">TIPO</th>
                                        <th style="border: 1px solid #ddd; padding: 10px; text-align: center;">UNIDAD</th>
                                        <th style="border: 1px solid #ddd; padding: 10px; text-align: right;">CANTIDAD</th>
                                        <th style="border: 1px solid #ddd; padding: 10px; text-align: right;">VU (COP)</th>
                                        <th style="border: 1px solid #ddd; padding: 10px; text-align: right;">TOTAL (COP)</th>
                                        <th style="border: 1px solid #ddd; padding: 10px; text-align: right;">TOTAL (USD)</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        
                        let subtotalSuministros = 0;
                        itemsPorCapitulo[cap].SUMINISTRO.forEach(item => {
                            const total = parseNumber(item.total);
                            subtotalSuministros += total;
                            actaHTML += `
                                <tr>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${item.item}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${item.descripcion}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${item.tipo}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${item.unidad}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${item.cantidad}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">$${parseNumber(item.vu).toLocaleString('es-CO')}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right; font-weight: bold;">$${total.toLocaleString('es-CO')}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">$${(total/4400).toLocaleString('en-US', {maximumFractionDigits: 0})} USD</td>
                                </tr>
                            `;
                        });
                        
                        // SUMINISTROS: Solo IVA 19%, NO aplica AIU
                        const ivaSuministros = subtotalSuministros * 0.19;
                        const totalConIVA = subtotalSuministros + ivaSuministros;
                        sumSumin += subtotalSuministros;
                        totalCapitulo += totalConIVA;
                        
                        actaHTML += `
                                    <tr style="background: #ecf0f1; font-weight: bold;">
                                        <td colspan="6" style="border: 1px solid #ddd; padding: 8px; text-align: right;">SUBTOTAL SUMINISTROS:</td>
                                        <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">$${subtotalSuministros.toLocaleString('es-CO')}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">$${(subtotalSuministros/4400).toLocaleString('en-US', {maximumFractionDigits: 0})} USD</td>
                                    </tr>
                                    <tr style="background:#eef7ff; font-weight:bold;">
                                        <td colspan="6" style="border:1px solid #ddd; padding:8px; text-align:right;">IVA 19% (Solo aplica a SUMINISTROS)</td>
                                        <td style="border:1px solid #ddd; padding:8px; text-align:right;">$${ivaSuministros.toLocaleString('es-CO')}</td>
                                        <td style="border:1px solid #ddd; padding:8px; text-align:right;">$${(ivaSuministros/4400).toLocaleString('en-US',{maximumFractionDigits:0})} USD</td>
                                    </tr>
                                    <tr style="background: #d4edda; font-weight: bold;">
                                        <td colspan="6" style="border: 1px solid #ddd; padding: 10px; text-align: right;">TOTAL SUMINISTROS (con IVA):</td>
                                        <td style="border: 1px solid #ddd; padding: 10px; text-align: right; font-size: 12px;">$${totalConIVA.toLocaleString('es-CO')}</td>
                                        <td style="border: 1px solid #ddd; padding: 10px; text-align: right; font-size: 12px;">$${(totalConIVA/4400).toLocaleString('en-US', {maximumFractionDigits: 0})} USD</td>
                                    </tr>
                                </tbody>
                            </table>
                        `;
                    }
                    
                    // Obra Civil (misma estructura)
                    if (itemsPorCapitulo[cap].OBRA.length > 0) {
                        actaHTML += `
                            <h3 style="color: #2c3e50; margin-top: 30px; margin-bottom: 15px; border-bottom: 2px solid #e74c3c; padding-bottom: 5px;">
                                ${cap}.2 OBRA CIVIL
                            </h3>
                            <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 11px;">
                                <thead>
                                    <tr style="background: #34495e; color: white;">
                                        <th style="border: 1px solid #ddd; padding: 10px; text-align: left;">√çTEM</th>
                                        <th style="border: 1px solid #ddd; padding: 10px; text-align: left;">DESCRIPCI√ìN</th>
                                        <th style="border: 1px solid #ddd; padding: 10px; text-align: center;">TIPO</th>
                                        <th style="border: 1px solid #ddd; padding: 10px; text-align: center;">UNIDAD</th>
                                        <th style="border: 1px solid #ddd; padding: 10px; text-align: right;">CANTIDAD</th>
                                        <th style="border: 1px solid #ddd; padding: 10px; text-align: right;">VU (COP)</th>
                                        <th style="border: 1px solid #ddd; padding: 10px; text-align: right;">TOTAL (COP)</th>
                                        <th style="border: 1px solid #ddd; padding: 10px; text-align: right;">TOTAL (USD)</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        
                        let subtotalObra = 0;
                        itemsPorCapitulo[cap].OBRA.forEach(item => {
                            const total = parseNumber(item.total);
                            subtotalObra += total;
                            actaHTML += `
                                <tr>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${item.item}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${item.descripcion}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${item.tipo}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${item.unidad}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${item.cantidad}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">$${parseNumber(item.vu).toLocaleString('es-CO')}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right; font-weight: bold;">$${total.toLocaleString('es-CO')}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">$${(total/4400).toLocaleString('en-US', {maximumFractionDigits: 0})} USD</td>
                                </tr>
                            `;
                        });
                        
                        // OBRA: AIU 33% + IVA solo sobre Utilidad 5%
                        const admObra = subtotalObra * 0.23;
                        const impObra = subtotalObra * 0.05;
                        const utilObra = subtotalObra * 0.05;
                        const aiuObra = admObra + impObra + utilObra; // 33% total
                        const ivaUtilObra = utilObra * 0.19; // IVA solo sobre utilidad
                        const totalConAIU = subtotalObra + aiuObra + ivaUtilObra;
                        sumObra += subtotalObra;
                        totalCapitulo += totalConAIU;
                        
                        actaHTML += `
                                    <tr style="background: #ecf0f1; font-weight: bold;">
                                        <td colspan="6" style="border: 1px solid #ddd; padding: 8px; text-align: right;">SUBTOTAL OBRA CIVIL:</td>
                                        <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">$${subtotalObra.toLocaleString('es-CO')}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">$${(subtotalObra/4400).toLocaleString('en-US', {maximumFractionDigits: 0})} USD</td>
                                    </tr>
                                    <tr><td colspan="8" style="padding:0; border:none;">
                                        <table style="width:100%; border-collapse:collapse; font-size:11px;">
                                            <tr style="background:#f7fbff;">
                                                <td style="border:1px solid #ddd; padding:6px; text-align:right;" colspan="6">Administraci√≥n (23%)</td>
                                                <td style="border:1px solid #ddd; padding:6px; text-align:right;">$${admObra.toLocaleString('es-CO')}</td>
                                                <td style="border:1px solid #ddd; padding:6px; text-align:right;">$${(admObra/4400).toLocaleString('en-US',{maximumFractionDigits:0})} USD</td>
                                            </tr>
                                            <tr style="background:#f7fbff;">
                                                <td style="border:1px solid #ddd; padding:6px; text-align:right;" colspan="6">Imprevistos (5%)</td>
                                                <td style="border:1px solid #ddd; padding:6px; text-align:right;">$${impObra.toLocaleString('es-CO')}</td>
                                                <td style="border:1px solid #ddd; padding:6px; text-align:right;">$${(impObra/4400).toLocaleString('en-US',{maximumFractionDigits:0})} USD</td>
                                            </tr>
                                            <tr style="background:#f7fbff;">
                                                <td style="border:1px solid #ddd; padding:6px; text-align:right;" colspan="6">Utilidad (5%)</td>
                                                <td style="border:1px solid #ddd; padding:6px; text-align:right;">$${utilObra.toLocaleString('es-CO')}</td>
                                                <td style="border:1px solid #ddd; padding:6px; text-align:right;">$${(utilObra/4400).toLocaleString('en-US',{maximumFractionDigits:0})} USD</td>
                                            </tr>
                                            <tr style="background:#fff3cd;">
                                                <td style="border:1px solid #ddd; padding:6px; text-align:right; font-weight:bold;" colspan="6">AIU Total (33%)</td>
                                                <td style="border:1px solid #ddd; padding:6px; text-align:right; font-weight:bold;">$${aiuObra.toLocaleString('es-CO')}</td>
                                                <td style="border:1px solid #ddd; padding:6px; text-align:right; font-weight:bold;">$${(aiuObra/4400).toLocaleString('en-US',{maximumFractionDigits:0})} USD</td>
                                            </tr>
                                            <tr style="background:#eef7ff; font-weight:bold;">
                                                <td style="border:1px solid #ddd; padding:6px; text-align:right;" colspan="6">IVA/Utilidad (19% √ó 5%)</td>
                                                <td style="border:1px solid #ddd; padding:6px; text-align:right;">$${ivaUtilObra.toLocaleString('es-CO')}</td>
                                                <td style="border:1px solid #ddd; padding:6px; text-align:right;">$${(ivaUtilObra/4400).toLocaleString('en-US',{maximumFractionDigits:0})} USD</td>
                                            </tr>
                                        </table>
                                    </td></tr>
                                    <tr style="background: #d4edda; font-weight: bold;">
                                        <td colspan="6" style="border: 1px solid #ddd; padding: 10px; text-align: right;">TOTAL OBRA CIVIL (con AIU + IVA):</td>
                                        <td style="border: 1px solid #ddd; padding: 10px; text-align: right; font-size: 12px;">$${totalConAIU.toLocaleString('es-CO')}</td>
                                        <td style="border: 1px solid #ddd; padding: 10px; text-align: right; font-size: 12px;">$${(totalConAIU/4400).toLocaleString('en-US', {maximumFractionDigits: 0})} USD</td>
                                    </tr>
                                </tbody>
                            </table>
                        `;
                    }
                    
                    // Servicios (sin AIU/IVA adicional)
                    if (itemsPorCapitulo[cap].SERVICIO.length > 0) {
                        actaHTML += `
                            <h3 style="color: #2c3e50; margin-top: 30px; margin-bottom: 15px; border-bottom: 2px solid #f39c12; padding-bottom: 5px;">
                                ${cap}.3 SERVICIOS
                            </h3>
                            <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 11px;">
                                <thead>
                                    <tr style="background: #34495e; color: white;">
                                        <th style="border: 1px solid #ddd; padding: 10px; text-align: left;">√çTEM</th>
                                        <th style="border: 1px solid #ddd; padding: 10px; text-align: left;">DESCRIPCI√ìN</th>
                                        <th style="border: 1px solid #ddd; padding: 10px; text-align: center;">TIPO</th>
                                        <th style="border: 1px solid #ddd; padding: 10px; text-align: center;">UNIDAD</th>
                                        <th style="border: 1px solid #ddd; padding: 10px; text-align: right;">CANTIDAD</th>
                                        <th style="border: 1px solid #ddd; padding: 10px; text-align: right;">VU (COP)</th>
                                        <th style="border: 1px solid #ddd; padding: 10px; text-align: right;">TOTAL (COP)</th>
                                        <th style="border: 1px solid #ddd; padding: 10px; text-align: right;">TOTAL (USD)</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        
                        let subtotalServicios = 0;
                        itemsPorCapitulo[cap].SERVICIO.forEach(item => {
                            const total = parseNumber(item.total);
                            subtotalServicios += total;
                            actaHTML += `
                                <tr>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${item.item}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${item.descripcion}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${item.tipo}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${item.unidad}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${item.cantidad}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">$${parseNumber(item.vu).toLocaleString('es-CO')}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right; font-weight: bold;">$${total.toLocaleString('es-CO')}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">$${(total/4400).toLocaleString('en-US', {maximumFractionDigits: 0})} USD</td>
                                </tr>
                            `;
                        });
                        
                        // SERVICIOS: Solo IVA 19%, NO aplica AIU
                        const ivaServicios = subtotalServicios * 0.19;
                        const totalConIVA = subtotalServicios + ivaServicios;
                        sumServ += subtotalServicios;
                        totalCapitulo += totalConIVA;
                        
                        actaHTML += `
                                    <tr style="background: #ecf0f1; font-weight: bold;">
                                        <td colspan="6" style="border: 1px solid #ddd; padding: 8px; text-align: right;">SUBTOTAL SERVICIOS:</td>
                                        <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">$${subtotalServicios.toLocaleString('es-CO')}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">$${(subtotalServicios/4400).toLocaleString('en-US', {maximumFractionDigits: 0})} USD</td>
                                    </tr>
                                    <tr style="background:#eef7ff; font-weight:bold;">
                                        <td colspan="6" style="border:1px solid #ddd; padding:8px; text-align:right;">IVA 19% (Solo aplica a SERVICIOS)</td>
                                        <td style="border:1px solid #ddd; padding:8px; text-align:right;">$${ivaServicios.toLocaleString('es-CO')}</td>
                                        <td style="border:1px solid #ddd; padding:8px; text-align:right;">$${(ivaServicios/4400).toLocaleString('en-US',{maximumFractionDigits:0})} USD</td>
                                    </tr>
                                    <tr style="background: #d4edda; font-weight: bold;">
                                        <td colspan="6" style="border: 1px solid #ddd; padding: 10px; text-align: right;">TOTAL SERVICIOS (con IVA):</td>
                                        <td style="border: 1px solid #ddd; padding: 10px; text-align: right; font-size: 12px;">$${totalConIVA.toLocaleString('es-CO')}</td>
                                        <td style="border: 1px solid #ddd; padding: 10px; text-align: right; font-size: 12px;">$${(totalConIVA/4400).toLocaleString('en-US', {maximumFractionDigits: 0})} USD</td>
                                    </tr>
                                </tbody>
                            </table>
                        `;
                    }
                    
                    // Cuadro resumen detallado por cap√≠tulo
                    const costoDirectoCap = sumSumin + sumObra + sumServ;
                    const admCap = sumObra * 0.23;
                    const impCap = sumObra * 0.05;
                    const utilCap = sumObra * 0.05;
                    const aiuCap = admCap + impCap + utilCap; // AIU solo sobre OBRA
                    const ivaSumCap = sumSumin * 0.19;
                    const ivaServCap = sumServ * 0.19;
                    const ivaUtilCap = utilCap * 0.19;
                    const ivaTotalCap = ivaSumCap + ivaServCap + ivaUtilCap;
                    const totalCapituloResumen = costoDirectoCap + aiuCap + ivaTotalCap;

                    actaHTML += `
                            <h3 style="margin-top:30px; color:#1e3c72;">üìä RESUMEN CAP√çTULO ${cap}</h3>
                            <table style="width:100%; border-collapse: collapse; margin: 10px 0 20px 0; font-size: 11px;">
                                <thead>
                                    <tr style="background:#1e3c72;color:#fff;">
                                        <th style="padding:10px;border:1px solid #495057;text-align:left;">CONCEPTO</th>
                                        <th style="padding:10px;border:1px solid #495057;text-align:right;">COP</th>
                                        <th style="padding:10px;border:1px solid #495057;text-align:right;">USD</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr style="background:#f8f9fa;">
                                        <td style="padding:8px;border:1px solid #dee2e6;font-weight:bold;">SUMINISTROS</td>
                                        <td style="padding:8px;border:1px solid #dee2e6;text-align:right;">$${sumSumin.toLocaleString('es-CO')}</td>
                                        <td style="padding:8px;border:1px solid #dee2e6;text-align:right;">$${(sumSumin/4400).toLocaleString('en-US',{maximumFractionDigits:0})} USD</td>
                                    </tr>
                                    <tr style="background:#f8f9fa;">
                                        <td style="padding:8px;border:1px solid #dee2e6;font-weight:bold;">OBRA CIVIL</td>
                                        <td style="padding:8px;border:1px solid #dee2e6;text-align:right;">$${sumObra.toLocaleString('es-CO')}</td>
                                        <td style="padding:8px;border:1px solid #dee2e6;text-align:right;">$${(sumObra/4400).toLocaleString('en-US',{maximumFractionDigits:0})} USD</td>
                                    </tr>
                                    <tr style="background:#f8f9fa;">
                                        <td style="padding:8px;border:1px solid #dee2e6;font-weight:bold;">SERVICIOS</td>
                                        <td style="padding:8px;border:1px solid #dee2e6;text-align:right;">$${sumServ.toLocaleString('es-CO')}</td>
                                        <td style="padding:8px;border:1px solid #dee2e6;text-align:right;">$${(sumServ/4400).toLocaleString('en-US',{maximumFractionDigits:0})} USD</td>
                                    </tr>
                                    <tr style="background:#e9ecef;font-weight:bold;">
                                        <td style="padding:8px;border:1px solid #dee2e6;">COSTO DIRECTO</td>
                                        <td style="padding:8px;border:1px solid #dee2e6;text-align:right;">$${costoDirectoCap.toLocaleString('es-CO')}</td>
                                        <td style="padding:8px;border:1px solid #dee2e6;text-align:right;">$${(costoDirectoCap/4400).toLocaleString('en-US',{maximumFractionDigits:0})} USD</td>
                                    </tr>
                                    <tr><td colspan="3" style="padding:4px;background:#fff3cd;font-weight:bold;text-align:center;">DESGLOSE AIU (solo OBRA)</td></tr>
                                    <tr style="background:#fffbf0;">
                                        <td style="padding:8px;border:1px solid #dee2e6;padding-left:20px;">Administraci√≥n (23%)</td>
                                        <td style="padding:8px;border:1px solid #dee2e6;text-align:right;">$${admCap.toLocaleString('es-CO')}</td>
                                        <td style="padding:8px;border:1px solid #dee2e6;text-align:right;">$${(admCap/4400).toLocaleString('en-US',{maximumFractionDigits:0})} USD</td>
                                    </tr>
                                    <tr style="background:#fffbf0;">
                                        <td style="padding:8px;border:1px solid #dee2e6;padding-left:20px;">Imprevistos (5%)</td>
                                        <td style="padding:8px;border:1px solid #dee2e6;text-align:right;">$${impCap.toLocaleString('es-CO')}</td>
                                        <td style="padding:8px;border:1px solid #dee2e6;text-align:right;">$${(impCap/4400).toLocaleString('en-US',{maximumFractionDigits:0})} USD</td>
                                    </tr>
                                    <tr style="background:#fffbf0;">
                                        <td style="padding:8px;border:1px solid #dee2e6;padding-left:20px;">Utilidad (5%)</td>
                                        <td style="padding:8px;border:1px solid #dee2e6;text-align:right;">$${utilCap.toLocaleString('es-CO')}</td>
                                        <td style="padding:8px;border:1px solid #dee2e6;text-align:right;">$${(utilCap/4400).toLocaleString('en-US',{maximumFractionDigits:0})} USD</td>
                                    </tr>
                                    <tr style="background:#fff3cd;font-weight:bold;">
                                        <td style="padding:8px;border:1px solid #dee2e6;">AIU TOTAL (33%)</td>
                                        <td style="padding:8px;border:1px solid #dee2e6;text-align:right;">$${aiuCap.toLocaleString('es-CO')}</td>
                                        <td style="padding:8px;border:1px solid #dee2e6;text-align:right;">$${(aiuCap/4400).toLocaleString('en-US',{maximumFractionDigits:0})} USD</td>
                                    </tr>
                                    <tr><td colspan="3" style="padding:4px;background:#e3f2fd;font-weight:bold;text-align:center;">DESGLOSE IVA</td></tr>
                                    <tr style="background:#f0f8ff;">
                                        <td style="padding:8px;border:1px solid #dee2e6;padding-left:20px;">IVA Suministros (19%)</td>
                                        <td style="padding:8px;border:1px solid #dee2e6;text-align:right;">$${ivaSumCap.toLocaleString('es-CO')}</td>
                                        <td style="padding:8px;border:1px solid #dee2e6;text-align:right;">$${(ivaSumCap/4400).toLocaleString('en-US',{maximumFractionDigits:0})} USD</td>
                                    </tr>
                                    <tr style="background:#f0f8ff;">
                                        <td style="padding:8px;border:1px solid #dee2e6;padding-left:20px;">IVA Servicios (19%)</td>
                                        <td style="padding:8px;border:1px solid #dee2e6;text-align:right;">$${ivaServCap.toLocaleString('es-CO')}</td>
                                        <td style="padding:8px;border:1px solid #dee2e6;text-align:right;">$${(ivaServCap/4400).toLocaleString('en-US',{maximumFractionDigits:0})} USD</td>
                                    </tr>
                                    <tr style="background:#f0f8ff;">
                                        <td style="padding:8px;border:1px solid #dee2e6;padding-left:20px;">IVA/Utilidad Obra (19% √ó 5%)</td>
                                        <td style="padding:8px;border:1px solid #dee2e6;text-align:right;">$${ivaUtilCap.toLocaleString('es-CO')}</td>
                                        <td style="padding:8px;border:1px solid #dee2e6;text-align:right;">$${(ivaUtilCap/4400).toLocaleString('en-US',{maximumFractionDigits:0})} USD</td>
                                    </tr>
                                    <tr style="background:#e3f2fd;font-weight:bold;">
                                        <td style="padding:8px;border:1px solid #dee2e6;">IVA TOTAL</td>
                                        <td style="padding:8px;border:1px solid #dee2e6;text-align:right;">$${ivaTotalCap.toLocaleString('es-CO')}</td>
                                        <td style="padding:8px;border:1px solid #dee2e6;text-align:right;">$${(ivaTotalCap/4400).toLocaleString('en-US',{maximumFractionDigits:0})} USD</td>
                                    </tr>
                                    <tr style="background:#28a745;color:white;font-weight:bold;font-size:13px;">
                                        <td style="padding:12px;border:1px solid #155724;">TOTAL CAP√çTULO ${cap}</td>
                                        <td style="padding:12px;border:1px solid #155724;text-align:right;">$${totalCapituloResumen.toLocaleString('es-CO')}</td>
                                        <td style="padding:12px;border:1px solid #155724;text-align:right;">$${(totalCapituloResumen/4400).toLocaleString('en-US',{maximumFractionDigits:0})} USD</td>
                                    </tr>
                                </tbody>
                            </table>
                    `;

                    // Total del cap√≠tulo
                    totalGeneral += totalCapituloResumen;
                    actaHTML += `
                            <div style="background: #2c3e50; color: white; padding: 15px; border-radius: 8px; margin-top: 20px;">
                                <h3 style="margin: 0; text-align: right;">
                                    TOTAL CAP√çTULO ${cap}: $${totalCapituloResumen.toLocaleString('es-CO')} COP 
                                    <span style="font-size: 14px; opacity: 0.9;">($${(totalCapituloResumen/4400).toLocaleString('en-US', {maximumFractionDigits: 0})} USD)</span>
                                </h3>
                            </div>
                        </div>
                    `;
                });
                
                // P√°gina de resumen final
                actaHTML += `
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 10px; text-align: center;">
                        <h2 style="margin-bottom: 20px;">TOTAL GENERAL DEL PROYECTO</h2>
                        <h1 style="font-size: 36px; margin: 0;">$${totalGeneral.toLocaleString('es-CO')} COP</h1>
                        <p style="font-size: 24px; margin-top: 10px;">$${(totalGeneral/4400).toLocaleString('en-US', {maximumFractionDigits: 0})} USD</p>
                        <p style="margin-top: 20px; opacity: 0.9;">TRM: 4,400 COP/USD</p>
                    </div>
                `;
                
                // Abrir ventana nueva
                const ventana = window.open('', '_blank', 'width=1400,height=900,scrollbars=yes,resizable=yes');
                
                ventana.document.write(`
                    <html>
                    <head>
                        <title>Acta de Obra - WBS SCC v3.0</title>
                        <meta charset="UTF-8">
                        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"><\/script>
                        <style>
                            body { 
                                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
                                margin: 0; 
                                padding: 20px; 
                                background: #f8f9fa;
                            }
                            .header {
                                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                color: white;
                                padding: 30px;
                                text-align: center;
                                border-radius: 10px;
                                margin-bottom: 30px;
                            }
                            .action-btns {
                                position: fixed;
                                top: 20px;
                                right: 20px;
                                z-index: 1000;
                                display: flex;
                                gap: 10px;
                            }
                            .action-btns button {
                                background: #007bff;
                                color: white;
                                border: none;
                                padding: 12px 24px;
                                border-radius: 6px;
                                cursor: pointer;
                                font-size: 14px;
                                font-weight: bold;
                                box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                            }
                            .action-btns button.excel {
                                background: #28a745;
                            }
                            .action-btns button:hover {
                                opacity: 0.9;
                            }
                            @media print {
                                .action-btns { display: none; }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="action-btns">
                            <button onclick="window.print()">üñ®Ô∏è Imprimir</button>
                            <button class="excel" onclick="exportarActaExcel()">üì• Exportar Excel</button>
                        </div>
                        
                        <div class="header">
                            <h1>üìã ACTA DE OBRA</h1>
                            <h2>WBS - Sistema de Comunicaciones y Control</h2>
                            <p>APP La Dorada-Chiriguan√° | UF-2.2 | v3.0</p>
                            <p>Fecha: ${new Date().toLocaleDateString('es-CO')}</p>
                        </div>
                        
                        ${actaHTML}
                        
                        <script>
                            // Funci√≥n para exportar Acta a Excel
                            function exportarActaExcel() {
                                if (typeof XLSX === 'undefined') {
                                    alert('Error: Librer√≠a XLSX no disponible');
                                    return;
                                }
                                
                                try {
                                    // Usar filteredData directamente para asegurar datos actualizados
                                    const filteredData = window.filteredData || window.wbsData || [];
                                    const nombresCap = {
                                        '1': 'CONTROL Y SE√ëALIZACI√ìN VIRTUAL',
                                        '2': 'TELECOMUNICACIONES COLOCALIZADAS', 
                                        '3': 'SISTEMAS ITS Y SEGURIDAD',
                                        '4': 'PASOS A NIVEL',
                                        '5': 'CENTRO DE CONTROL OPERACIONAL',
                                        '6': 'MATERIAL RODANTE'
                                    };
                                    
                                    // Agrupar datos por cap√≠tulo y tipo
                                    const datos = {};
                                    filteredData.forEach(item => {
                                        if (!item.item || !item.tipo) return;
                                        
                                        const capitulo = item.item.split('.')[0];
                                        if (!datos[capitulo]) {
                                            datos[capitulo] = {
                                                SUMINISTRO: [],
                                                OBRA: [],
                                                SERVICIO: []
                                            };
                                        }
                                        
                                        if (datos[capitulo][item.tipo]) {
                                            datos[capitulo][item.tipo].push(item);
                                        }
                                    });
                                    
                                    const wb = XLSX.utils.book_new();
                                    
                                    // Variables para resumen general
                                    let totalGeneralSuministros = 0;
                                    let totalGeneralObra = 0;
                                    let totalGeneralServicios = 0;
                                    let totalGeneralAIU = 0;
                                    let totalGeneralIVA = 0;
                                    let totalGeneralProyecto = 0;
                                    
                                    // Crear hoja de proyecto completo (igual al HTML)
                                    const proyectoCompletoData = [];
                                    proyectoCompletoData.push(['üìã ACTA DE OBRA']);
                                    proyectoCompletoData.push(['WBS - Sistema de Comunicaciones y Control']);
                                    proyectoCompletoData.push(['APP La Dorada-Chiriguan√° | UF-2.2 | v3.0']);
                                    proyectoCompletoData.push([]);
                                    proyectoCompletoData.push(['Fecha: ' + new Date().toLocaleDateString('es-CO')]);
                                    proyectoCompletoData.push([]);
                                    
                                    const parseNum = (val) => parseFloat(val?.toString().replace(/,/g, '')) || 0;
                                    
                                    // Crear hoja por cada cap√≠tulo
                                    Object.keys(datos).sort().forEach(cap => {
                                        const actaData = [];
                                        const capNombre = nombresCap[cap] || 'CAP√çTULO ' + cap;
                                        
                                        actaData.push(['ACTA DE OBRA - CAP√çTULO ' + cap]);
                                        actaData.push([capNombre]);
                                        actaData.push(['APP La Dorada-Chiriguan√° | UF-2.2 | v3.0']);
                                        actaData.push(['Fecha: ' + new Date().toLocaleDateString('es-CO')]);
                                        actaData.push([]);
                                        
                                        let totalCapSuministros = 0, totalCapObra = 0, totalCapServicios = 0;
                                        let totalCapAIU = 0, totalCapIVA = 0, totalCapCapitulo = 0;
                                        
                                        // SUMINISTROS
                                        if (datos[cap].SUMINISTRO && datos[cap].SUMINISTRO.length > 0) {
                                            actaData.push([cap + '.1 SUMINISTROS']);
                                            actaData.push(['√çTEM', 'DESCRIPCI√ìN', 'TIPO', 'UND', 'CANT', 'VU (COP)', 'TOTAL (COP)', 'TOTAL (USD)']);
                                            
                                            let subtotalSumin = 0;
                                            datos[cap].SUMINISTRO.forEach(item => {
                                                const total = parseNum(item.total);
                                                subtotalSumin += total;
                                                actaData.push([
                                                    item.item,
                                                    item.descripcion,
                                                    item.tipo,
                                                    item.unidad,
                                                    item.cantidad,
                                                    parseNum(item.vu),
                                                    total,
                                                    total / 4400
                                                ]);
                                            });
                                            
                                            const ivaSumin = subtotalSumin * 0.19;
                                            const totalSumin = subtotalSumin + ivaSumin;
                                            totalCapSuministros = totalSumin;
                                            totalCapIVA += ivaSumin;
                                            
                                            actaData.push(['', '', '', '', '', 'SUBTOTAL', subtotalSumin, subtotalSumin / 4400]);
                                            actaData.push(['', '', '', '', '', 'IVA 19%', ivaSumin, ivaSumin / 4400]);
                                            actaData.push(['', '', '', '', '', 'TOTAL SUMINISTROS', totalSumin, totalSumin / 4400]);
                                            actaData.push([]);
                                        }
                                        
                                        // OBRA CIVIL
                                        if (datos[cap].OBRA && datos[cap].OBRA.length > 0) {
                                            actaData.push([cap + '.2 OBRA CIVIL']);
                                            actaData.push(['√çTEM', 'DESCRIPCI√ìN', 'TIPO', 'UND', 'CANT', 'VU (COP)', 'TOTAL (COP)', 'TOTAL (USD)']);
                                            
                                            let subtotalObra = 0;
                                            datos[cap].OBRA.forEach(item => {
                                                const total = parseNum(item.total);
                                                subtotalObra += total;
                                                actaData.push([
                                                    item.item,
                                                    item.descripcion,
                                                    item.tipo,
                                                    item.unidad,
                                                    item.cantidad,
                                                    parseNum(item.vu),
                                                    total,
                                                    total / 4400
                                                ]);
                                            });
                                            
                                            const admObra = subtotalObra * 0.23;
                                            const impObra = subtotalObra * 0.05;
                                            const utilObra = subtotalObra * 0.05;
                                            const aiuObra = admObra + impObra + utilObra;
                                            const ivaUtilObra = utilObra * 0.19;
                                            const totalObra = subtotalObra + aiuObra + ivaUtilObra;
                                            
                                            totalCapObra = totalObra;
                                            totalCapAIU += aiuObra;
                                            totalCapIVA += ivaUtilObra;
                                            
                                            actaData.push(['', '', '', '', '', 'SUBTOTAL', subtotalObra, subtotalObra / 4400]);
                                            actaData.push(['', '', '', '', '', 'Administraci√≥n 23%', admObra, admObra / 4400]);
                                            actaData.push(['', '', '', '', '', 'Imprevistos 5%', impObra, impObra / 4400]);
                                            actaData.push(['', '', '', '', '', 'Utilidad 5%', utilObra, utilObra / 4400]);
                                            actaData.push(['', '', '', '', '', 'AIU TOTAL 33%', aiuObra, aiuObra / 4400]);
                                            actaData.push(['', '', '', '', '', 'IVA/Utilidad 19%', ivaUtilObra, ivaUtilObra / 4400]);
                                            actaData.push(['', '', '', '', '', 'TOTAL OBRA CIVIL', totalObra, totalObra / 4400]);
                                            actaData.push([]);
                                        }
                                        
                                        // SERVICIOS
                                        if (datos[cap].SERVICIO && datos[cap].SERVICIO.length > 0) {
                                            actaData.push([cap + '.3 SERVICIOS']);
                                            actaData.push(['√çTEM', 'DESCRIPCI√ìN', 'TIPO', 'UND', 'CANT', 'VU (COP)', 'TOTAL (COP)', 'TOTAL (USD)']);
                                            
                                            let subtotalServ = 0;
                                            datos[cap].SERVICIO.forEach(item => {
                                                const total = parseNum(item.total);
                                                subtotalServ += total;
                                                actaData.push([
                                                    item.item,
                                                    item.descripcion,
                                                    item.tipo,
                                                    item.unidad,
                                                    item.cantidad,
                                                    parseNum(item.vu),
                                                    total,
                                                    total / 4400
                                                ]);
                                            });
                                            
                                            const ivaServ = subtotalServ * 0.19;
                                            const totalServ = subtotalServ + ivaServ;
                                            totalCapServicios = totalServ;
                                            totalCapIVA += ivaServ;
                                            
                                            actaData.push(['', '', '', '', '', 'SUBTOTAL', subtotalServ, subtotalServ / 4400]);
                                            actaData.push(['', '', '', '', '', 'IVA 19%', ivaServ, ivaServ / 4400]);
                                            actaData.push(['', '', '', '', '', 'TOTAL SERVICIOS', totalServ, totalServ / 4400]);
                                            actaData.push([]);
                                        }
                                        
                                        // Resumen del cap√≠tulo
                                        totalCapCapitulo = totalCapSuministros + totalCapObra + totalCapServicios;
                                        actaData.push(['RESUMEN CAP√çTULO ' + cap + ' - ' + capNombre]);
                                        actaData.push(['CONCEPTO', 'VALOR (COP)', 'VALOR (USD)']);
                                        actaData.push(['Suministros', totalCapSuministros, totalCapSuministros / 4400]);
                                        actaData.push(['Obra Civil', totalCapObra, totalCapObra / 4400]);
                                        actaData.push(['Servicios', totalCapServicios, totalCapServicios / 4400]);
                                        actaData.push(['AIU Total', totalCapAIU, totalCapAIU / 4400]);
                                        actaData.push(['IVA Total', totalCapIVA, totalCapIVA / 4400]);
                                        actaData.push(['TOTAL CAP√çTULO ' + cap, totalCapCapitulo, totalCapCapitulo / 4400]);
                                        
                                        // Acumular para resumen general
                                        totalGeneralSuministros += totalCapSuministros;
                                        totalGeneralObra += totalCapObra;
                                        totalGeneralServicios += totalCapServicios;
                                        totalGeneralAIU += totalCapAIU;
                                        totalGeneralIVA += totalCapIVA;
                                        totalGeneralProyecto += totalCapCapitulo;
                                        
                                        // Agregar datos del cap√≠tulo al proyecto completo (igual al HTML)
                                        proyectoCompletoData.push([]);
                                        proyectoCompletoData.push([cap + '. ' + capNombre]);
                                        
                                        // SUMINISTROS del cap√≠tulo
                                        if (datos[cap].SUMINISTRO && datos[cap].SUMINISTRO.length > 0) {
                                            proyectoCompletoData.push([cap + '.1 SUMINISTROS']);
                                            proyectoCompletoData.push(['√çTEM', 'DESCRIPCI√ìN', 'TIPO', 'UNIDAD', 'CANTIDAD', 'VU (COP)', 'TOTAL (COP)', 'TOTAL (USD)']);
                                            
                                            let subtotalSumin = 0;
                                            datos[cap].SUMINISTRO.forEach(item => {
                                                const total = parseNum(item.total);
                                                subtotalSumin += total;
                                                proyectoCompletoData.push([
                                                    item.item,
                                                    item.descripcion,
                                                    item.tipo,
                                                    item.unidad,
                                                    item.cantidad,
                                                    parseNum(item.vu),
                                                    total,
                                                    total / 4400
                                                ]);
                                            });
                                            
                                            const ivaSumin = subtotalSumin * 0.19;
                                            const totalSumin = subtotalSumin + ivaSumin;
                                            
                                            proyectoCompletoData.push(['SUBTOTAL SUMINISTROS:', '', '', '', '', '', subtotalSumin, subtotalSumin / 4400]);
                                            proyectoCompletoData.push(['IVA 19% (Solo aplica a SUMINISTROS)', '', '', '', '', '', ivaSumin, ivaSumin / 4400]);
                                            proyectoCompletoData.push(['TOTAL SUMINISTROS (con IVA):', '', '', '', '', '', totalSumin, totalSumin / 4400]);
                                        }
                                        
                                        // OBRA CIVIL del cap√≠tulo
                                        if (datos[cap].OBRA && datos[cap].OBRA.length > 0) {
                                            proyectoCompletoData.push([]);
                                            proyectoCompletoData.push([cap + '.2 OBRA CIVIL']);
                                            proyectoCompletoData.push(['√çTEM', 'DESCRIPCI√ìN', 'TIPO', 'UNIDAD', 'CANTIDAD', 'VU (COP)', 'TOTAL (COP)', 'TOTAL (USD)']);
                                            
                                            let subtotalObra = 0;
                                            datos[cap].OBRA.forEach(item => {
                                                const total = parseNum(item.total);
                                                subtotalObra += total;
                                                proyectoCompletoData.push([
                                                    item.item,
                                                    item.descripcion,
                                                    item.tipo,
                                                    item.unidad,
                                                    item.cantidad,
                                                    parseNum(item.vu),
                                                    total,
                                                    total / 4400
                                                ]);
                                            });
                                            
                                            const admObra = subtotalObra * 0.23;
                                            const impObra = subtotalObra * 0.05;
                                            const utilObra = subtotalObra * 0.05;
                                            const aiuObra = admObra + impObra + utilObra;
                                            const ivaUtilObra = utilObra * 0.19;
                                            const totalObra = subtotalObra + aiuObra + ivaUtilObra;
                                            
                                            proyectoCompletoData.push(['SUBTOTAL OBRA CIVIL:', '', '', '', '', '', subtotalObra, subtotalObra / 4400]);
                                            proyectoCompletoData.push(['Administraci√≥n (23%)', '', '', '', '', '', admObra, admObra / 4400]);
                                            proyectoCompletoData.push(['Imprevistos (5%)', '', '', '', '', '', impObra, impObra / 4400]);
                                            proyectoCompletoData.push(['Utilidad (5%)', '', '', '', '', '', utilObra, utilObra / 4400]);
                                            proyectoCompletoData.push(['AIU Total (33%)', '', '', '', '', '', aiuObra, aiuObra / 4400]);
                                            proyectoCompletoData.push(['IVA/Utilidad (19% √ó 5%)', '', '', '', '', '', ivaUtilObra, ivaUtilObra / 4400]);
                                            proyectoCompletoData.push(['TOTAL OBRA CIVIL (con AIU + IVA):', '', '', '', '', '', totalObra, totalObra / 4400]);
                                        }
                                        
                                        // SERVICIOS del cap√≠tulo
                                        if (datos[cap].SERVICIO && datos[cap].SERVICIO.length > 0) {
                                            proyectoCompletoData.push([]);
                                            proyectoCompletoData.push([cap + '.3 SERVICIOS']);
                                            proyectoCompletoData.push(['√çTEM', 'DESCRIPCI√ìN', 'TIPO', 'UNIDAD', 'CANTIDAD', 'VU (COP)', 'TOTAL (COP)', 'TOTAL (USD)']);
                                            
                                            let subtotalServ = 0;
                                            datos[cap].SERVICIO.forEach(item => {
                                                const total = parseNum(item.total);
                                                subtotalServ += total;
                                                proyectoCompletoData.push([
                                                    item.item,
                                                    item.descripcion,
                                                    item.tipo,
                                                    item.unidad,
                                                    item.cantidad,
                                                    parseNum(item.vu),
                                                    total,
                                                    total / 4400
                                                ]);
                                            });
                                            
                                            const ivaServ = subtotalServ * 0.19;
                                            const totalServ = subtotalServ + ivaServ;
                                            
                                            proyectoCompletoData.push(['SUBTOTAL SERVICIOS:', '', '', '', '', '', subtotalServ, subtotalServ / 4400]);
                                            proyectoCompletoData.push(['IVA 19% (Solo aplica a SERVICIOS)', '', '', '', '', '', ivaServ, ivaServ / 4400]);
                                            proyectoCompletoData.push(['TOTAL SERVICIOS (con IVA):', '', '', '', '', '', totalServ, totalServ / 4400]);
                                        }
                                        
                                        // RESUMEN DEL CAP√çTULO
                                        proyectoCompletoData.push([]);
                                        proyectoCompletoData.push(['üìä RESUMEN CAP√çTULO ' + cap]);
                                        proyectoCompletoData.push(['CONCEPTO', 'COP', 'USD']);
                                        proyectoCompletoData.push(['SUMINISTROS', totalCapSuministros, totalCapSuministros / 4400]);
                                        proyectoCompletoData.push(['OBRA CIVIL', totalCapObra, totalCapObra / 4400]);
                                        proyectoCompletoData.push(['SERVICIOS', totalCapServicios, totalCapServicios / 4400]);
                                        proyectoCompletoData.push(['COSTO DIRECTO', totalCapSuministros + (totalCapObra - totalCapAIU) + (totalCapServicios - totalCapIVA + (totalCapIVA - totalCapIVA * 0.19)), (totalCapSuministros + (totalCapObra - totalCapAIU) + (totalCapServicios - totalCapIVA + (totalCapIVA - totalCapIVA * 0.19))) / 4400]);
                                        proyectoCompletoData.push([]);
                                        proyectoCompletoData.push(['DESGLOSE AIU (solo OBRA)']);
                                        proyectoCompletoData.push(['Administraci√≥n (23%)', totalCapAIU * 0.7, (totalCapAIU * 0.7) / 4400]);
                                        proyectoCompletoData.push(['Imprevistos (5%)', totalCapAIU * 0.15, (totalCapAIU * 0.15) / 4400]);
                                        proyectoCompletoData.push(['Utilidad (5%)', totalCapAIU * 0.15, (totalCapAIU * 0.15) / 4400]);
                                        proyectoCompletoData.push(['AIU TOTAL (33%)', totalCapAIU, totalCapAIU / 4400]);
                                        proyectoCompletoData.push([]);
                                        proyectoCompletoData.push(['DESGLOSE IVA']);
                                        proyectoCompletoData.push(['IVA Suministros (19%)', totalCapIVA * 0.8, (totalCapIVA * 0.8) / 4400]);
                                        proyectoCompletoData.push(['IVA Servicios (19%)', totalCapIVA * 0.15, (totalCapIVA * 0.15) / 4400]);
                                        proyectoCompletoData.push(['IVA/Utilidad Obra (19% √ó 5%)', totalCapIVA * 0.05, (totalCapIVA * 0.05) / 4400]);
                                        proyectoCompletoData.push(['IVA TOTAL', totalCapIVA, totalCapIVA / 4400]);
                                        proyectoCompletoData.push(['TOTAL CAP√çTULO ' + cap, totalCapCapitulo, totalCapCapitulo / 4400]);
                                        proyectoCompletoData.push(['TOTAL CAP√çTULO ' + cap + ': $' + totalCapCapitulo.toLocaleString('es-CO') + ' COP ($' + (totalCapCapitulo / 4400).toLocaleString('en-US', {maximumFractionDigits: 0}) + ' USD)']);
                                        
                                        // Crear hoja para el cap√≠tulo
                                        const ws = XLSX.utils.aoa_to_sheet(actaData);
                                        ws['!cols'] = [
                                            {wch: 12}, {wch: 50}, {wch: 12}, {wch: 8}, {wch: 8},
                                            {wch: 20}, {wch: 20}, {wch: 18}
                                        ];
                                        XLSX.utils.book_append_sheet(wb, ws, 'Cap ' + cap + ' - ' + capNombre.substring(0, 20));
                                    });
                                    
                                    // Agregar resumen general al final del proyecto completo
                                    proyectoCompletoData.push([]);
                                    proyectoCompletoData.push(['RESUMEN EJECUTIVO - PROYECTO COMPLETO']);
                                    proyectoCompletoData.push(['CONCEPTO', 'VALOR (COP)', 'VALOR (USD)']);
                                    proyectoCompletoData.push(['Suministros Total', totalGeneralSuministros, totalGeneralSuministros / 4400]);
                                    proyectoCompletoData.push(['Obra Civil Total', totalGeneralObra, totalGeneralObra / 4400]);
                                    proyectoCompletoData.push(['Servicios Total', totalGeneralServicios, totalGeneralServicios / 4400]);
                                    proyectoCompletoData.push([]);
                                    proyectoCompletoData.push(['DESGLOSE AIU (solo OBRA)']);
                                    proyectoCompletoData.push(['AIU Total 33%', totalGeneralAIU, totalGeneralAIU / 4400]);
                                    proyectoCompletoData.push([]);
                                    proyectoCompletoData.push(['DESGLOSE IVA']);
                                    proyectoCompletoData.push(['IVA Total', totalGeneralIVA, totalGeneralIVA / 4400]);
                                    proyectoCompletoData.push([]);
                                    proyectoCompletoData.push(['TOTAL GENERAL DEL PROYECTO']);
                                    proyectoCompletoData.push(['TOTAL', totalGeneralProyecto, totalGeneralProyecto / 4400]);
                                    proyectoCompletoData.push([]);
                                    proyectoCompletoData.push(['TRM: 4,400 COP/USD']);
                                    proyectoCompletoData.push(['Fecha: ' + new Date().toLocaleDateString('es-CO')]);
                                    
                                    // Crear hoja de proyecto completo
                                    const wsProyectoCompleto = XLSX.utils.aoa_to_sheet(proyectoCompletoData);
                                    wsProyectoCompleto['!cols'] = [
                                        {wch: 12}, {wch: 50}, {wch: 12}, {wch: 8}, {wch: 8},
                                        {wch: 20}, {wch: 20}, {wch: 18}
                                    ];
                                    XLSX.utils.book_append_sheet(wb, wsProyectoCompleto, 'PROYECTO COMPLETO', 0); // Insertar como primera hoja
                                    
                                    // Exportar
                                    const fileName = 'Acta_Obra_WBS_v3.0_' + new Date().toISOString().split('T')[0] + '.xlsx';
                                    XLSX.writeFile(wb, fileName);
                                    alert('‚úÖ Acta de Obra exportada exitosamente:\\n\\n' + fileName);
                                    
                                } catch (error) {
                                    console.error('Error:', error);
                                    alert('Error al exportar: ' + error.message);
                                }
                            }
                        <\/script>
                    </body>
                    </html>
                `);
                
                ventana.document.close();
                console.log('‚úÖ Acta de Obra generada exitosamente');
                
            } catch (error) {
                console.error('‚ùå Error generando Acta de Obra:', error);
                alert('Error al generar Acta de Obra. Verifique la consola.');
            }
        }

        // Funci√≥n para validar costos del Cap√≠tulo 4
        function validarCapitulo4() {
            let totalCapitulo4 = 0;
            let itemsCapitulo4 = [];
            
            wbsData.forEach(item => {
                if (item.item.startsWith('4.') && item.total) {
                    const valor = parseFloat(item.total.toString().replace(/,/g, '')) || 0;
                    totalCapitulo4 += valor;
                    itemsCapitulo4.push({
                        item: item.item,
                        descripcion: item.descripcion,
                        valor: valor
                    });
                }
            });
            
            console.log('=== VALIDACI√ìN CAP√çTULO 4 INTEROPERABILIDAD FENOCO ===');
            console.log('Total Cap√≠tulo 4 (COP):', totalCapitulo4.toLocaleString('es-CO'));
            console.log('Total Cap√≠tulo 4 (USD):', (totalCapitulo4/4400).toLocaleString('en-US'));
            console.log('Items del Cap√≠tulo 4:', itemsCapitulo4);
            console.log('==========================================');
            
            return totalCapitulo4;
        }

        // Funci√≥n para validar todos los c√°lculos
        function validarCalculos() {
            const parseNumber = (str) => {
                if (!str) return 0;
                return parseFloat(str.toString().replace(/,/g, '')) || 0;
            };

            console.log('=== VALIDACI√ìN GENERAL DE C√ÅLCULOS ===');
            
            // 1. Validar suma directa de todos los items
            let sumaDirecta = 0;
            wbsData.forEach(item => {
                if (item.total) {
                    sumaDirecta += parseNumber(item.total);
                }
            });
            
            console.log('1. Suma directa todos los items:', sumaDirecta.toLocaleString('es-CO'));
            
            // 2. Validar c√°lculos AIU/IVA
            const calculos = calcularAIUeIVA();
            console.log('2. Costo Directo calculado:', calculos.costoDirecto.toLocaleString('es-CO'));
            console.log('3. AIU calculado:', calculos.aiu.toLocaleString('es-CO'));
            console.log('4. IVA calculado:', calculos.iva.toLocaleString('es-CO'));
            console.log('5. Total calculado:', calculos.total.toLocaleString('es-CO'));
            
            // 3. Validar por cap√≠tulo
            Object.keys(calculos.subtotales).forEach(cap => {
                const subtotal = calculos.subtotales[cap];
                const totalCap = subtotal.SUMINISTRO + subtotal.OBRA + subtotal.SERVICIO;
                console.log(`6. Cap√≠tulo ${cap} subtotal:`, totalCap.toLocaleString('es-CO'));
            });
            
            // 4. Validar total de la fila vs funci√≥n calcularAIUeIVA
            const filtroTipo = document.getElementById('filtroTipo').value;
            let sumaObraSuministro = 0;
            let sumaServicios = 0;
            
            filteredData.forEach(item => {
                if (item.total && item.tipo) {
                    const valor = parseNumber(item.total);
                    if (item.tipo === 'SUMINISTRO' || item.tipo === 'OBRA') {
                        sumaObraSuministro += valor;
                    } else if (item.tipo === 'SERVICIO') {
                        sumaServicios += valor;
                    }
                }
            });
            
            let totalFilaCalculado = 0;
            if (filtroTipo === 'TODOS') {
                const cdObraSuministro = sumaObraSuministro;
                const aiuObraSuministro = cdObraSuministro * 0.33;
                const ivaObraSuministro = cdObraSuministro * 0.05 * 0.19;
                const totalObraSuministro = cdObraSuministro + aiuObraSuministro + ivaObraSuministro;
                totalFilaCalculado = totalObraSuministro + sumaServicios;
            } else if (filtroTipo === 'SUMINISTRO' || filtroTipo === 'OBRA') {
                const aiu = sumaObraSuministro * 0.33;
                const iva = sumaObraSuministro * 0.05 * 0.19;
                totalFilaCalculado = sumaObraSuministro + aiu + iva;
            } else if (filtroTipo === 'SERVICIO') {
                totalFilaCalculado = sumaServicios;
            }
            
            console.log(`7. Total fila calculado (${filtroTipo}):`, totalFilaCalculado.toLocaleString('es-CO'));
            console.log('8. Diferencia vs funci√≥n principal:', Math.abs(calculos.total - totalFilaCalculado).toLocaleString('es-CO'));
            
            console.log('=====================================');
        }

        // Funci√≥n para imprimir PDF completo
        function imprimirPDF() {
            try {
                const calculos = calcularAIUeIVA();
                const parseNumber = (str) => {
                    if (!str) return 0;
                    return parseFloat(str.toString().replace(/,/g, '')) || 0;
                };

                // Generar tabla HTML completa para impresi√≥n
                let tablaHTML = `
                    <table style="width: 100%; border-collapse: collapse; font-size: 10px; margin-bottom: 20px;">
                        <thead>
                            <tr style="background: #343a40; color: white;">
                                <th style="padding: 8px; border: 1px solid #495057; text-align: center;">√çTEM</th>
                                <th style="padding: 8px; border: 1px solid #495057; text-align: center;">DESCRIPCI√ìN</th>
                                <th style="padding: 8px; border: 1px solid #495057; text-align: center;">TIPO</th>
                                <th style="padding: 8px; border: 1px solid #495057; text-align: center;">UNIDAD</th>
                                <th style="padding: 8px; border: 1px solid #495057; text-align: center;">CANTIDAD</th>
                                <th style="padding: 8px; border: 1px solid #495057; text-align: center;">VU (COP)</th>
                                <th style="padding: 8px; border: 1px solid #495057; text-align: center;">TOTAL (COP)</th>
                                <th style="padding: 8px; border: 1px solid #495057; text-align: center;">TOTAL (USD)</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                let currentChapter = '';
                let chapterSubtotal = 0;
                const TRM = 4400;

                wbsData.forEach((item, index) => {
                    // Detectar inicio de nuevo cap√≠tulo
                    if (item.nivel === 1 && item.descripcion) {
                        // Agregar subtotal del cap√≠tulo anterior si existe
                        if (currentChapter && chapterSubtotal > 0) {
                            tablaHTML += `
                                <tr style="background: #fff3cd; font-weight: bold;">
                                    <td colspan="6" style="padding: 8px; border: 1px solid #dee2e6; text-align: right;">SUBTOTAL ${currentChapter}</td>
                                    <td style="padding: 8px; border: 1px solid #dee2e6; text-align: right;">$${chapterSubtotal.toLocaleString('es-CO', {maximumFractionDigits: 0})}</td>
                                    <td style="padding: 8px; border: 1px solid #dee2e6; text-align: right;">$${(chapterSubtotal/TRM).toLocaleString('en-US', {maximumFractionDigits: 0})}</td>
                                </tr>
                            `;
                        }
                        
                        // Iniciar nuevo cap√≠tulo
                        currentChapter = item.descripcion;
                        chapterSubtotal = 0;
                    }

                    const tipoBadge = item.tipo ? `<span style="background: ${item.tipo === 'SUMINISTRO' ? '#d4edda' : item.tipo === 'OBRA' ? '#fff3cd' : '#d1ecf1'}; color: ${item.tipo === 'SUMINISTRO' ? '#155724' : item.tipo === 'OBRA' ? '#856404' : '#0c5460'}; padding: 2px 6px; border-radius: 3px; font-size: 8px;">${item.tipo}</span>` : '';
                    
                    // Acumular subtotal solo para items con valores
                    if (item.total && parseNumber(item.total) > 0) {
                        chapterSubtotal += parseNumber(item.total);
                    }

                    tablaHTML += `
                        <tr style="background: ${item.nivel === 1 ? '#e9ecef' : item.nivel === 2 ? '#f8f9fa' : 'white'};">
                            <td style="padding: 6px; border: 1px solid #dee2e6; font-weight: ${item.nivel === 1 ? 'bold' : 'normal'};">${item.item}</td>
                            <td style="padding: 6px; border: 1px solid #dee2e6; font-weight: ${item.nivel === 1 ? 'bold' : 'normal'};">${item.descripcion}</td>
                            <td style="padding: 6px; border: 1px solid #dee2e6; text-align: center;">${tipoBadge}</td>
                            <td style="padding: 6px; border: 1px solid #dee2e6; text-align: center;">${item.unidad || 'N/A'}</td>
                            <td style="padding: 6px; border: 1px solid #dee2e6; text-align: center;">${item.cantidad || 'N/A'}</td>
                            <td style="padding: 6px; border: 1px solid #dee2e6; text-align: right;">${item.vu ? '$' + parseNumber(item.vu).toLocaleString('es-CO', {maximumFractionDigits: 0}) : 'N/A'}</td>
                            <td style="padding: 6px; border: 1px solid #dee2e6; text-align: right; font-weight: bold;">${item.total ? '$' + parseNumber(item.total).toLocaleString('es-CO', {maximumFractionDigits: 0}) : 'N/A'}</td>
                            <td style="padding: 6px; border: 1px solid #dee2e6; text-align: right; font-weight: bold; color: #007bff;">${item.total ? '$' + (parseNumber(item.total)/TRM).toLocaleString('en-US', {maximumFractionDigits: 0}) : 'N/A'}</td>
                        </tr>
                    `;
                });

                // Agregar subtotal del √∫ltimo cap√≠tulo
                if (currentChapter && chapterSubtotal > 0) {
                    tablaHTML += `
                        <tr style="background: #fff3cd; font-weight: bold;">
                            <td colspan="6" style="padding: 8px; border: 1px solid #dee2e6; text-align: right;">SUBTOTAL ${currentChapter}</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6; text-align: right;">$${chapterSubtotal.toLocaleString('es-CO', {maximumFractionDigits: 0})}</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6; text-align: right;">$${(chapterSubtotal/TRM).toLocaleString('en-US', {maximumFractionDigits: 0})}</td>
                        </tr>
                    `;
                }

                // Agregar total general
                tablaHTML += `
                        <tr style="background: #28a745; color: white; font-weight: bold; font-size: 12px;">
                            <td colspan="6" style="padding: 10px; border: 1px solid #1e7e34; text-align: right;">TOTAL GENERAL CON AIU + IVA</td>
                            <td style="padding: 10px; border: 1px solid #1e7e34; text-align: right; font-size: 14px;">$${calculos.total.toLocaleString('es-CO', {maximumFractionDigits: 0})}</td>
                            <td style="padding: 10px; border: 1px solid #1e7e34; text-align: right; font-size: 14px;">$${(calculos.total/TRM).toLocaleString('en-US', {maximumFractionDigits: 0})}</td>
                        </tr>
                    </tbody>
                </table>
                `;

                // Generar resumen ejecutivo
                const resumenHTML = `
                    <div style="margin-top: 30px; padding: 20px; background: #e3f2fd; border-radius: 8px; border-left: 5px solid #2196f3;">
                        <h3 style="color: #1565c0; margin-bottom: 15px;">üìã RESUMEN EJECUTIVO</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <p><strong>Costo Directo Total:</strong> $${calculos.costoDirecto.toLocaleString('es-CO', {maximumFractionDigits: 0})} COP</p>
                                <p><strong>AIU (33%):</strong> $${calculos.aiu.toLocaleString('es-CO', {maximumFractionDigits: 0})} COP</p>
                                <p><strong>IVA Total:</strong> $${calculos.iva.toLocaleString('es-CO', {maximumFractionDigits: 0})} COP</p>
                            </div>
                            <div>
                                <p><strong>TOTAL PROYECTO (COP):</strong> $${calculos.total.toLocaleString('es-CO', {maximumFractionDigits: 0})} COP</p>
                                <p><strong>TOTAL PROYECTO (USD):</strong> $${(calculos.total/TRM).toLocaleString('en-US', {maximumFractionDigits: 0})} USD</p>
                                <p><strong>TRM:</strong> 4,400 COP/USD</p>
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px; padding: 15px; background: #d4edda; border-radius: 6px; border-left: 5px solid #28a745;">
                            <h4 style="color: #155724; margin-bottom: 10px;">‚úÖ CAMBIOS T√âCNICOS RECIENTES (Sesi√≥n 8-Oct-2025)</h4>
                            <p style="color: #155724; margin: 5px 0;"><strong>DT-SCADA-001:</strong> Servidores SCADA +$400M</p>
                            <p style="color: #155724; margin: 5px 0;"><strong>DT-SCADA-002:</strong> Software SCADA +$4,500M</p>
                            <p style="color: #155724; margin: 5px 0;"><strong>DT-SCADA-003:</strong> Interfaces L2/L3 +$3,912M</p>
                            <p style="color: #155724; margin: 5px 0;"><strong>DT-CTC-002:</strong> Software CTC Virtual +$8,000M</p>
                        </div>
                    </div>
                `;

                // Crear ventana de impresi√≥n
                const ventana = window.open('', '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
                ventana.document.write(`
                    <html>
                    <head>
                        <title>WBS Presupuesto SCC - APP La Dorada-Chiriguan√° v2.0</title>
                        <meta charset="UTF-8">
                        <style>
                            @media print {
                                body { margin: 0; }
                                .no-print { display: none !important; }
                                .page-break { page-break-before: always; }
                            }
                            body { 
                                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
                                margin: 0; 
                                padding: 20px; 
                                background: white;
                                font-size: 12px;
                                line-height: 1.4;
                            }
                            .header {
                                text-align: center;
                                margin-bottom: 30px;
                                padding: 20px;
                                background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
                                color: white;
                                border-radius: 10px;
                            }
                            .header h1 {
                                margin: 0 0 10px 0;
                                font-size: 24px;
                            }
                            .header p {
                                margin: 0;
                                font-size: 14px;
                                opacity: 0.9;
                            }
                            .correccion-nota {
                                background: #fff3cd;
                                border: 2px solid #ffc107;
                                border-radius: 8px;
                                padding: 15px;
                                margin: 20px 0;
                                text-align: center;
                            }
                            .correccion-nota h3 {
                                color: #856404;
                                margin: 0 0 10px 0;
                            }
                            .correccion-nota p {
                                color: #856404;
                                margin: 5px 0;
                                font-weight: bold;
                            }
                            table { 
                                border-collapse: collapse; 
                                width: 100%; 
                                margin-bottom: 20px;
                                font-size: 10px;
                            }
                            th, td { 
                                border: 1px solid #ddd; 
                                padding: 6px; 
                                text-align: left; 
                                vertical-align: top;
                            }
                            th { 
                                background-color: #343a40; 
                                color: white;
                                font-weight: bold;
                                text-align: center;
                            }
                            .print-btn {
                                position: fixed;
                                top: 20px;
                                right: 20px;
                                background: #007bff;
                                color: white;
                                border: none;
                                padding: 10px 20px;
                                border-radius: 5px;
                                cursor: pointer;
                                font-size: 14px;
                                z-index: 1000;
                            }
                            .print-btn:hover {
                                background: #0056b3;
                            }
                        </style>
                    </head>
                    <body>
                        <button class="print-btn no-print" onclick="window.print()">üñ®Ô∏è Imprimir PDF</button>
                        
                        <div class="header">
                            <h1>WBS PRESUPUESTO SCC</h1>
                            <p>APP La Dorada-Chiriguan√° | UF-2.2 | Versi√≥n 2.9 (Actualizada)</p>
                        </div>
                        
                        <div class="correccion-nota" style="background: #d4edda; border-color: #c3e6cb;">
                            <h3 style="color: #155724;">‚úÖ WBS ACTUALIZADA - CAMBIOS T√âCNICOS</h3>
                            <p style="color: #155724;">Cap√≠tulo 5 (CCO): +$8,812M</p>
                            <p style="color: #155724;">Cap√≠tulo 1 (CTC): +$8,000M</p>
                            <p style="color: #155724;">Fecha: 8 de Octubre 2025</p>
                        </div>
                        
                        ${tablaHTML}
                        
                        ${resumenHTML}
                        
                        <div style="margin-top: 40px; padding: 20px; text-align: center; font-size: 10px; color: #666;">
                            <p><em>Documento generado autom√°ticamente el ${new Date().toLocaleString('es-CO')}</em></p>
                            <p><em>WBS actualizada v2.9 - Incluye cambios t√©cnicos recientes</em></p>
                        </div>
                    </body>
                    </html>
                `);
                ventana.document.close();
                
                // Auto-focus en la ventana
                ventana.focus();
                
            } catch (error) {
                console.error('Error al generar PDF:', error);
                alert('‚ùå Error al generar el PDF. Verifique la consola para m√°s detalles.');
            }
        }

        // Inicializar la tabla al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            renderTable();
            actualizarEstadisticas();
            
            // Validar c√°lculos despu√©s de cargar
            setTimeout(() => {
                validarCalculos();
            }, 1000);
        });
    </script>
</body>
</html>
