<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema WBS - APP La Dorada-ChiriguanÃ¡ | Acceso Seguro</title>
    
    <!-- Estilos externos (Mejora de mantenibilidad - 12-Oct-2025) -->
    <link rel="stylesheet" href="assets/css/portal-login.css?v=20251012">
</head>
<body>
    <!-- LOGIN FORM -->
    <div class="login-container" id="loginContainer">
        <div class="logo">
            <h1>ğŸš‚ Sistema WBS</h1>
            <p>APP La Dorada-ChiriguanÃ¡</p>
            <span class="project-badge">v14.7 | Acceso Seguro</span>
        </div>

        <form id="loginForm" onsubmit="return handleLogin(event)">
            <div class="form-group">
                <label for="username">ğŸ‘¤ Usuario</label>
                <input 
                    type="text" 
                    id="username" 
                    placeholder="Ingrese su usuario"
                    autocomplete="username"
                    required
                >
            </div>

            <div class="form-group">
                <label for="password">ğŸ”’ ContraseÃ±a</label>
                <input 
                    type="password" 
                    id="password" 
                    placeholder="Ingrese su contraseÃ±a"
                    autocomplete="current-password"
                    required
                >
            </div>

            <button type="submit" class="btn-login">
                Acceder al Sistema
            </button>

            <div class="spinner" id="spinner"></div>
            <div class="error-message" id="errorMessage">
                âŒ Usuario o contraseÃ±a incorrectos
            </div>
        </form>

        <div class="info-box">
            <h3>ğŸ“‹ InformaciÃ³n del Sistema</h3>
            <p>
                Sistema WBS Interactivo con gestiÃ³n dinÃ¡mica de riesgos, 
                decisiones tÃ©cnicas y sincronizaciÃ³n automÃ¡tica.
            </p>
            <p style="margin-top: 10px; font-size: 12px; color: #999;">
                â„¹ï¸ Para obtener credenciales, contactar a PMO del proyecto.
            </p>
        </div>

        <div class="version">
            Sistema v14.7 | Octubre 2025 | <a href="MEJORAS_PROPUESTAS.md" style="color: #667eea;">Mejoras de Seguridad</a>
        </div>
    </div>

    <!-- PORTAL PRINCIPAL (despuÃ©s del login) -->
    <div class="portal-container" id="portalContainer">
        <div class="portal-header">
            <h1>ğŸ¯ Portal Sistema WBS</h1>
            <p>Bienvenido al Sistema de GestiÃ³n EPC Integral</p>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value">181</div>
                <div class="stat-label">ğŸ“„ Documentos</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">6</div>
                <div class="stat-label">ğŸ¯ Interfaces</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">17</div>
                <div class="stat-label">âš ï¸ Riesgos</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">$307B</div>
                <div class="stat-label">ğŸ’° Presupuesto</div>
            </div>
        </div>

        <div class="portal-grid">
            <a href="IX. WBS y Planificacion/WBS_Menu_Principal.html" class="portal-card">
                <span class="icon">ğŸ›ï¸</span>
                <h3>Portal WBS Principal</h3>
                <p>Acceso a las 6 interfaces dinÃ¡micas del sistema</p>
            </a>

            <a href="help.html" class="portal-card">
                <span class="icon">ğŸ“š</span>
                <h3>Centro de Ayuda</h3>
                <p>Manuales, guÃ­as de DTs y documentaciÃ³n completa</p>
            </a>

            <a href="IX. WBS y Planificacion/WBS_Analisis_Riesgos.html" class="portal-card">
                <span class="icon">âš ï¸</span>
                <h3>AnÃ¡lisis de Riesgos</h3>
                <p>17 riesgos con planes de acciÃ³n</p>
            </a>

            <a href="IX. WBS y Planificacion/WBS_Reporte_Gerencial.html" class="portal-card">
                <span class="icon">ğŸ“Š</span>
                <h3>Reporte Gerencial</h3>
                <p>Pareto 80/20 y Ruta CrÃ­tica</p>
            </a>

            <a href="IX. WBS y Planificacion/WBS_Cronograma_Propuesta.html" class="portal-card">
                <span class="icon">ğŸ“…</span>
                <h3>Cronograma</h3>
                <p>PlanificaciÃ³n 60 meses</p>
            </a>

            <a href="X_ENTREGABLES_CONSOLIDADOS/8_DOCUMENTOS_SERVIDOS/HTML/GESTION_EJECUTIVO_Cambios_y_Decisiones_Tecnicas.html" class="portal-card">
                <span class="icon">ğŸ“„</span>
                <h3>Documentos Servidos</h3>
                <p>Entregables Word/HTML</p>
            </a>
        </div>

        <button class="btn-logout" onclick="handleLogout()">
            ğŸšª Cerrar SesiÃ³n
        </button>

        <div class="version">
            Sistema v14.7 | SesiÃ³n iniciada | <span id="userDisplay"></span>
        </div>
    </div>

    <script>
        // ================================================================
        // CONFIGURACIÃ“N DE AUTENTICACIÃ“N
        // ================================================================
        // NOTA: En producciÃ³n, las credenciales deben estar en backend
        // Ver: CREDENCIALES_PORTAL.md (confidencial, no en git)
        // Ver: VARIABLES_ENTORNO_PORTAL.md (documentaciÃ³n)
        
        const VALID_USER = '0rt1z';
        const VALID_PASSWORD = '0rt1z';

        // LÃ­mite de intentos de login (Mejora de seguridad - 12-Oct-2025)
        let intentosLogin = 0;
        const MAX_INTENTOS = 5;
        const TIMEOUT_BLOQUEO = 300000; // 5 minutos

        // Timeout de sesiÃ³n (Mejora de seguridad - 12-Oct-2025)
        const TIMEOUT_SESION = 1800000; // 30 minutos
        let ultimaActividad = Date.now();

        // ================================================================
        // VERIFICAR SESIÃ“N EXISTENTE
        // ================================================================
        window.addEventListener('DOMContentLoaded', function() {
            const isAuthenticated = sessionStorage.getItem('authenticated') === 'true';
            const username = sessionStorage.getItem('username');
            
            if (isAuthenticated && username) {
                showPortal(username);
                iniciarMonitoreoSesion();
            }
        });

        // ================================================================
        // MANEJO DE LOGIN
        // ================================================================
        function handleLogin(event) {
            event.preventDefault();
            
            // Verificar lÃ­mite de intentos
            if (intentosLogin >= MAX_INTENTOS) {
                alert('âš ï¸ Demasiados intentos fallidos. Por favor, espera 5 minutos.');
                return false;
            }
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorMessage = document.getElementById('errorMessage');
            const spinner = document.getElementById('spinner');
            
            // Ocultar error previo
            errorMessage.classList.remove('show');
            
            // Mostrar spinner
            spinner.classList.add('show');
            
            // Simular validaciÃ³n (300ms delay para UX)
            setTimeout(() => {
                spinner.classList.remove('show');
                
                if (username === VALID_USER && password === VALID_PASSWORD) {
                    // Login exitoso
                    intentosLogin = 0; // Resetear contador
                    sessionStorage.setItem('authenticated', 'true');
                    sessionStorage.setItem('username', username);
                    showPortal(username);
                    iniciarMonitoreoSesion();
                } else {
                    // Login fallido
                    intentosLogin++;
                    errorMessage.textContent = `âŒ Usuario o contraseÃ±a incorrectos (${intentosLogin}/${MAX_INTENTOS})`;
                    errorMessage.classList.add('show');
                    document.getElementById('password').value = '';
                    document.getElementById('password').focus();
                    
                    // Bloquear tras MAX_INTENTOS
                    if (intentosLogin >= MAX_INTENTOS) {
                        errorMessage.textContent = 'ğŸ”’ Demasiados intentos. Bloqueado por 5 minutos.';
                        setTimeout(() => {
                            intentosLogin = 0;
                            errorMessage.classList.remove('show');
                        }, TIMEOUT_BLOQUEO);
                    }
                }
            }, 300);
            
            return false;
        }

        // ================================================================
        // MOSTRAR PORTAL
        // ================================================================
        function showPortal(username) {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('portalContainer').classList.add('show');
            document.getElementById('userDisplay').textContent = username;
        }

        // ================================================================
        // MANEJO DE LOGOUT
        // ================================================================
        function handleLogout() {
            if (confirm('Â¿Seguro que deseas cerrar sesiÃ³n?')) {
                sessionStorage.removeItem('authenticated');
                sessionStorage.removeItem('username');
                location.reload();
            }
        }

        // ================================================================
        // MONITOREO DE SESIÃ“N (Mejora de seguridad - 12-Oct-2025)
        // ================================================================
        function iniciarMonitoreoSesion() {
            // Actualizar Ãºltima actividad en cada interacciÃ³n
            document.addEventListener('click', () => ultimaActividad = Date.now());
            document.addEventListener('keypress', () => ultimaActividad = Date.now());
            
            // Verificar timeout cada minuto
            setInterval(() => {
                if (Date.now() - ultimaActividad > TIMEOUT_SESION) {
                    alert('â±ï¸ Tu sesiÃ³n ha expirado por inactividad.');
                    handleLogout();
                }
            }, 60000); // Verificar cada minuto
        }

        // ================================================================
        // PROTECCIÃ“N CONTRA ACCESO NO AUTORIZADO
        // ================================================================
        window.addEventListener('popstate', function() {
            const isAuthenticated = sessionStorage.getItem('authenticated') === 'true';
            if (!isAuthenticated) {
                location.reload();
            }
        });
    </script>
</body>
</html>
