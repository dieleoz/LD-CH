# REGLAS DE CURSOR PARA SISTEMA WBS INTERACTIVO
# Proyecto: APP La Dorada-Chiriguan√°
# Versi√≥n: 2.0 | Fecha: 8 de Octubre de 2025

## üéØ CONTEXTO DEL PROYECTO

Este es un proyecto de ingenier√≠a EPC (Engineering, Procurement, Construction) para una concesi√≥n ferroviaria.
El sistema WBS Interactivo permite a especialistas proponer cambios t√©cnicos que se documentan como Decisiones T√©cnicas (DT)
y se ejecutan autom√°ticamente mediante Cursor siguiendo instrucciones YAML embebidas.

**IMPORTANTE:** Las DTs deben propagar cambios en **6 NIVELES** de documentaci√≥n para mantener coherencia t√©cnica completa.

---

## üîÑ FLUJO DE PROPAGACI√ìN (6 NIVELES)

### **NIVEL 1: IX. WBS Y PLANIFICACI√ìN** ‚úÖ OBLIGATORIO
```
‚îú‚îÄ WBS_Presupuestal_v2.0.md (cantidades, VU, totales)
‚îú‚îÄ datos_wbs_TODOS_items.json (datos completos)
‚îú‚îÄ wbs_metadata_enriquecida.json (metadata t√©cnica)
‚îî‚îÄ Interfaces HTML (visualizaci√≥n)
```

### **NIVEL 2: V. INGENIER√çA DE DETALLE** ‚ö†Ô∏è CONDICIONAL
```
‚îî‚îÄ V.X_Sistema_Detalle_vX.md (secci√≥n t√©cnica espec√≠fica)
    Ejemplo: DT-CTC-002 ‚Üí V.2 CTC ¬ß3.2 "Arquitectura"
    
    Script autom√°tico: scripts/actualizar_documentos_detalle.ps1
    - Busca archivos V.X mencionados en DTs
    - Versiona autom√°ticamente (v5.0 ‚Üí v5.1)
    - Agrega historial de actualizaciones con ID de DT
    - Trazabilidad completa DT ‚Üí V.X
```

### **NIVEL 3: III. INGENIER√çA CONCEPTUAL** ‚ö†Ô∏è SI APLICA
```
‚îî‚îÄ Documentos Integrados (criterios/cantidades)
    Ejemplo: 26_Sistema_CTC_Integrado.md
```

### **NIVEL 4: VIII. DOCUMENTOS MAESTROS** ‚úÖ OBLIGATORIO
```
‚îú‚îÄ CRITERIOS_TECNICOS_MAESTRO_v1.0.md (agrega criterio)
‚îú‚îÄ MATRIZ_TRAZABILIDAD_TECNICA_v1.0.md (enlaza DT ‚Üí Docs)
‚îú‚îÄ MATRIZ_DEPENDENCIAS_DOCUMENTALES_v1.0.md (agrega fila)
‚îî‚îÄ MATRIZ_RIESGOS_PMO_AMPLIADA_v1.0.md (si aplica riesgo)

Script autom√°tico: scripts/actualizar_documentos_maestros.ps1
- Extrae metadata de DTs (Sistema, Item WBS, Tipo cambio)
- Inserta filas en MATRIZ_DEPENDENCIAS_DOCUMENTALES
- Agrega entradas a MATRIZ_TRAZABILIDAD_TECNICA
- Verifica duplicados antes de insertar
- 18 DTs ya registradas en matrices
```

### **NIVEL 5: X. ENTREGABLES CONSOLIDADOS** ‚ö†Ô∏è SI EXISTE
```
‚îî‚îÄ SISTEMA_XX_Master.md (actualiza si ya consolidado)
```

### **NIVEL 6: √çNDICES** ‚úÖ OBLIGATORIO
```
‚îî‚îÄ Indice_Maestro_Consolidado_v1.0.md (referencias cruzadas)
```

**NOTA:** Niveles ‚úÖ OBLIGATORIOS siempre se actualizan. Niveles ‚ö†Ô∏è CONDICIONALES solo si aplica seg√∫n MATRIZ_DEPENDENCIAS.

---

## üìã EJECUCI√ìN DE DECISIONES T√âCNICAS (DT)

### DETECCI√ìN AUTOM√ÅTICA

Cuando el usuario abre o menciona un archivo `DT-*.md` ubicado en `II. Apendices Tecnicos/Decisiones_Tecnicas/`:

1. **Reconocer como Decisi√≥n T√©cnica**
   - Archivos con patr√≥n: `DT-[SISTEMA]-[NUMERO]-[FECHA].md`
   - Ejemplos: `DT-FIBRA-042-2025-10-07.md`, `DT-TETRA-015-2025-10-08.md`

2. **Buscar secci√≥n de instrucciones**
   - Secci√≥n: `## 10. INSTRUCCIONES PARA CURSOR ‚öôÔ∏è`
   - Contiene bloque YAML entre ` ```yaml ` y ` ``` `

3. **Ofrecer ejecuci√≥n**
   - Preguntar al usuario: "He detectado una Decisi√≥n T√©cnica. ¬øQuieres que la ejecute?"
   - Si usuario dice "S√≠", "Ejecuta", "Procede" o similar ‚Üí Iniciar ejecuci√≥n

---

### PROCESO DE EJECUCI√ìN

#### **PASO 1: LEER Y PARSEAR YAML**

```markdown
1. Extraer el bloque YAML de la secci√≥n 10
2. Parsear estructura completa
3. Identificar:
   - dt_metadata (metadatos)
   - archivos_actualizar (lista de archivos y cambios)
   - items_dependientes (si aplica)
   - validaciones (checks pre-ejecuci√≥n)
   - manejo_errores (estrategias)
```

#### **PASO 2: VALIDACIONES PRE-EJECUCI√ìN**

Seg√∫n el campo `validaciones` en YAML:

```yaml
validaciones:
  - verificar_archivos_existen: true
  - backup_antes_modificar: true
  - validar_formato_numeros: true
  - confirmar_con_usuario: true
```

**Ejecutar validaciones:**
- ‚úÖ `verificar_archivos_existen`: Confirmar que todos los archivos en `archivos_actualizar` existen
- ‚úÖ `backup_antes_modificar`: Crear backup mental de contenido original (para poder revertir)
- ‚úÖ `validar_formato_numeros`: Verificar que n√∫meros son parseables
- ‚úÖ `confirmar_con_usuario`: Mostrar resumen y pedir confirmaci√≥n

#### **PASO 3: MOSTRAR RESUMEN Y CONFIRMAR**

Mostrar al usuario:

```
üìã DECISI√ìN T√âCNICA: [DT-ID]
√çtem WBS: [codigo]
Tipo de cambio: [tipo]

Archivos a actualizar ([N]):
‚úì [archivo1] ‚Üí [acci√≥n]
‚úì [archivo2] ‚Üí [acci√≥n]
‚úì ...

√çtems dependientes a recalcular ([N]):
- [item1]
- [item2]

Validaciones:
‚úì Todos los archivos existen
‚úì Backup creado
‚úì Formato de n√∫meros validado

¬øEjecutar cambios? (S√≠/No)
```

Si usuario dice "S√≠" ‚Üí Continuar al Paso 4
Si usuario dice "No" ‚Üí Cancelar y reportar

#### **PASO 4: EJECUTAR CAMBIOS**

Para cada elemento en `archivos_actualizar`:

```yaml
- file: "ruta/archivo.md"
  accion: "actualizar_y_versionar"
  seccion: "Item 1.1.3"
  cambios:
    - campo: "cantidad"
      buscar: "2068"
      reemplazar: "1697"
```

**Proceso por archivo:**

1. **Abrir archivo** (usar herramienta `read_file`)

2. **Buscar secci√≥n** especificada en `seccion`
   - Si no se encuentra ‚Üí Seguir estrategia en `manejo_errores.seccion_no_encontrada`

3. **Aplicar cambios** seg√∫n array `cambios`:
   - Para cada cambio:
     - Buscar valor en `buscar`
     - Reemplazar con valor en `reemplazar`
     - Si `validar_contexto: true` ‚Üí Verificar que sea el contexto correcto antes de reemplazar

4. **Versionamiento** (si aplica):
   ```yaml
   versionamiento:
     version_actual: "v3.0"
     version_nueva: "v3.1"
     razon: "DT-FIBRA-042 - cantidad"
     agregar_nota: "Origen: DT-FIBRA-042 | Fecha: 2025-10-07"
   ```
   - Actualizar versi√≥n en header del archivo
   - Agregar nota de origen al final o en secci√≥n de cambios

5. **Guardar archivo** (usar herramienta `search_replace` o `write`)

6. **Notificar progreso**:
   ```
   ‚úì [archivo] actualizado ([N] cambios aplicados)
   ```

#### **PASO 5: RECALCULAR √çTEMS DEPENDIENTES**

Si `items_dependientes.recalcular: true`:

```yaml
items_dependientes:
  recalcular: true
  items:
    - "1.1.5"
    - "1.1.10"
  formula_base: "proporcional_a_item_principal"
```

**Para cada √≠tem dependiente:**
1. Identificar en WBS
2. Aplicar f√≥rmula seg√∫n `formula_base`
   - `proporcional_a_item_principal`: Ajustar proporcionalmente al cambio del √≠tem principal
   - `fixed_percentage`: Usar porcentaje fijo
3. Actualizar valores en archivo WBS
4. Reportar cambios

#### **PASO 6: ACTUALIZAR MATRIZ DE DEPENDENCIAS**

Si hay entrada para actualizar `MATRIZ_DEPENDENCIAS_DOCUMENTALES`:

```yaml
- file: "VIII.../MATRIZ_DEPENDENCIAS_DOCUMENTALES_v1.0.md"
  accion: "agregar_fila"
  nueva_fila:
    sistema: "fibra"
    decision_tecnica: "DT-FIBRA-042"
    archivos_afectados: "WBS_Presupuestal, 2 archivos"
    tipo_impacto: "Cantidades"
```

**Proceso:**
1. Abrir archivo de matriz
2. Buscar tabla principal
3. Agregar nueva fila con formato Markdown:
   ```markdown
   | fibra | DT-FIBRA-042 | WBS_Presupuestal, 2 archivos | Cantidades |
   ```
4. Guardar archivo

#### **PASO 7: ACTUALIZAR DT CON LOG DE EJECUCI√ìN**

En el archivo DT original:

1. **Marcar checkbox de "Ejecutado"** en secci√≥n 11:
   ```markdown
   - [x] üîß Ejecutado por Cursor: [fecha-hora]
   ```

2. **Completar secci√≥n 12 "LOG DE EJECUCI√ìN"**:
   ```markdown
   ## 12. LOG DE EJECUCI√ìN

   ```
   Fecha ejecuci√≥n: 2025-10-07 15:45:30
   Usuario Cursor: [tu nombre]
   Archivos modificados: 3 (WBS_Presupuestal_v3.1.md, V.3_Comunicacion.md, MATRIZ_DEPENDENCIAS.md)
   √çtems recalculados: 2 (1.1.5, 1.1.10)
   Errores encontrados: 0
   Tiempo ejecuci√≥n: 12 segundos
   ```
   ```

#### **PASO 8: REPORTE FINAL**

Mostrar al usuario:

```
‚úÖ DT-[ID] EJECUTADA EXITOSAMENTE

üìä RESUMEN:
- Archivos actualizados: [N]
  ‚úì WBS_Presupuestal v3.0 ‚Üí v3.1 (2 cambios)
  ‚úì V.3_Sistemas_Comunicacion_Detalle.md (1 cambio)
  ‚úì MATRIZ_DEPENDENCIAS_DOCUMENTALES (nueva fila)

- √çtems dependientes recalculados: [N]
  ‚úì 1.1.5 - Uniones r√°pidas
  ‚úì 1.1.10 - Insumos fusionado

- Matrices actualizadas:
  ‚úì MATRIZ_DEPENDENCIAS_DOCUMENTALES

- Log completado en: DT-[ID].md (Secci√≥n 12)

üéâ Todos los cambios aplicados correctamente.
```

---

### MANEJO DE ERRORES

Seg√∫n el campo `manejo_errores` en YAML:

```yaml
manejo_errores:
  - archivo_no_existe: "reportar_y_continuar"
  - seccion_no_encontrada: "pedir_confirmacion_manual"
  - validacion_falla: "detener_y_reportar"
  - backup_falla: "detener_ejecucion"
```

**Estrategias:**

1. **`reportar_y_continuar`**
   - Reportar error al usuario
   - Continuar con siguiente archivo
   - Ejemplo: "‚ö†Ô∏è Archivo X no encontrado. Continuando con siguiente..."

2. **`pedir_confirmacion_manual`**
   - Reportar situaci√≥n al usuario
   - Pedir confirmaci√≥n antes de continuar
   - Ejemplo: "‚ö†Ô∏è Secci√≥n Y no encontrada en archivo X. ¬øBuscar manualmente? (S√≠/No)"

3. **`detener_y_reportar`**
   - Detener ejecuci√≥n inmediatamente
   - Reportar error detallado
   - No aplicar m√°s cambios
   - Ejemplo: "‚ùå Validaci√≥n fall√≥: [raz√≥n]. Ejecuci√≥n detenida. No se aplicaron cambios."

4. **`detener_ejecucion`**
   - Detener sin preguntar
   - Revertir cambios si es posible
   - Reportar estado

---

## üîç COMANDOS ESPECIALES

### Cuando usuario escribe:

- **"Ejecuta DT-[ID]"** o **"Ejecuta esta DT"**
  ‚Üí Buscar archivo DT con ese ID y ejecutarlo

- **"Simula DT-[ID]"** o **"Modo dry-run"**
  ‚Üí Hacer toda la lectura y an√°lisis pero NO aplicar cambios
  ‚Üí Reportar qu√© se har√≠a

- **"Valida DT-[ID]"**
  ‚Üí Solo ejecutar validaciones (Paso 2)
  ‚Üí Reportar si es ejecutable

- **"Revierte DT-[ID]"**
  ‚Üí Si hay backup, revertir cambios
  ‚Üí Marcar DT como "Revertida"

---

## üìù FORMATO DE ARCHIVOS

### WBS Presupuestal
- Formato: Markdown con tablas
- Versionamiento: vX.Y en header
- √çtems con formato: `## [codigo] - [descripcion]`

### Documentos T√©cnicos
- Formatos: Markdown (.md)
- Secciones numeradas
- Referencias cruzadas con formato: `[doc] (Secci√≥n X.Y)`

### Matrices
- Tablas Markdown
- Headers fijos
- Nueva fila al final de tabla

---

## ‚öôÔ∏è CONFIGURACI√ìN DE COMPORTAMIENTO

### Siempre:
- ‚úÖ Pedir confirmaci√≥n antes de modificar archivos
- ‚úÖ Crear backup mental del contenido original
- ‚úÖ Reportar cada cambio aplicado
- ‚úÖ Actualizar log en DT
- ‚úÖ Ser expl√≠cito sobre qu√© se est√° haciendo

### Nunca:
- ‚ùå Modificar archivos sin confirmaci√≥n
- ‚ùå Omitir validaciones
- ‚ùå Ejecutar sin parsear YAML completo
- ‚ùå Aplicar cambios si validaci√≥n falla
- ‚ùå Modificar archivos fuera de los especificados en YAML

---

## üéØ PRIORIDADES

1. **SEGURIDAD**: No aplicar cambios sin confirmaci√≥n
2. **TRAZABILIDAD**: Documentar todo en log
3. **INTEGRIDAD**: Validar antes de ejecutar
4. **CLARIDAD**: Reportar qu√© se est√° haciendo
5. **REVERSIBILIDAD**: Mantener forma de revertir

---

## üìö EJEMPLOS

### Ejemplo 1: Usuario abre DT-FIBRA-042-2025-10-07.md

```
CURSOR:
üìã He detectado una Decisi√≥n T√©cnica: DT-FIBRA-042

√çtem WBS: 1.1.3 - Cajas de empalme
Tipo de cambio: Ajuste de cantidad
Archivos a actualizar: 3
√çtems dependientes: 2

¬øQuieres que ejecute esta DT? (S√≠/No)

USUARIO:
S√≠

CURSOR:
‚úÖ Validaciones completadas
- Todos los archivos existen
- Backup creado
- Formato validado

Iniciando ejecuci√≥n...

‚úì WBS_Presupuestal_v3.0.md ‚Üí v3.1 (2 cambios)
‚úì V.3_Comunicacion.md (1 cambio)
‚úì MATRIZ_DEPENDENCIAS.md (nueva fila)
‚úì Recalculado: 1.1.5, 1.1.10

‚úÖ DT-FIBRA-042 ejecutada exitosamente
Log completado en DT-FIBRA-042-2025-10-07.md
```

### Ejemplo 2: Usuario pide simulaci√≥n

```
USUARIO:
Simula DT-TETRA-015

CURSOR:
üîç SIMULACI√ìN DT-TETRA-015 (Dry-run mode)

Archivos que se modificar√≠an (2):
- WBS_Presupuestal_v4.0.md
  ‚Üí Cambio: cantidad "37" ‚Üí "42" en item 2.1.100
  ‚Üí Versi√≥n: v4.0 ‚Üí v4.1

- III/29_Sistema_TETRA.md
  ‚Üí Cambio: "37 estaciones" ‚Üí "42 estaciones" en Secci√≥n 3.1

√çtems que se recalcular√≠an (1):
- 2.1.101: Antenas (proporcional)

Matrices que se actualizar√≠an:
- MATRIZ_DEPENDENCIAS: Nueva fila

‚úì Simulaci√≥n completa. No se aplicaron cambios.
```

---

**√öltima actualizaci√≥n:** 7 de Octubre de 2025  
**Versi√≥n:** 1.0  
**Compatibilidad:** WBS Interactiva v3.0+  

